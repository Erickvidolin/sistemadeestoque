<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StockFlow — Gestão de Estoque</title>
<link rel="icon" type="image/png" href="stockflow.ico">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<!-- Firebase SDK -->
<script type="module">
// ============================================================
// FIREBASE CONFIG — substitua pelos seus dados do console
// ============================================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged,
         createUserWithEmailAndPassword }
  from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs,
         writeBatch, deleteDoc, onSnapshot, where, query }
  from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAaMhA8z5WuK2mucx92Z2TNdyNzvQciD1c",
  authDomain: "estoquereq.firebaseapp.com",
  projectId: "estoquereq",
  storageBucket: "estoquereq.firebasestorage.app",
  messagingSenderId: "674745725403",
  appId: "1:674745725403:web:dfda1ea2b81573af4df7fe"
};

// ============================================================
// ADMIN PADRÃO — criado automaticamente no primeiro boot
// Altere antes de subir para produção!
// ============================================================
const DEFAULT_ADMIN = {
  email: "producao.ibeg@ibeg.ind.br",
  senha: "producao@2026",
  nome:  "Administrador"
};

// ============================================================
// COLEÇÕES DO SISTEMA — criadas automaticamente no primeiro boot
// ============================================================
const COLECOES = ['estoques','materiais','itens','entradas','saidas',
                  'transferencias','requisicoes','notificacoes'];

const firebaseApp = initializeApp(firebaseConfig);
const auth        = getAuth(firebaseApp);
const firestore   = getFirestore(firebaseApp);

// Expor globalmente para o código legado
window._firebase = { auth, firestore, signInWithEmailAndPassword, signOut,
  onAuthStateChanged, createUserWithEmailAndPassword,
  doc, getDoc, setDoc, collection, getDocs, writeBatch, deleteDoc,
  onSnapshot, where, query };

// Salva referência direta do onSnapshot para o sistema de notificações
window._fsOnSnapshot = onSnapshot;

// ============================================================
// BOOT — inicialização automática no primeiro acesso
// ============================================================
async function bootSistema() {
  const bootRef  = doc(firestore, 'config', 'boot');
  const bootSnap = await getDoc(bootRef);

  if (bootSnap.exists() && bootSnap.data().initialized) {
    return; // sistema já inicializado, nada a fazer
  }

  console.log('[StockFlow] Primeiro boot — inicializando sistema...');
  window._showBootMessage('Primeiro acesso detectado. Criando estrutura do banco...');

  try {
    // 1. Criar usuário admin no Firebase Auth
    let adminUid;
    try {
      const cred = await createUserWithEmailAndPassword(auth, DEFAULT_ADMIN.email, DEFAULT_ADMIN.senha);
      adminUid = cred.user.uid;
      // Faz sign out para não pular a tela de login
      await signOut(auth);
    } catch(e) {
      if (e.code === 'auth/email-already-in-use') {
        // Admin já existe no Auth mas o Firestore ainda não foi configurado
        // Tenta logar para pegar o UID
        try {
          const cred = await signInWithEmailAndPassword(auth, DEFAULT_ADMIN.email, DEFAULT_ADMIN.senha);
          adminUid = cred.user.uid;
          await signOut(auth);
        } catch(_) {
          console.warn('[StockFlow] Admin Auth existe mas senha mudou. Configure manualmente.');
          return;
        }
      } else { throw e; }
    }

    // 2. Criar perfil do admin no Firestore /users/{uid}
    await setDoc(doc(firestore, 'users', adminUid), {
      nome:      DEFAULT_ADMIN.nome,
      email:     DEFAULT_ADMIN.email,
      role:      'adm',
      username:  DEFAULT_ADMIN.email,
      criadoEm:  new Date().toISOString(),
      criadoPor: 'sistema'
    });

    // 3. Criar placeholder em cada coleção para forçar sua existência
    //    (Firestore não tem coleções "vazias" — o placeholder é deletado logo depois)
    for (const col of COLECOES) {
      const placeholderRef = doc(firestore, 'stockflow', col, 'items', '_placeholder');
      await setDoc(placeholderRef, { _placeholder: true, _criadoEm: new Date().toISOString() });
      await deleteDoc(placeholderRef);
    }

    // 4. Marcar sistema como inicializado
    await setDoc(bootRef, {
      initialized: true,
      adminUid,
      adminEmail: DEFAULT_ADMIN.email,
      versao: '3.0',
      iniciadoEm: new Date().toISOString()
    });

    window._showBootMessage(
      '✅ Sistema inicializado!\n' +
      `Admin padrão: ${DEFAULT_ADMIN.email}\n` +
      `Senha: ${DEFAULT_ADMIN.senha}\n` +
      'Altere a senha após o primeiro login.',
      true
    );
    console.log('[StockFlow] Boot concluído!');

  } catch(err) {
    console.error('[StockFlow] Erro no boot:', err);
    window._showBootMessage('❌ Erro ao inicializar: ' + err.message, false, true);
  }
}

// Mensagem de boot na tela de login
window._showBootMessage = function(msg, success=false, error=false) {
  let el = document.getElementById('boot-msg');
  if (!el) {
    el = document.createElement('div');
    el.id = 'boot-msg';
    el.style.cssText = 'margin-top:14px;padding:12px 14px;border-radius:8px;font-size:12px;line-height:1.7;white-space:pre-line;text-align:left;';
    const box = document.querySelector('.auth-box');
    if (box) box.appendChild(el);
  }
  if (error) {
    el.style.background = 'rgba(255,59,92,.1)';
    el.style.color = '#ff3b5c';
    el.style.border = '1px solid rgba(255,59,92,.3)';
  } else if (success) {
    el.style.background = 'rgba(0,229,160,.1)';
    el.style.color = '#00e5a0';
    el.style.border = '1px solid rgba(0,229,160,.3)';
  } else {
    el.style.background = 'rgba(0,102,255,.08)';
    el.style.color = '#5599ff';
    el.style.border = '1px solid rgba(0,102,255,.2)';
  }
  el.textContent = msg;
};

// Roda o boot assim que o módulo carrega
bootSistema().catch(console.error);

// ============================================================
// OBSERVER DE AUTENTICAÇÃO
// ============================================================
onAuthStateChanged(auth, async (user) => {
  if (user) {
    try {
      const snap = await getDoc(doc(firestore, 'users', user.uid));
      if (snap.exists()) {
        const data = snap.data();
        window.currentUser = {
          id:       user.uid,
          uid:      user.uid,
          email:    user.email,
          nome:     data.nome || user.email,
          username: data.username || user.email,
          role:     data.role || 'user'
        };
        window._fbReady = true;
        // Remove mensagem de boot ao logar
        const bm = document.getElementById('boot-msg');
        if (bm) bm.remove();
        if (window._onAuthReady) window._onAuthReady(window.currentUser);
      } else {
        // Usuário existe no Auth mas não tem perfil — desloga
        await signOut(auth);
      }
    } catch(e) { console.error(e); }
  } else {
    window.currentUser = null;
    window._fbReady    = false;
    if (window._onAuthLogout) window._onAuthLogout();
  }
});
</script>
<style>
:root{--bg:#0a0c0f;--surface:#111318;--surface2:#1a1d24;--border:#252830;--accent:#00e5a0;--accent2:#0066ff;--warn:#ff9500;--danger:#ff3b5c;--text:#e8eaf0;--muted:#6b7280;}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;}
h1,h2,h3{font-family:'Syne',sans-serif;}

/* AUTH */
#auth-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);padding:16px;}
.auth-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;width:100%;max-width:400px;}
.auth-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:28px;text-align:center;margin-bottom:8px;}
.auth-logo span{color:var(--accent);}
.auth-sub{text-align:center;color:var(--muted);font-size:13px;margin-bottom:32px;}

/* APP LAYOUT */
#app{display:none;height:100vh;overflow:hidden;}
#app.logged{display:flex;}
#sidebar{width:240px;min-width:240px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;transition:transform .3s;z-index:50;}
.sidebar-logo{padding:20px;border-bottom:1px solid var(--border);font-family:'Syne',sans-serif;font-weight:800;font-size:20px;display:flex;align-items:center;justify-content:space-between;}
.sidebar-logo span{color:var(--accent);}
#main{flex:1;overflow-y:auto;background:var(--bg);}
.page{display:none;padding:28px;}
.page.active{display:block;}

/* NAV */
.nav-item{display:flex;align-items:center;gap:12px;padding:11px 20px;cursor:pointer;color:var(--muted);font-size:13px;font-weight:500;border-left:3px solid transparent;transition:all .2s;}
.nav-item:hover{color:var(--text);background:var(--surface2);}
.nav-item.active{color:var(--accent);border-left-color:var(--accent);background:rgba(0,229,160,0.06);}
.nav-icon{width:17px;height:17px;flex-shrink:0;}
.nav-sep{height:1px;background:var(--border);margin:6px 16px;}
.nav-label{padding:8px 20px 4px;font-family:'Syne',sans-serif;font-size:10px;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px 24px;position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;right:0;width:60px;height:60px;border-radius:0 12px 0 60px;opacity:.15;}
.stat-card.green::before{background:var(--accent);}
.stat-card.blue::before{background:var(--accent2);}
.stat-card.warn::before{background:var(--warn);}
.stat-card.danger::before{background:var(--danger);}

/* FORMS */
input,select,textarea{background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:10px 14px;font-size:14px;font-family:'DM Sans',sans-serif;width:100%;transition:border-color .2s;outline:none;}
input:focus,select:focus,textarea:focus{border-color:var(--accent);}
select option{background:var(--surface2);}
label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block;font-weight:500;}
.form-group{margin-bottom:16px;}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;}
.checkbox-wrap{display:flex;align-items:center;gap:10px;cursor:pointer;}
.checkbox-wrap input[type=checkbox],.checkbox-wrap input[type=radio]{width:16px;height:16px;accent-color:var(--accent);}

/* BUTTONS */
.btn{padding:10px 20px;border-radius:8px;font-size:14px;font-weight:600;font-family:'Syne',sans-serif;cursor:pointer;border:none;transition:all .2s;}
.btn-primary{background:var(--accent);color:#000;}
.btn-primary:hover{background:#00c98a;transform:translateY(-1px);}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border);}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent);}
.btn-danger{background:var(--danger);color:#fff;}
.btn-danger:hover{background:#e0334f;}
.btn-warn{background:var(--warn);color:#000;}

/* BADGES */
.badge{padding:3px 10px;border-radius:99px;font-size:11px;font-weight:700;font-family:'Syne',sans-serif;letter-spacing:.5px;white-space:nowrap;}
.badge-ok{background:rgba(0,229,160,.15);color:var(--accent);}
.badge-critical{background:rgba(255,59,92,.15);color:var(--danger);}
.badge-over{background:rgba(0,102,255,.15);color:#5599ff;}
.badge-noref{background:rgba(107,114,128,.15);color:var(--muted);}
.badge-warn{background:rgba(255,149,0,.15);color:var(--warn);}
.badge-pending{background:rgba(255,149,0,.15);color:var(--warn);}
.badge-attended{background:rgba(0,229,160,.15);color:var(--accent);}
.badge-denied{background:rgba(255,59,92,.15);color:var(--danger);}
.badge-waiting{background:rgba(0,102,255,.15);color:#5599ff;}

/* TABLE */
table{width:100%;border-collapse:collapse;font-size:13px;}
th{text-align:left;padding:10px 12px;color:var(--muted);font-size:11px;font-weight:700;font-family:'Syne',sans-serif;letter-spacing:.5px;border-bottom:1px solid var(--border);text-transform:uppercase;white-space:nowrap;}
td{padding:11px 12px;border-bottom:1px solid var(--border);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.02);}

/* MODAL */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;align-items:center;justify-content:center;padding:16px;}
.modal.open{display:flex;}
.modal-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;}
.modal-title{font-family:'Syne',sans-serif;font-weight:800;font-size:18px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;}
.modal-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:20px;line-height:1;padding:0;}

/* NOTIFICATIONS */
#notif-bell{position:relative;cursor:pointer;padding:8px;border-radius:8px;transition:background .2s;}
#notif-bell:hover{background:var(--surface2);}
#notif-badge{position:absolute;top:4px;right:4px;width:18px;height:18px;background:var(--danger);color:#fff;border-radius:99px;font-size:10px;font-weight:700;display:none;align-items:center;justify-content:center;font-family:'Syne',sans-serif;}
#notif-panel{display:none;position:fixed;top:56px;right:16px;width:340px;max-height:420px;overflow-y:auto;background:var(--surface);border:1px solid var(--border);border-radius:12px;z-index:300;box-shadow:0 8px 32px rgba(0,0,0,.5);}
.notif-item{padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;}
.notif-item:hover{background:var(--surface2);}
.notif-item.unread{border-left:3px solid var(--accent);}
.notif-item:last-child{border-bottom:none;}

/* USER BADGE */
#user-chip{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;font-size:13px;cursor:pointer;}
.user-avatar{width:28px;height:28px;border-radius:99px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:700;font-size:12px;}
.avatar-adm{background:rgba(0,229,160,.2);color:var(--accent);}
.avatar-user{background:rgba(0,102,255,.2);color:#5599ff;}

/* TOP BAR (mobile) */
#topbar{display:none;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:40;}
#menu-toggle{background:none;border:none;color:var(--text);cursor:pointer;padding:4px;}
#sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:45;}

/* REQUISITION CARD (mobile) */
.req-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;}
.req-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}

/* SECTION */
.section-title{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:4px;}
.section-sub{color:var(--muted);font-size:13px;margin-bottom:24px;}
.divider{height:1px;background:var(--border);margin:20px 0;}

/* TOAST */
#toast{position:fixed;bottom:24px;right:24px;background:var(--surface);border:1px solid var(--accent);border-radius:10px;padding:14px 20px;font-size:14px;color:var(--accent);z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;font-family:'Syne',sans-serif;font-weight:600;max-width:320px;}
#toast.show{transform:translateY(0);opacity:1;}
#toast.error{border-color:var(--danger);color:var(--danger);}

/* SCROLLBAR */
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-track{background:var(--surface);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

/* PURCHASE TABLE */
.purchase-urgent{background:rgba(255,59,92,.04);}
.purchase-soon{background:rgba(255,149,0,.04);}
/* Responsive layout helper */
.form-table-layout{display:grid;gap:24px;align-items:start;}

/* RESPONSIVE */
@media(max-width:768px){
  #app.logged{flex-direction:column;}
  #sidebar{position:fixed;top:0;left:0;height:100vh;transform:translateX(-100%);width:260px;}
  #sidebar.open{transform:translateX(0);}
  #sidebar-overlay.open{display:block;}
  #topbar{display:flex;}
  #main{padding-top:0;overflow-x:hidden;}
  .page{padding:12px;overflow-x:hidden;}
  .grid-2,.grid-3,.grid-4{grid-template-columns:1fr;}
  /* Tabelas: scroll horizontal em vez de display:none */
  .table-scroll-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;width:100%;}
  table{display:table;min-width:500px;font-size:12px;}
  th,td{padding:8px 10px;white-space:nowrap;}
  .mobile-cards{display:block;}
  .desktop-only{display:none;}
  .section-title{font-size:18px;}
  .req-layout{grid-template-columns:1fr !important;}
  .card{padding:14px;overflow-x:hidden;}
  .stat-card{padding:14px 16px;}
  .modal-box{padding:20px;margin:8px;width:calc(100vw - 16px);max-width:none;}
  select,input,textarea{font-size:16px !important;} /* prevent zoom on iOS */
  .btn{padding:11px 16px;font-size:13px;}
  #notif-panel{width:calc(100vw - 24px);right:12px;top:56px;}
  .section-sub{margin-bottom:14px;}
  #toast{bottom:16px;right:12px;left:12px;max-width:none;}
  /* Filtros do dashboard: empilhar em coluna */
  #page-dash .card > div:first-child{flex-wrap:wrap;gap:8px;}
  #page-dash .card > div:first-child input,
  #page-dash .card > div:first-child select{width:100%!important;}
  /* Grids fixos em px viram 1fr */
  .form-table-layout,
  [style*="grid-template-columns:380px"],
  [style*="grid-template-columns:420px"],
  [style*="grid-template-columns:460px"],
  [style*="grid-template-columns:1fr 1fr"]{
    grid-template-columns:1fr!important;
  }
}
@media(min-width:769px){
  .mobile-cards{display:none;}
  .table-scroll-wrap{overflow-x:auto;}
}

/* ── MOBILE DATA CARDS ── */
.data-cards { display: none; }
.data-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  margin-bottom: 10px;
}
.data-card-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 8px;
  gap: 8px;
}
.data-card-title { font-weight: 700; font-size: 14px; line-height: 1.3; }
.data-card-body { font-size: 12px; color: var(--muted); line-height: 1.9; }
.data-card-body strong { color: var(--text); }
.data-card-actions { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
.data-card-actions .btn { flex: 1; min-width: 60px; text-align: center; }

/* ── SEARCHABLE SELECT ── */
.sf-wrap { position: relative; width: 100%; }
.sf-input {
  width: 100%;
  padding: 10px 36px 10px 14px !important;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 8px;
  font-size: 14px;
  font-family: 'DM Sans', sans-serif;
  outline: none;
  cursor: text;
  transition: border-color .2s;
  box-sizing: border-box;
}
.sf-input:focus { border-color: var(--accent); }
.sf-arrow {
  position: absolute; right: 10px; top: 50%;
  transform: translateY(-50%);
  pointer-events: none; color: var(--muted); font-size: 10px;
}
.sf-dropdown {
  display: none; position: absolute;
  top: calc(100% + 4px); left: 0; right: 0;
  background: var(--surface2); border: 1px solid var(--accent);
  border-radius: 10px; max-height: 220px;
  overflow-y: auto; z-index: 500;
  box-shadow: 0 8px 24px rgba(0,0,0,.6);
}
.sf-dropdown.open { display: block; }
.sf-opt {
  padding: 10px 14px; cursor: pointer; font-size: 13px;
  border-bottom: 1px solid var(--border); transition: background .12s;
  color: var(--text);
}
.sf-opt:last-child { border-bottom: none; }
.sf-opt:hover { background: rgba(0,229,160,.1); color: var(--accent); }
.sf-opt.sf-empty { color: var(--muted); cursor: default; font-style: italic; }
.sf-opt.sf-empty:hover { background: none; color: var(--muted); }

@media(max-width:768px){
  .sf-input { font-size: 16px !important; }
}

@media(min-width:769px){
  .table-scroll-wrap { display: block; }
  .data-cards { display: none; }
}
</style>
</head>
<body>

<!-- ===== AUTH SCREEN ===== -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">Stock<span>Flow</span></div>
    <div class="auth-sub">Sistema de Gestão de Estoque</div>
    <div class="form-group">
      <label>E-mail</label>
      <input id="login-user" type="email" placeholder="seu@email.com" onkeydown="if(event.key==='Enter')fazerLogin()">
    </div>
    <div class="form-group">
      <label>Senha</label>
      <input id="login-pass" type="password" placeholder="Digite sua senha" onkeydown="if(event.key==='Enter')fazerLogin()">
    </div>
    <div id="login-error" style="display:none;color:var(--danger);font-size:13px;margin-bottom:12px;text-align:center;padding:10px;background:rgba(255,59,92,.08);border-radius:8px;"></div>
    <button class="btn btn-primary" onclick="fazerLogin()" style="width:100%;">Entrar</button>
    <div style="margin-top:16px;text-align:center;color:var(--muted);font-size:12px;">
      Entre com seu e-mail e senha cadastrados pelo administrador.
    </div>
  </div>
</div>

<!-- ===== APP ===== -->
<div id="app">
  <!-- TOP BAR (mobile) -->
  <div id="topbar">
    <button id="menu-toggle" onclick="toggleSidebar()">
      <svg width="22" height="22" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
    </button>
    <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:16px;">Stock<span style="color:var(--accent)">Flow</span></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <div id="notif-bell-mobile" onclick="toggleNotif()">
        <div style="position:relative;">
          <svg width="22" height="22" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
          <div id="notif-badge-m" style="position:absolute;top:-4px;right:-4px;width:16px;height:16px;background:var(--danger);color:#fff;border-radius:99px;font-size:9px;font-weight:700;display:none;align-items:center;justify-content:center;">0</div>
        </div>
      </div>
    </div>
  </div>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="sidebar-logo">
      Stock<span>Flow</span>
      <button onclick="toggleSidebar()" style="background:none;border:none;color:var(--muted);cursor:pointer;display:none;" id="sidebar-close">
        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>

    <!-- User info -->
    <div style="padding:12px 16px;border-bottom:1px solid var(--border);">
      <div id="user-chip">
        <div class="user-avatar" id="avatar-chip">AD</div>
        <div>
          <div style="font-size:13px;font-weight:600;" id="username-chip">Admin</div>
          <div style="font-size:11px;color:var(--muted);" id="role-chip">Administrador</div>
        </div>
        <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
          <div id="notif-bell" onclick="toggleNotif()">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
            <div id="notif-badge">0</div>
          </div>
        </div>
      </div>
    </div>

    <nav id="nav-menu" style="flex:1;padding:12px 0;overflow-y:auto;">
      <!-- filled by buildNav() -->
    </nav>

    <div style="padding:12px 16px;border-top:1px solid var(--border);">
      <div style="color:var(--muted);font-size:11px;margin-bottom:6px;">☁️ Firebase Sync</div>
      <div style="color:var(--muted);font-size:11px;margin-bottom:8px;" id="storage-info">—</div>
      <button onclick="fazerLogout()" style="width:100%;background:none;border:1px solid var(--border);color:var(--muted);border-radius:6px;padding:7px;font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;" onmouseover="this.style.color='var(--danger)';this.style.borderColor='var(--danger)'" onmouseout="this.style.color='var(--muted)';this.style.borderColor='var(--border)'">
        Sair
      </button>
    </div>
  </div>

  <!-- NOTIFICATION PANEL -->
  <div id="notif-panel">
    <div style="padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
      <span style="font-family:'Syne',sans-serif;font-weight:700;font-size:14px;">Notificações</span>
      <button onclick="marcarTodasLidas()" style="background:none;border:none;color:var(--accent);font-size:12px;cursor:pointer;">Marcar todas lidas</button>
    </div>
    <div id="notif-list"><div style="padding:32px;text-align:center;color:var(--muted);font-size:13px;">Nenhuma notificação</div></div>
  </div>

  <!-- MAIN -->
  <div id="main">

    <!-- PAGE: DASHBOARD (ADM) -->
    <div id="page-dash" class="page">
      <div class="section-title">Dashboard</div>
      <div class="section-sub">Visão geral consolidada do estoque</div>
      <div class="grid-4" style="margin-bottom:24px;" id="dash-stats"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;" class="desktop-only">
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:16px;font-size:14px;">Materiais por Status</div>
          <canvas id="chartStatus" height="200"></canvas>
        </div>
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:16px;font-size:14px;">Top Materiais (Quantidade)</div>
          <canvas id="chartTop" height="200"></canvas>
        </div>
      </div>
      <div class="card">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap;">
          <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:14px;flex:1;">Consolidado de Materiais</div>
          <div style="position:relative;">
            <svg style="position:absolute;left:9px;top:50%;transform:translateY(-50%);pointer-events:none;" width="13" height="13" fill="none" stroke="var(--muted)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M17 11A6 6 0 115 11a6 6 0 0112 0z"/></svg>
            <input id="dash-filtro-nome" type="text" placeholder="Buscar..." oninput="filtrarDashTabela()" style="padding:7px 10px 7px 28px;width:160px;font-size:12px;">
          </div>
          <select id="dash-filtro-status" onchange="filtrarDashTabela()" style="width:auto;padding:7px 10px;font-size:12px;">
            <option value="">Todos os status</option>
            <option value="badge-ok">Normal</option>
            <option value="badge-critical">Crítico</option>
            <option value="badge-over">Acima</option>
            <option value="badge-noref">Sem Ref.</option>
          </select>
          <select id="dash-filtro-cat" onchange="filtrarDashTabela()" style="width:auto;padding:7px 10px;font-size:12px;"><option value="">Todas cats</option></select>
          <button class="btn btn-secondary" onclick="limparFiltrosDash()" style="padding:7px 10px;font-size:12px;">✕</button>
        </div>
        <div id="dash-filtro-contador" style="font-size:12px;color:var(--muted);margin-bottom:8px;display:none;"></div>
        <div class="table-scroll-wrap"><table>
          <thead><tr><th>Material</th><th>Qtd Total</th><th>Estoques</th><th>Mín</th><th>Máx</th><th>Dias Chegada</th><th>Status</th></tr></thead>
          <tbody id="dash-tbody"></tbody>
        </table></div>
        <div id="dash-sem-resultado" style="display:none;text-align:center;color:var(--muted);padding:24px;">Nenhum material encontrado.</div>
      </div>
    </div>

    <!-- PAGE: CADASTRAR ESTOQUE -->
    <div id="page-cadastrar-estoque" class="page">
      <div class="section-title">Cadastrar Estoque</div>
      <div class="section-sub">Crie e gerencie locais de armazenamento</div>
      <div class="form-table-layout" style="display:grid;grid-template-columns:380px 1fr;gap:24px;align-items:start;">
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:18px;">Novo Estoque</div>
          <div class="form-group"><label>Nome *</label><input id="es-nome" type="text" placeholder="Ex: Almoxarifado Central"></div>
          <div class="form-group"><label>Descrição</label><input id="es-desc" type="text" placeholder="Descrição opcional"></div>
          <div class="form-group"><label>Localização</label><input id="es-local" type="text" placeholder="Ex: Bloco A"></div>
          <div class="form-group">
            <label class="checkbox-wrap"><input type="checkbox" id="es-principal"><span style="color:var(--text);font-size:13px;">Este é o estoque principal</span></label>
          </div>
          <button class="btn btn-primary" onclick="salvarEstoque()" style="width:100%;">Cadastrar Estoque</button>
        </div>
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:14px;">Estoques Cadastrados</div>
          <div class="table-scroll-wrap"><table><thead><tr><th>Nome</th><th>Local</th><th>Principal</th><th></th></tr></thead><tbody id="estoques-tbody"></tbody></table></div>
          <div class="data-cards" id="estoques-cards"></div>
          <div id="estoques-empty" style="text-align:center;color:var(--muted);padding:28px;display:none;">Nenhum estoque cadastrado.</div>
        </div>
      </div>
    </div>

    <!-- PAGE: CADASTRAR MATERIAL -->
    <div id="page-cadastrar-material" class="page">
      <div class="section-title">Cadastrar Material</div>
      <div class="section-sub">Registre os materiais e defina limites de estoque</div>
      <div class="form-table-layout" style="display:grid;grid-template-columns:420px 1fr;gap:24px;align-items:start;">
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:18px;">Novo Material</div>
          <div class="form-group"><label>Nome *</label><input id="mat-nome" type="text" placeholder="Ex: Luva Cirúrgica"></div>
          <div class="form-group"><label>Categoria</label><input id="mat-cat" type="text" placeholder="Ex: EPI, Medicamento..."></div>
          <div class="form-group"><label>Unidade de Medida</label><input id="mat-unidade" type="text" placeholder="Ex: un, caixa, kg..."></div>
          <div class="grid-2">
            <div class="form-group"><label>Estoque Mínimo</label><input id="mat-min" type="number" placeholder="Opcional" min="0"></div>
            <div class="form-group"><label>Estoque Máximo</label><input id="mat-max" type="number" placeholder="Opcional" min="0"></div>
          </div>
          <div class="form-group">
            <label>Dias para chegada (lead time)</label>
            <input id="mat-dias" type="number" placeholder="Ex: 7" min="0">
            <div style="font-size:11px;color:var(--muted);margin-top:4px;">Média de dias desde o pedido até a chegada no estoque.</div>
          </div>
          <button class="btn btn-primary" onclick="salvarMaterial()" style="width:100%;">Cadastrar Material</button>
        </div>
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:14px;">Materiais Cadastrados</div>
          <div class="table-scroll-wrap"><table><thead><tr><th>Nome</th><th>Cat.</th><th>Unid.</th><th>Mín</th><th>Máx</th><th>Dias</th><th></th></tr></thead><tbody id="materiais-tbody"></tbody></table></div>
          <div class="data-cards" id="materiais-cards"></div>
          <div id="materiais-empty" style="text-align:center;color:var(--muted);padding:28px;display:none;">Nenhum material cadastrado.</div>
        </div>
      </div>
    </div>

    <!-- PAGE: ENTRADA -->
    <div id="page-entrada" class="page">
      <div class="section-title">Entrada de Materiais</div>
      <div class="section-sub">Registre a entrada de materiais no estoque</div>
      <div class="req-layout" style="display:grid;grid-template-columns:460px 1fr;gap:24px;align-items:start;">
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:18px;">Nova Entrada</div>
          <div class="form-group"><label>Material *</label><div id="sf-ent-material-wrap" class="sf-wrap"></div><select id="ent-material" style="display:none;"><option value="">Selecione...</option></select></div>
          <div class="form-group"><label>Estoque Destino *</label><select id="ent-estoque"><option value="">Selecione...</option></select></div>
          <div class="form-group" id="ent-lote-group"><label>Lote *</label><input id="ent-lote" type="text" placeholder="Código do lote"></div>
          <div class="form-group">
            <label class="checkbox-wrap"><input type="checkbox" id="ent-semlote" onchange="toggleLote()"><span style="color:var(--text);font-size:13px;">Sem lote</span></label>
          </div>
          <div class="grid-2">
            <div class="form-group"><label>Quantidade *</label><input id="ent-qtd" type="number" placeholder="0" min="1"></div>
            <div class="form-group"><label>Validade</label><input id="ent-val" type="date"></div>
          </div>
          <div class="form-group"><label>Observação</label><input id="ent-obs" type="text" placeholder="Opcional"></div>
          <button class="btn btn-primary" onclick="registrarEntrada()" style="width:100%;">Registrar Entrada</button>
        </div>
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:14px;">Últimas Entradas</div>
          <div class="table-scroll-wrap"><table><thead><tr><th>Material</th><th>Estoque</th><th>Lote</th><th>Qtd</th><th>Validade</th><th>Data</th><th></th></tr></thead><tbody id="entradas-tbody"></tbody></table></div>
          <div class="data-cards" id="entradas-cards"></div>
          <div id="entradas-empty" style="text-align:center;color:var(--muted);padding:28px;display:none;">Nenhuma entrada registrada.</div>
        </div>
      </div>
    </div>

    <!-- PAGE: SAÍDA -->
    <div id="page-saida" class="page">
      <div class="section-title">Saída de Materiais</div>
      <div class="section-sub">Registre a saída de materiais do estoque</div>
      <div class="req-layout" style="display:grid;grid-template-columns:460px 1fr;gap:24px;align-items:start;">
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:18px;">Nova Saída</div>
          <div class="form-group"><label>Estoque Origem *</label><select id="sai-estoque" onchange="carregarItensSaida()"><option value="">Selecione...</option></select></div>
          <div class="form-group"><label>Item (Material/Lote) *</label><div id="sf-sai-item-wrap" class="sf-wrap"></div><select id="sai-item" style="display:none;"><option value="">Selecione o estoque primeiro...</option></select></div>
          <div class="form-group"><label>Quantidade *</label><input id="sai-qtd" type="number" placeholder="0" min="1"></div>
          <div class="form-group"><label>Motivo</label><input id="sai-motivo" type="text" placeholder="Ex: Consumo, Vencimento..."></div>
          <div class="form-group"><label>Responsável</label><input id="sai-resp" type="text" placeholder="Nome do responsável"></div>
          <button class="btn btn-danger" onclick="registrarSaida()" style="width:100%;">Registrar Saída</button>
        </div>
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:14px;">Últimas Saídas</div>
          <div class="table-scroll-wrap"><table><thead><tr><th>Material</th><th>Estoque</th><th>Lote</th><th>Qtd</th><th>Motivo</th><th>Data</th></tr></thead><tbody id="saidas-tbody"></tbody></table></div>
          <div class="data-cards" id="saidas-cards"></div>
          <div id="saidas-empty" style="text-align:center;color:var(--muted);padding:28px;display:none;">Nenhuma saída registrada.</div>
        </div>
      </div>
    </div>

    <!-- PAGE: ANÁLISE -->
    <div id="page-analise" class="page">
      <div class="section-title">Análise de Estoques</div>
      <div class="section-sub">Visualize o estado detalhado de cada estoque</div>
      <div class="card" style="margin-bottom:18px;">
        <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
          <div style="flex:1;min-width:200px;max-width:340px;"><label>Selecionar Estoque</label><select id="analise-estoque" onchange="carregarAnalise()"><option value="">Selecione...</option></select></div>
          <div style="display:flex;gap:6px;margin-top:18px;flex-wrap:wrap;">
            <span class="badge badge-ok">● Normal</span><span class="badge badge-critical">● Crítico</span><span class="badge badge-over">● Acima</span><span class="badge badge-noref">● Sem Ref.</span>
          </div>
        </div>
      </div>
      <div id="analise-filtros" style="display:none;margin-bottom:18px;">
        <div class="card">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <div style="flex:2;min-width:160px;position:relative;">
              <svg style="position:absolute;left:9px;top:50%;transform:translateY(-50%);" width="13" height="13" fill="none" stroke="var(--muted)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M17 11A6 6 0 115 11a6 6 0 0112 0z"/></svg>
              <input id="filtro-nome" type="text" placeholder="Buscar material ou lote..." oninput="aplicarFiltros()" style="padding-left:30px;">
            </div>
            <select id="filtro-cat" onchange="aplicarFiltros()" style="flex:1;min-width:130px;"><option value="">Todas as cats</option></select>
            <select id="filtro-status" onchange="aplicarFiltros()" style="flex:1;min-width:130px;">
              <option value="">Todos os status</option><option value="badge-ok">Normal</option><option value="badge-critical">Crítico</option><option value="badge-over">Acima</option><option value="badge-noref">Sem Ref.</option>
            </select>
            <select id="filtro-validade" onchange="aplicarFiltros()" style="flex:1;min-width:130px;">
              <option value="">Qualquer validade</option><option value="vencido">Vencidos</option><option value="30dias">Vence em 30d</option><option value="60dias">Vence em 60d</option><option value="ok">No prazo</option><option value="sem">Sem validade</option>
            </select>
            <select id="filtro-ordem" onchange="aplicarFiltros()" style="flex:1;min-width:130px;">
              <option value="nome-asc">Nome A→Z</option><option value="nome-desc">Nome Z→A</option><option value="qtd-asc">Menor qtd</option><option value="qtd-desc">Maior qtd</option><option value="val-asc">Val. próxima</option>
            </select>
            <button class="btn btn-secondary" onclick="limparFiltros()" style="padding:10px 12px;font-size:12px;">✕</button>
          </div>
          <div id="filtro-contador" style="margin-top:8px;font-size:12px;color:var(--muted);display:none;"></div>
        </div>
      </div>
      <div id="analise-summary" style="display:none;margin-bottom:18px;"><div class="grid-4" id="analise-stats"></div></div>
      <div class="card" id="analise-card" style="display:none;">
        <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:14px;" id="analise-title">Itens do Estoque</div>
        <div class="table-scroll-wrap"><table><thead><tr><th>Material</th><th>Lote</th><th>Quantidade</th><th>Validade</th><th>Mín</th><th>Máx</th><th>Status</th><th></th></tr></thead><tbody id="analise-tbody"></tbody></table></div>
          <div class="data-cards" id="analise-cards"></div>
        <div id="analise-nenhum-filtro" style="display:none;text-align:center;color:var(--muted);padding:28px;">Nenhum item encontrado.</div>
      </div>
      <div id="analise-empty" class="card" style="text-align:center;color:var(--muted);padding:40px;display:none;">Nenhum item neste estoque.</div>
      <div id="analise-placeholder" style="text-align:center;color:var(--muted);padding:60px;">Selecione um estoque para visualizar.</div>
    </div>

    <!-- PAGE: PLANEJAMENTO DE COMPRAS -->
    <div id="page-compras" class="page">
      <div class="section-title">Planejamento de Compras</div>
      <div class="section-sub">Melhor data de compra para nunca deixar o estoque zerar — baseado no lead time e estoque mínimo</div>
      <div class="card" style="margin-bottom:18px;">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
          <div style="position:relative;flex:1;min-width:180px;">
            <svg style="position:absolute;left:9px;top:50%;transform:translateY(-50%);" width="13" height="13" fill="none" stroke="var(--muted)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M17 11A6 6 0 115 11a6 6 0 0112 0z"/></svg>
            <input id="compras-busca" type="text" placeholder="Buscar material..." oninput="renderCompras()" style="padding-left:30px;">
          </div>
          <select id="compras-filtro" onchange="renderCompras()" style="width:auto;padding:10px 14px;">
            <option value="">Todos</option>
            <option value="urgente">Urgente (comprar hoje)</option>
            <option value="breve">Breve (próx. 7 dias)</option>
            <option value="ok">No prazo</option>
            <option value="sem-ref">Sem referência</option>
          </select>
        </div>
      </div>
      <div class="card">
        <div class="table-scroll-wrap"><table>
          <thead><tr><th>Material</th><th>Qtd Total</th><th>Estoque Mín.</th><th>Lead Time</th><th>Consumo Médio/dia</th><th>Dias de Estoque</th><th>Pedir Até</th><th>Situação</th></tr></thead>
          <tbody id="compras-tbody"></tbody>
        </table></div>
          <div class="data-cards" id="compras-cards"></div>
        <div id="compras-empty" style="text-align:center;color:var(--muted);padding:32px;display:none;">Nenhum material com informações suficientes para calcular.</div>
      </div>
      <div style="margin-top:14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px 16px;font-size:12px;color:var(--muted);line-height:1.8;">
        <strong style="color:var(--text);font-family:'Syne',sans-serif;">Como é calculado:</strong> A data limite para compra é calculada como: <em>hoje + dias de estoque restante - lead time</em>. "Dias de estoque restante" é estimado pela quantidade atual dividida pelo consumo médio diário (baseado nas saídas dos últimos 30 dias). Se não houver saídas registradas, usa a quantidade mínima como referência.
      </div>
    </div>

    <!-- PAGE: TRANSFERÊNCIA -->
    <div id="page-transferencia" class="page">
      <div class="section-title">Transferência entre Estoques</div>
      <div class="section-sub">Mova materiais de um estoque para outro</div>
      <div style="display:grid;grid-template-columns:480px 1fr;gap:24px;align-items:start;">
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:18px;">Nova Transferência</div>
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:14px;">
            <div style="font-family:'Syne',sans-serif;font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.5px;text-transform:uppercase;margin-bottom:10px;">Origem</div>
            <div class="form-group"><label>Estoque *</label><select id="trf-est-origem" onchange="carregarItensTransf()"><option value="">Selecione...</option></select></div>
            <div class="form-group"><label>Item *</label><div id="sf-trf-item-wrap" class="sf-wrap"></div><select id="trf-item" onchange="preencherInfoTransf()" style="display:none;"><option value="">Selecione o estoque primeiro...</option></select></div>
            <div id="trf-info-item" style="display:none;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:12px;margin-bottom:4px;"></div>
            <div class="form-group" style="margin-bottom:0;"><label>Quantidade *</label><input id="trf-qtd" type="number" min="1" placeholder="0"></div>
          </div>
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:14px;">
            <div style="font-family:'Syne',sans-serif;font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.5px;text-transform:uppercase;margin-bottom:10px;">Destino</div>
            <div class="form-group"><label>Estoque *</label><select id="trf-est-destino"><option value="">Selecione...</option></select></div>
            <div class="form-group" style="margin-bottom:0;">
              <div style="display:flex;gap:16px;margin-top:4px;">
                <label class="checkbox-wrap"><input type="radio" name="trf-lote-modo" id="trf-lote-manter" value="manter" checked onchange="toggleTrfLote()"><span style="font-size:13px;color:var(--text);">Manter lote</span></label>
                <label class="checkbox-wrap"><input type="radio" name="trf-lote-modo" id="trf-lote-novo" value="novo" onchange="toggleTrfLote()"><span style="font-size:13px;color:var(--text);">Novo lote</span></label>
              </div>
            </div>
            <div class="form-group" id="trf-novo-lote-group" style="display:none;margin-top:10px;margin-bottom:0;"><label>Novo Lote *</label><input id="trf-novo-lote" type="text"></div>
          </div>
          <div class="form-group"><label>Motivo</label><input id="trf-motivo" type="text" placeholder="Ex: Redistribuição..."></div>
          <div class="form-group"><label>Responsável</label><input id="trf-resp" type="text"></div>
          <button class="btn btn-primary" onclick="registrarTransferencia()" style="width:100%;">Registrar Transferência</button>
        </div>
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:14px;">Histórico</div>
          <div class="table-scroll-wrap"><table><thead><tr><th>Material / Lote</th><th>Origem</th><th>Destino</th><th>Qtd</th><th>Resp.</th><th>Data</th></tr></thead><tbody id="transf-tbody"></tbody></table></div>
          <div class="data-cards" id="transf-cards"></div>
          <div id="transf-empty" style="text-align:center;color:var(--muted);padding:32px;display:none;">Nenhuma transferência.</div>
        </div>
      </div>
    </div>

    <!-- PAGE: REQUISIÇÕES (USUÁRIO) -->
    <div id="page-requisicoes" class="page">
      <div class="section-title">Nova Requisição</div>
      <div class="section-sub">Solicite materiais do estoque principal</div>
      <div class="req-layout" style="display:grid;grid-template-columns:460px 1fr;gap:24px;align-items:start;">
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:18px;">Solicitar Material</div>
          <div class="form-group"><label>Estoque *</label><select id="req-estoque" onchange="carregarMateraisReq()"><option value="">Selecione...</option></select></div>
          <div class="form-group"><label>Material *</label><div id="sf-req-material-wrap" class="sf-wrap"></div><select id="req-material" onchange="carregarLotesReq()" style="display:none;"><option value="">Selecione o estoque primeiro...</option></select></div>
          <div class="form-group"><label>Lote *</label><div id="sf-req-lote-wrap" class="sf-wrap"></div><select id="req-lote" style="display:none;"><option value="">Selecione o material primeiro...</option></select></div>
          <div id="req-info-lote" style="display:none;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:12px;color:var(--muted);margin-bottom:12px;"></div>
          <div class="form-group">
            <label>Setor Solicitante *</label>
            <select id="req-setor">
              <option value="">Selecione o setor...</option>
              <option>Usinagem</option><option>Acabamento</option><option>Área Limpa</option><option>Quarentena</option><option>Qualidade</option><option>Produto Acabado</option><option>PDI</option><option>Administrativo</option><option>Manutenção</option>
            </select>
          </div>
          <div class="form-group"><label>Quantidade *</label><input id="req-qtd" type="number" min="1" placeholder="0"></div>
          <div class="form-group"><label>Justificativa</label><input id="req-justif" type="text" placeholder="Para qual finalidade?"></div>
          <button class="btn btn-primary" onclick="registrarRequisicao()" style="width:100%;">Enviar Requisição</button>
        </div>
        <div>
          <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:15px;margin-bottom:14px;">Minhas Requisições</div>
          <!-- TABLE (desktop) -->
          <div class="card desktop-only">
            <div class="table-scroll-wrap"><table><thead><tr><th>Material</th><th>Lote</th><th>Setor</th><th>Qtd</th><th>Status</th><th>Obs</th><th>Data</th></tr></thead><tbody id="minhas-req-tbody"></tbody></table></div>
            <div id="minhas-req-empty" style="text-align:center;color:var(--muted);padding:28px;display:none;">Nenhuma requisição feita.</div>
          </div>
          <!-- CARDS (mobile) -->
          <div class="mobile-cards" id="minhas-req-cards"></div>
        </div>
      </div>
    </div>

    <!-- PAGE: ATENDIMENTO DE REQUISIÇÕES (ADM) -->
    <div id="page-atendimento" class="page">
      <div class="section-title">Atendimento de Requisições</div>
      <div class="section-sub">Gerencie e atenda as requisições de estoque</div>
      <div class="card" style="margin-bottom:16px;">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <select id="atend-filtro-status" onchange="renderAtendimento()" style="width:auto;padding:8px 12px;font-size:13px;">
            <option value="">Todos</option><option value="pendente">Pendentes</option><option value="atendida">Atendidas</option><option value="aguardo">Em Aguardo</option><option value="negada">Negadas</option>
          </select>
          <select id="atend-filtro-setor" onchange="renderAtendimento()" style="width:auto;padding:8px 12px;font-size:13px;">
            <option value="">Todos os setores</option>
            <option>Usinagem</option><option>Acabamento</option><option>Área Limpa</option><option>Quarentena</option><option>Qualidade</option><option>Produto Acabado</option><option>PDI</option><option>Administrativo</option><option>Manutenção</option>
          </select>
          <div style="position:relative;flex:1;min-width:160px;">
            <svg style="position:absolute;left:9px;top:50%;transform:translateY(-50%);" width="13" height="13" fill="none" stroke="var(--muted)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M17 11A6 6 0 115 11a6 6 0 0112 0z"/></svg>
            <input id="atend-busca" type="text" placeholder="Buscar material ou solicitante..." oninput="renderAtendimento()" style="padding-left:30px;font-size:13px;">
          </div>
          <div id="atend-contador" style="margin-left:auto;font-size:13px;color:var(--muted);white-space:nowrap;"></div>
        </div>
      </div>
      <!-- TABLE (desktop) -->
      <div class="card desktop-only">
        <div class="table-scroll-wrap"><table>
          <thead><tr><th>Material</th><th>Lote</th><th>Setor</th><th>Solicitante</th><th>Qtd</th><th>Justif.</th><th>Data</th><th>Status</th><th>Ações</th></tr></thead>
          <tbody id="atendimento-tbody"></tbody>
        </table></div>
        <div id="atendimento-empty" style="text-align:center;color:var(--muted);padding:32px;display:none;">Nenhuma requisição encontrada.</div>
      </div>
      <!-- CARDS (mobile) -->
      <div class="mobile-cards" id="atendimento-cards"></div>
    </div>

    <!-- PAGE: USUÁRIOS (ADM) -->
    <div id="page-usuarios" class="page">
      <div class="section-title">Gerenciar Usuários</div>
      <div class="section-sub">Cadastre e gerencie os usuários do sistema</div>
      <div class="form-table-layout" style="display:grid;grid-template-columns:420px 1fr;gap:24px;align-items:start;">
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:18px;">Novo Usuário</div>
          <div class="form-group"><label>Nome Completo *</label><input id="nu-nome" type="text" placeholder="Ex: João Silva"></div>
          <div class="form-group"><label>E-mail *</label><input id="nu-email" type="email" placeholder="email@empresa.com"></div>
          <div class="form-group"><label>Senha *</label><input id="nu-senha" type="password" placeholder="Mínimo 6 caracteres"></div>
          <div class="form-group">
            <label>Perfil de Acesso *</label>
            <select id="nu-role">
              <option value="user">Usuário Comum — apenas requisições</option>
              <option value="adm">Administrador — acesso total</option>
            </select>
          </div>
          <div id="nu-error" style="display:none;color:var(--danger);font-size:13px;margin-bottom:12px;padding:10px;background:rgba(255,59,92,.08);border-radius:8px;"></div>
          <button class="btn btn-primary" onclick="cadastrarUsuario()" style="width:100%;" id="btn-cadastrar-usuario">Cadastrar Usuário</button>
        </div>
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:14px;">Usuários Cadastrados</div>
          <div class="table-scroll-wrap"><table>
            <thead><tr><th>Nome</th><th>E-mail</th><th>Perfil</th><th>Cadastrado</th><th></th></tr></thead>
            <tbody id="usuarios-tbody"></tbody>
          </table></div>
          <div class="data-cards" id="usuarios-cards"></div>
          <div id="usuarios-empty" style="text-align:center;color:var(--muted);padding:28px;display:none;">Nenhum usuário cadastrado.</div>
          <div id="usuarios-loading" style="text-align:center;color:var(--muted);padding:28px;">Carregando...</div>
        </div>
      </div>
    </div>

    <!-- PAGE: BACKUP -->
    <div id="page-backup" class="page">
      <div class="section-title">Backup & Restauração</div>
      <div class="section-sub">Exporte, importe e gerencie snapshots dos dados</div>
      <div class="grid-2" style="margin-bottom:20px;">
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:14px;">Exportar Backup</div>
          <div class="form-group"><label>Nome do arquivo</label><input id="backup-nome" type="text" value="stockflow_backup"></div>
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:14px;font-size:13px;" id="backup-preview">Carregando...</div>
          <button class="btn btn-primary" onclick="exportarBackup()" style="width:100%;">Baixar Backup (.json)</button>
        </div>
        <div class="card">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:14px;">Importar Backup</div>
          <div id="import-dropzone" style="border:2px dashed var(--border);border-radius:10px;padding:24px;text-align:center;cursor:pointer;margin-bottom:12px;" onclick="document.getElementById('import-file').click()" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropFile(event)">
            <div style="color:var(--muted);font-size:13px;">Arraste ou <span style="color:var(--accent);font-weight:600;">clique para selecionar</span></div>
            <div style="color:var(--muted);font-size:11px;margin-top:4px;">.json de backup StockFlow</div>
          </div>
          <input type="file" id="import-file" accept=".json" style="display:none;" onchange="importarBackup(this)">
          <div id="import-preview" style="display:none;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px;font-size:13px;"></div>
          <button class="btn" id="btn-confirmar-import" onclick="confirmarImport()" style="width:100%;background:var(--accent2);color:#fff;display:none;">Confirmar Restauração</button>
        </div>
      </div>
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
          <div style="font-family:'Syne',sans-serif;font-weight:700;">Snapshots Salvos</div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-secondary" onclick="criarSnapshot(true)" style="font-size:12px;padding:7px 14px;">+ Criar Snapshot</button>
            <button class="btn btn-danger" onclick="limparSnapshots()" style="font-size:12px;padding:7px 14px;">Limpar Todos</button>
          </div>
        </div>
        <div class="table-scroll-wrap"><table><thead><tr><th>Nome / Data</th><th>Estoques</th><th>Materiais</th><th>Itens</th><th>Tamanho</th><th>Ações</th></tr></thead><tbody id="snapshots-tbody"></tbody></table></div>
          <div class="data-cards" id="snapshots-cards"></div>
        <div id="snapshots-empty" style="text-align:center;color:var(--muted);padding:28px;display:none;">Nenhum snapshot.</div>
      </div>
    </div>


    <div id="page-relatorios" class="page">
      <div class="section-title">Relatórios</div>
      <div class="section-sub">Gere relatórios completos dos itens em estoque em Excel ou PDF</div>

      <div class="card" style="margin-bottom:20px;">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:15px;margin-bottom:16px;">⚙️ Configurações do Relatório</div>
        <div class="grid-2" style="margin-bottom:16px;">
          <div class="form-group">
            <label>Estoque</label>
            <select id="rel-estoque">
              <option value="">Todos os estoques</option>
            </select>
          </div>
          <div class="form-group">
            <label>Categoria</label>
            <select id="rel-categoria">
              <option value="">Todas as categorias</option>
            </select>
          </div>
        </div>
        <div class="grid-2" style="margin-bottom:16px;">
          <div class="form-group">
            <label>Status</label>
            <select id="rel-status">
              <option value="">Todos</option>
              <option value="badge-ok">Normal</option>
              <option value="badge-critical">Crítico</option>
              <option value="badge-over">Acima do máximo</option>
              <option value="badge-noref">Sem referência</option>
            </select>
          </div>
          <div class="form-group">
            <label>Ordenar por</label>
            <select id="rel-ordem">
              <option value="nome">Nome do material</option>
              <option value="qtd-desc">Quantidade (maior)</option>
              <option value="qtd-asc">Quantidade (menor)</option>
              <option value="estoque">Estoque</option>
              <option value="status">Status</option>
            </select>
          </div>
        </div>
        <div style="margin-bottom:16px;">
          <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:8px;">Colunas a incluir</label>
          <div style="display:flex;flex-wrap:wrap;gap:10px;">
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="rel-col-material" checked> Material</label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="rel-col-estoque" checked> Estoque</label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="rel-col-lote" checked> Lote</label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="rel-col-qtd" checked> Quantidade</label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="rel-col-min"> Mínimo</label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="rel-col-max"> Máximo</label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="rel-col-categoria"> Categoria</label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="rel-col-unidade"> Unidade</label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="rel-col-validade"> Validade</label>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;"><input type="checkbox" id="rel-col-status" checked> Status</label>
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="gerarRelatorioExcel()" style="flex:1;min-width:160px;">
            📊 Exportar Excel (.xlsx)
          </button>
          <button class="btn" onclick="gerarRelatorioPDF()" style="flex:1;min-width:160px;background:#dc2626;color:#fff;border:none;">
            📄 Exportar PDF
          </button>
          <button class="btn btn-secondary" onclick="previewRelatorio()" style="flex:1;min-width:160px;">
            👁 Pré-visualizar
          </button>
        </div>
      </div>

      <!-- Preview table -->
      <div class="card" id="rel-preview-card" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
          <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:15px;">Pré-visualização</div>
          <span id="rel-preview-count" style="font-size:12px;color:var(--muted);"></span>
        </div>
        <div style="overflow-x:auto;"><div class="table-scroll-wrap"><table id="rel-preview-table"><thead></thead><tbody></tbody></table></div></div>
      </div>
    </div>

    <!-- PAGE: AUDITORIA -->
    <div id="page-auditoria" class="page">
      <div class="section-title">Auditoria & Logs</div>
      <div class="section-sub">Registro automático de todas as ações do sistema</div>

      <div class="card" style="margin-bottom:16px;">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
          <div style="flex:2;min-width:160px;">
            <label style="font-size:11px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;display:block;">Buscar</label>
            <input id="aud-busca" type="text" placeholder="Usuário, ação, detalhe..." oninput="renderAuditoria()">
          </div>
          <div style="min-width:150px;">
            <label style="font-size:11px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;display:block;">Tipo</label>
            <select id="aud-tipo" onchange="renderAuditoria()">
              <option value="">Todos os tipos</option>
              <option value="login">🔑 Login</option>
              <option value="logout">🚪 Logout</option>
              <option value="entrada">📥 Entrada</option>
              <option value="saida">📤 Saída</option>
              <option value="transferencia">🔄 Transferência</option>
              <option value="requisicao">📋 Requisição</option>
              <option value="atendimento">✅ Atendimento</option>
              <option value="material">📦 Material</option>
              <option value="estoque">🏭 Estoque</option>
              <option value="usuario">👤 Usuário</option>
              <option value="backup">💾 Backup</option>
              <option value="sistema">⚙️ Sistema</option>
            </select>
          </div>
          <div style="min-width:140px;">
            <label style="font-size:11px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;display:block;">De</label>
            <input id="aud-de" type="date" onchange="renderAuditoria()">
          </div>
          <div style="min-width:140px;">
            <label style="font-size:11px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;display:block;">Até</label>
            <input id="aud-ate" type="date" onchange="renderAuditoria()">
          </div>
          <div style="display:flex;gap:8px;align-self:flex-end;">
            <button class="btn btn-secondary" onclick="limparFiltrosAud()">✕ Limpar</button>
            <button class="btn btn-danger" onclick="exportarAuditoriaPDF()" style="background:var(--danger);color:#fff;">📄 PDF</button>
          </div>
        </div>
        <div id="aud-contador" style="font-size:12px;color:var(--muted);margin-top:10px;display:none;"></div>
      </div>

      <div class="card" style="padding:0;overflow:hidden;">
        <div class="table-scroll-wrap">
          <table>
            <thead><tr>
              <th style="min-width:140px">Data / Hora</th>
              <th>Usuário</th>
              <th>Tipo</th>
              <th>Ação</th>
              <th style="min-width:200px">Detalhe</th>
            </tr></thead>
            <tbody id="aud-tbody"></tbody>
          </table>
        </div>
        <div class="data-cards" id="aud-cards"></div>
        <div id="aud-empty" style="display:none;text-align:center;color:var(--muted);padding:40px 20px;">
          <div style="font-size:32px;margin-bottom:8px;">📋</div>
          Nenhum log encontrado.
        </div>
        <div id="aud-paginacao" style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-top:1px solid var(--border);font-size:13px;"></div>
      </div>
    </div>
  </div><!-- /main -->
</div><!-- /app -->

<!-- MODALS -->
<div id="modal-material" class="modal">
  <div class="modal-box">
    <div class="modal-title">Editar Material <button class="modal-close" onclick="fecharModal('modal-material')">✕</button></div>
    <input type="hidden" id="edit-mat-id">
    <div class="form-group"><label>Nome *</label><input id="edit-mat-nome" type="text"></div>
    <div class="form-group"><label>Categoria</label><input id="edit-mat-cat" type="text"></div>
    <div class="form-group"><label>Unidade</label><input id="edit-mat-unidade" type="text"></div>
    <div class="grid-2">
      <div class="form-group"><label>Mínimo</label><input id="edit-mat-min" type="number" min="0"></div>
      <div class="form-group"><label>Máximo</label><input id="edit-mat-max" type="number" min="0"></div>
    </div>
    <div class="form-group"><label>Dias para chegada (lead time)</label><input id="edit-mat-dias" type="number" min="0" placeholder="Ex: 7"></div>
    <div style="display:flex;gap:10px;margin-top:8px;">
      <button class="btn btn-secondary" onclick="fecharModal('modal-material')" style="flex:1;">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarEdicaoMaterial()" style="flex:2;">Salvar</button>
    </div>
  </div>
</div>

<div id="modal-entrada" class="modal">
  <div class="modal-box">
    <div class="modal-title">Editar Entrada <button class="modal-close" onclick="fecharModal('modal-entrada')">✕</button></div>
    <input type="hidden" id="edit-ent-id"><input type="hidden" id="edit-ent-item-id">
    <div class="form-group"><label>Material</label><input id="edit-ent-material-nome" type="text" disabled style="opacity:.5;"></div>
    <div class="form-group"><label>Estoque</label><input id="edit-ent-estoque-nome" type="text" disabled style="opacity:.5;"></div>
    <div class="form-group" id="edit-ent-lote-group"><label>Lote</label><input id="edit-ent-lote" type="text"></div>
    <div class="form-group"><label class="checkbox-wrap"><input type="checkbox" id="edit-ent-semlote" onchange="toggleEditLote()"><span style="color:var(--text);font-size:13px;">Sem lote</span></label></div>
    <div class="grid-2">
      <div class="form-group"><label>Quantidade *</label><input id="edit-ent-qtd" type="number" min="1"></div>
      <div class="form-group"><label>Validade</label><input id="edit-ent-val" type="date"></div>
    </div>
    <div class="form-group"><label>Observação</label><input id="edit-ent-obs" type="text"></div>
    <div style="display:flex;gap:10px;margin-top:8px;">
      <button class="btn btn-secondary" onclick="fecharModal('modal-entrada')" style="flex:1;">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarEdicaoEntrada()" style="flex:2;">Salvar</button>
    </div>
  </div>
</div>

<div id="modal-item" class="modal">
  <div class="modal-box">
    <div class="modal-title">Editar Item do Estoque <button class="modal-close" onclick="fecharModal('modal-item')">✕</button></div>
    <input type="hidden" id="edit-item-id">
    <div id="edit-item-info" style="color:var(--muted);font-size:13px;margin-bottom:16px;"></div>
    <div class="form-group"><label>Material</label><input id="edit-item-material" disabled style="opacity:.5;"></div>
    <div class="form-group"><label>Estoque</label><input id="edit-item-estoque" disabled style="opacity:.5;"></div>
    <div class="form-group" id="edit-item-lote-group"><label>Lote</label><input id="edit-item-lote" type="text"></div>
    <div class="form-group"><label class="checkbox-wrap"><input type="checkbox" id="edit-item-semlote" onchange="toggleEditItemLote()"><span style="color:var(--text);font-size:13px;">Sem lote</span></label></div>
    <div class="grid-2">
      <div class="form-group"><label>Quantidade *</label><input id="edit-item-qtd" type="number" min="0"></div>
      <div class="form-group"><label>Validade</label><input id="edit-item-val" type="date"></div>
    </div>
    <div class="form-group"><label>Observação</label><input id="edit-item-obs" type="text"></div>
    <div style="display:flex;gap:10px;margin-top:8px;">
      <button class="btn btn-secondary" onclick="fecharModal('modal-item')" style="flex:1;">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarEdicaoItem()" style="flex:2;">Salvar</button>
    </div>
  </div>
</div>

<div id="modal-atender" class="modal">
  <div class="modal-box">
    <div class="modal-title" id="modal-atender-title">Atender Requisição <button class="modal-close" onclick="fecharModal('modal-atender')">✕</button></div>
    <input type="hidden" id="modal-atender-id">
    <input type="hidden" id="modal-atender-acao">
    <input type="hidden" id="modal-atender-qtd-original">
    <div id="modal-atender-info" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:16px;font-size:13px;"></div>
    <div class="form-group" id="modal-atender-qtd-group" style="display:none;">
      <label>Quantidade a Atender <span style="color:var(--muted);font-size:11px;" id="modal-atender-qtd-hint"></span></label>
      <input id="modal-atender-qtd" type="number" min="1" placeholder="0" oninput="verificarQtdDiferente()">
    </div>
    <div class="form-group" id="modal-atender-motivo-group" style="display:none;">
      <label id="modal-atender-motivo-label">Motivo *</label>
      <textarea id="modal-atender-motivo" rows="3" placeholder="Informe o motivo..." style="resize:vertical;"></textarea>
    </div>
    <div style="display:flex;gap:10px;margin-top:8px;">
      <button class="btn btn-secondary" onclick="fecharModal('modal-atender')" style="flex:1;">Cancelar</button>
      <button class="btn btn-primary" id="modal-atender-btn" onclick="confirmarAcaoReq()" style="flex:2;">Confirmar</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// ===========================
// STATE & PERSISTENCE — FIREBASE
// ===========================
const SNAP_KEY = 'stockflow_snapshots';
const MAX_SNAPS = 10;

// currentUser é preenchido pelo observer do Firebase (módulo ES acima)
let currentUser = null;
let chartStatus = null, chartTop = null;
let dashMatCache = [];
let analiseItensCache = [];
let pendingImport = null;

// ---- FIRESTORE HELPERS ----
function fsDoc(...args) { return window._firebase.doc(window._firebase.firestore, ...args); }
function fsColl(...args) { return window._firebase.collection(window._firebase.firestore, ...args); }

// Estrutura em memória — espelhada do Firestore
let db = { estoques:[], materiais:[], itens:[], entradas:[], saidas:[], transferencias:[], requisicoes:[], notificacoes:[] };

async function loadDB() {
  // Notificações são carregadas separadamente via listener em tempo real
  const fields = ['estoques','materiais','itens','entradas','saidas','transferencias','requisicoes'];
  for (const f of fields) {
    try {
      const snap = await window._firebase.getDocs(fsColl('stockflow', f, 'items'));
      db[f] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch(e) { console.warn('Erro ao carregar', f, e); db[f] = []; }
  }
  db.notificacoes = []; // preenchido pelo listener em tempo real
  updateStorageInfo();
}

// Salva UM documento no Firestore
async function saveItem(collName, item) {
  try {
    await window._firebase.setDoc(
      fsDoc('stockflow', collName, 'items', item.id),
      item
    );
  } catch(e) {
    console.error('Erro ao salvar', collName, item.id, e);
    throw e;
  }
}

// Deleta UM documento do Firestore e da memória
async function deleteItem(collName, itemId) {
  db[collName] = db[collName].filter(x => x.id !== itemId);
  try {
    await window._firebase.deleteDoc(fsDoc('stockflow', collName, 'items', itemId));
  } catch(e) { console.error('Erro ao deletar', collName, itemId, e); throw e; }
}

// Salva múltiplos itens em batch (respeita o limite de 500 do Firestore)
async function saveItemsBatch(collName, items) {
  const CHUNK = 400;
  for (let i = 0; i < items.length; i += CHUNK) {
    const batch = window._firebase.writeBatch(window._firebase.firestore);
    items.slice(i, i + CHUNK).forEach(item => {
      batch.set(fsDoc('stockflow', collName, 'items', item.id), item);
    });
    await batch.commit();
  }
}

// Deleta múltiplos itens em batch
async function deleteItemsBatch(collName, ids) {
  if (!ids.length) return;
  const CHUNK = 400;
  for (let i = 0; i < ids.length; i += CHUNK) {
    const batch = window._firebase.writeBatch(window._firebase.firestore);
    ids.slice(i, i + CHUNK).forEach(id => {
      batch.delete(fsDoc('stockflow', collName, 'items', id));
    });
    await batch.commit();
  }
}

// saveDB legado — agora salva coleção por coleção com batch seguro
async function saveCollection(collName) {
  await saveItemsBatch(collName, db[collName]);
}
async function saveDB() {
  const fields = ['estoques','materiais','itens','entradas','saidas','transferencias','requisicoes'];
  for (const f of fields) await saveCollection(f);
  updateStorageInfo();
}

async function saveItem(collName, item) {
  // Save just one item instead of whole collection
  const ref = fsDoc('stockflow', collName, 'items', item.id);
  await window._firebase.setDoc(ref, item);
  updateStorageInfo();
}

async function deleteItem(collName, itemId) {
  db[collName] = db[collName].filter(x => x.id !== itemId);
  await window._firebase.deleteDoc(fsDoc('stockflow', collName, 'items', itemId));
}

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }
function fmt(d) { if(!d) return '—'; return new Date(d).toLocaleDateString('pt-BR'); }
function fmtDT(d) { if(!d) return '—'; return new Date(d).toLocaleString('pt-BR'); }

// ===========================
// AUTH — FIREBASE
// ===========================

// Callbacks registrados pelo observer do módulo ES
window._onAuthReady = async (user) => {
  currentUser = user;
  await loadDB();
  iniciarApp();
  logAudit('login', `Login: ${user.nome}`, `E-mail: ${user.email} | Perfil: ${user.role}`);
};
window._onAuthLogout = () => {
  // Cancela listener de notificações
  if (window._notifUnsubscribe) { window._notifUnsubscribe(); window._notifUnsubscribe = null; }
  // Cancela listener de requisições
  if (window._reqUnsubscribe) {
    if (typeof window._reqUnsubscribe === 'function') window._reqUnsubscribe();
    else clearInterval(window._reqUnsubscribe);
    window._reqUnsubscribe = null;
  }
  currentUser = null;
  document.getElementById('app').classList.remove('logged');
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('login-user').value = '';
  document.getElementById('login-pass').value = '';
  document.getElementById('login-error').style.display = 'none';
};

async function fazerLogin() {
  const email = document.getElementById('login-user').value.trim();
  const pass  = document.getElementById('login-pass').value;
  const errEl = document.getElementById('login-error');
  errEl.style.display = 'none';
  if (!email || !pass) { errEl.style.display='block'; errEl.textContent='Preencha e-mail e senha.'; return; }
  try {
    await window._firebase.signInWithEmailAndPassword(window._firebase.auth, email, pass);
    // observer vai chamar _onAuthReady
  } catch(e) {
    errEl.style.display = 'block';
    errEl.textContent = e.code === 'auth/invalid-credential' || e.code === 'auth/wrong-password' || e.code === 'auth/user-not-found'
      ? 'E-mail ou senha incorretos.' : 'Erro ao entrar: ' + e.message;
  }
}

async function fazerLogout() {
  logAudit('logout', `Logout: ${currentUser?currentUser.nome:'?'}`, `E-mail: ${currentUser?currentUser.email:'?'}`);
  await window._firebase.signOut(window._firebase.auth);
}

function checkSession() {
  // Firebase cuida da persistência — não precisa de checkSession manual
  return false;
}

// ===========================
// GERENCIAR USUÁRIOS
// ===========================
async function cadastrarUsuario() {
  const nome  = document.getElementById('nu-nome').value.trim();
  const email = document.getElementById('nu-email').value.trim();
  const senha = document.getElementById('nu-senha').value;
  const role  = document.getElementById('nu-role').value;
  const errEl = document.getElementById('nu-error');
  const btn   = document.getElementById('btn-cadastrar-usuario');
  errEl.style.display = 'none';

  if (!nome || !email || !senha) { errEl.style.display='block'; errEl.textContent='Preencha todos os campos obrigatórios.'; return; }
  if (senha.length < 6) { errEl.style.display='block'; errEl.textContent='A senha deve ter pelo menos 6 caracteres.'; return; }

  btn.disabled = true; btn.textContent = 'Cadastrando...';
  try {
    // Cria o usuário no Firebase Auth usando a API REST (para não deslogar o admin)
    const apiKey = window._firebase.auth.app.options.apiKey;
    const res = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${apiKey}`, {
      method: 'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email, password: senha, returnSecureToken: true })
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    const uid = data.localId;

    // Salva perfil no Firestore
    await window._firebase.setDoc(window._firebase.doc(window._firebase.firestore, 'users', uid), {
      nome, email, role, username: email,
      criadoEm: new Date().toISOString(),
      criadoPor: currentUser.uid
    });

    // Limpa form
    ['nu-nome','nu-email','nu-senha'].forEach(id => document.getElementById(id).value='');
    document.getElementById('nu-role').value = 'user';
    logAudit('usuario', `Usuário cadastrado: ${nome}`, `E-mail: ${email} | Perfil: ${role}`);
    toast('Usuário cadastrado com sucesso!');
    renderUsuarios();
  } catch(e) {
    errEl.style.display = 'block';
    const msgs = { 'EMAIL_EXISTS':'Este e-mail já está em uso.', 'INVALID_EMAIL':'E-mail inválido.', 'WEAK_PASSWORD':'Senha muito fraca.' };
    errEl.textContent = msgs[e.message] || ('Erro: ' + e.message);
  } finally {
    btn.disabled = false; btn.textContent = 'Cadastrar Usuário';
  }
}

async function renderUsuarios() {
  const tb  = document.getElementById('usuarios-tbody');
  const em  = document.getElementById('usuarios-empty');
  const ld  = document.getElementById('usuarios-loading');
  if (!tb) return;
  tb.innerHTML = ''; if(em) em.style.display='none'; if(ld) ld.style.display='block';

  try {
    const snap = await window._firebase.getDocs(window._firebase.collection(window._firebase.firestore, 'users'));
    if(ld) ld.style.display='none';
    const users = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    if (!users.length) { if(em) em.style.display='block'; return; }
    users.forEach(u => {
      const isMe = u.id === currentUser.uid;
      tb.innerHTML += `<tr>
        <td><strong>${u.nome||'—'}</strong></td>
        <td style="color:var(--muted);font-size:12px;">${u.email||'—'}</td>
        <td><span class="badge ${u.role==='adm'?'badge-ok':'badge-waiting'}">${u.role==='adm'?'Administrador':'Usuário'}</span></td>
        <td style="color:var(--muted);font-size:11px;">${u.criadoEm?new Date(u.criadoEm).toLocaleDateString('pt-BR'):'—'}</td>
        <td>${isMe?'<span style="color:var(--muted);font-size:11px;">(você)</span>':`<button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;" onclick="alterarRoleUsuario('${u.id}','${u.role==='adm'?'user':'adm'}')">${u.role==='adm'?'→ Usuário':'→ Admin'}</button>`}</td>
      </tr>`;
    });
  } catch(e) { if(ld) ld.style.display='none'; toast('Erro ao carregar usuários.','error'); }
}

async function alterarRoleUsuario(uid, novoRole) {
  if (!confirm(`Alterar perfil para "${novoRole==='adm'?'Administrador':'Usuário Comum'}"?`)) return;
  try {
    await window._firebase.setDoc(window._firebase.doc(window._firebase.firestore, 'users', uid),
      { role: novoRole }, { merge: true });
    toast('Perfil alterado!'); renderUsuarios();
  } catch(e) { toast('Erro ao alterar perfil.','error'); }
}

// kept above in auth block

function iniciarApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').classList.add('logged');
  // User chip
  const av = document.getElementById('avatar-chip');
  av.textContent = currentUser.nome.slice(0,2).toUpperCase();
  av.className = 'user-avatar ' + (currentUser.role === 'adm' ? 'avatar-adm' : 'avatar-user');
  document.getElementById('username-chip').textContent = currentUser.nome;
  document.getElementById('role-chip').textContent = currentUser.role === 'adm' ? 'Administrador' : 'Usuário';
  buildNav();
  iniciarListenerNotifs(); // inicia listener em tempo real de notificações
  iniciarListenerRequisicoes(); // inicia listener em tempo real de requisições
  updateStorageInfo();
  // Navigate to first page
  if (currentUser.role === 'adm') {
    navigateTo('dash');
  } else {
    navigateTo('requisicoes');
  }
}

// ===========================
// NAVIGATION
// ===========================
const NAV_ADM = [
  { label:'GERAL', type:'label' },
  { id:'dash', icon:'grid', label:'Dashboard' },
  { id:'compras', icon:'cart', label:'Planejamento de Compras' },
  { type:'sep' },
  { label:'ESTOQUE', type:'label' },
  { id:'cadastrar-estoque', icon:'box', label:'Cadastrar Estoque' },
  { id:'cadastrar-material', icon:'plus-circle', label:'Cadastrar Material' },
  { id:'entrada', icon:'arrow-down', label:'Entrada de Materiais' },
  { id:'saida', icon:'arrow-up', label:'Saída de Materiais' },
  { id:'transferencia', icon:'arrows', label:'Transferência' },
  { id:'analise', icon:'chart', label:'Análise de Estoques' },
  { type:'sep' },
  { label:'REQUISIÇÕES', type:'label' },
  { id:'atendimento', icon:'check-circle', label:'Atendimento' },
  { type:'sep' },
  { id:'usuarios', icon:'users', label:'Gerenciar Usuários' },
  { id:'backup', icon:'cloud', label:'Backup & Restauração' },
  { id:'relatorios', icon:'document', label:'Relatórios' },
  { type:'sep' },
  { id:'auditoria', icon:'audit', label:'Auditoria & Logs' },
];
const NAV_USER = [
  { id:'requisicoes', icon:'clipboard', label:'Requisições' },
];

const ICONS = {
  grid:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>',
  cart:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>',
  box:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>',
  'plus-circle':'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/>',
  'arrow-down':'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 12l-4-4m4 4l4-4m6 0v12m0 0l4-4m-4 4l-4-4"/>',
  'arrow-up':'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>',
  arrows:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>',
  chart:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>',
  'check-circle':'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>',
  cloud:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>',
  users:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>',
  clipboard:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>',
  document:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>',
  audit:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>',
};

function buildNav() {
  const menu = document.getElementById('nav-menu');
  const items = currentUser.role === 'adm' ? NAV_ADM : NAV_USER;
  menu.innerHTML = '';
  items.forEach(item => {
    if (item.type === 'sep') { menu.innerHTML += '<div class="nav-sep"></div>'; return; }
    if (item.type === 'label') { menu.innerHTML += `<div class="nav-label">${item.label}</div>`; return; }
    const icon = ICONS[item.icon] || '';
    menu.innerHTML += `<div class="nav-item" id="nav-${item.id}" onclick="navigateTo('${item.id}')">
      <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">${icon}</svg>${item.label}
    </div>`;
  });
}

function navigateTo(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const pg = document.getElementById('page-' + page);
  if (!pg) return;
  pg.classList.add('active');
  const ni = document.getElementById('nav-' + page);
  if (ni) ni.classList.add('active');
  closeSidebar();

  if (page === 'dash') renderDash();
  if (page === 'compras') renderCompras();
  if (page === 'entrada') { populateSel('ent-material', db.materiais); populateSel('ent-estoque', db.estoques); renderEntradas(); }
  if (page === 'saida') { populateSel('sai-estoque', db.estoques); renderSaidas(); setTimeout(()=>{const r=document.getElementById('sai-resp');if(r&&!r.value&&currentUser)r.value=currentUser.nome;},50); }
  if (page === 'analise') { populateSel('analise-estoque', db.estoques); }
  if (page === 'transferencia') { iniciarTransferencia(); renderTransferencias(); }
  if (page === 'backup') { atualizarPreviewBackup(); renderSnapshots(); }
  if (page === 'usuarios') renderUsuarios();
  if (page === 'requisicoes') { popularSelectEstoqueReq(); renderMinhasReq(); }
  if (page === 'atendimento') renderAtendimento();
  if (page === 'cadastrar-material') renderMateriais();
  if (page === 'cadastrar-estoque') renderEstoques();
  if (page === 'relatorios') iniciarRelatorios();
  if (page === 'auditoria') renderAuditoria();
}

// ===========================
// MOBILE SIDEBAR
// ===========================
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebar-overlay').classList.toggle('open');
  document.getElementById('sidebar-close').style.display =
    document.getElementById('sidebar').classList.contains('open') ? 'block' : 'none';
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('open');
}

// ===========================
// HELPERS
// ===========================
function toast(msg, type='ok') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = type === 'error' ? 'error show' : 'show';
  setTimeout(() => t.className = '', 3000);
}
function populateSel(id, arr) {
  const s = document.getElementById(id); if(!s) return;
  const v = s.value;
  s.innerHTML = '<option value="">Selecione...</option>';
  arr.forEach(i => s.innerHTML += `<option value="${i.id}">${i.nome}</option>`);
  s.value = v;
}
function getStatus(qtd, min, max) {
  if (min === null && max === null) return { label:'Sem Ref.', cls:'badge-noref' };
  if (max !== null && qtd > max) return { label:'Acima do Máx', cls:'badge-over' };
  if (min !== null && qtd <= min) return { label:'Crítico', cls:'badge-critical' };
  return { label:'Normal', cls:'badge-ok' };
}
function fecharModal(id) { document.getElementById(id).classList.remove('open'); }
function abrirModal(id) { document.getElementById(id).classList.add('open'); }

// close modal on backdrop
document.querySelectorAll('.modal').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});

// ===========================
// STORAGE INFO
// ===========================
function updateStorageInfo() {
  try {
    const total = (db.itens||[]).length + (db.materiais||[]).length + (db.estoques||[]).length;
    const el = document.getElementById('storage-info');
    if (el) el.textContent = `${total} registros sincronizados`;
  } catch(e) {}
}

// ===========================
// ESTOQUES
// ===========================
async function salvarEstoque() {
  const nome = document.getElementById('es-nome').value.trim();
  if (!nome) return toast('Informe o nome.','error');
  const principal = document.getElementById('es-principal').checked;
  const updates = [];
  if (principal) {
    db.estoques.forEach(e => { if(e.principal){ e.principal=false; updates.push(e); } });
  }
  const novo = { id:uid(), nome, desc:document.getElementById('es-desc').value.trim(), local:document.getElementById('es-local').value.trim(), principal };
  db.estoques.push(novo);
  ['es-nome','es-desc','es-local'].forEach(i => document.getElementById(i).value='');
  document.getElementById('es-principal').checked = false;
  renderEstoques();
  try {
    await saveItem('estoques', novo);
    for (const e of updates) await saveItem('estoques', e);
    toast('Estoque cadastrado!');
  } catch(e) { toast('Erro ao salvar estoque.','error'); }
}
function renderEstoques() {
  const tb = document.getElementById('estoques-tbody');
  const em = document.getElementById('estoques-empty');
  if (!tb) return; tb.innerHTML = '';
  if (!db.estoques.length) { em.style.display='block'; return; } em.style.display='none';
  db.estoques.forEach(e => {
    tb.innerHTML += `<tr>
      <td><strong>${e.nome}</strong><br><span style="color:var(--muted);font-size:11px;">${e.desc||''}</span></td>
      <td style="color:var(--muted);font-size:12px;">${e.local||'—'}</td>
      <td>${e.principal ? '<span class="badge badge-ok">Principal</span>' : ''}</td>
      <td style="display:flex;gap:6px;">
        <button class="btn btn-secondary" style="padding:3px 9px;font-size:11px;" onclick="togglePrincipal('${e.id}')">⭐</button>
        <button class="btn btn-danger" style="padding:3px 9px;font-size:11px;" onclick="delEstoque('${e.id}')">✕</button>
      </td>
    </tr>`;
  });
}
async function delEstoque(id) {
  if (!confirm('Remover estoque?')) return;
  const _delEst=db.estoques.find(e=>e.id===id);
  logAudit('estoque', `Estoque removido: ${_delEst?_delEst.nome:'?'}`, `ID: ${id}`);
  const itensDel = db.itens.filter(i => i.estoqueId===id).map(i=>i.id);
  db.estoques = db.estoques.filter(e => e.id!==id);
  db.itens = db.itens.filter(i => i.estoqueId!==id);
  renderEstoques();
  try {
    await deleteItem('estoques', id);
    await deleteItemsBatch('itens', itensDel);
    toast('Removido.');
  } catch(e) { toast('Erro ao remover.','error'); }
}
async function togglePrincipal(id) {
  const updates = [];
  db.estoques.forEach(e => { e.principal = e.id === id; updates.push(e); });
  renderEstoques();
  try { await saveItemsBatch('estoques', updates); toast('Estoque principal definido!'); }
  catch(e) { toast('Erro ao salvar.','error'); }
}

// ===========================
// MATERIAIS
// ===========================
async function salvarMaterial() {
  const nome = document.getElementById('mat-nome').value.trim();
  if (!nome) return toast('Informe o nome.','error');
  const min = document.getElementById('mat-min').value;
  const max = document.getElementById('mat-max').value;
  const dias = document.getElementById('mat-dias').value;
  const novo = { id:uid(), nome, cat:document.getElementById('mat-cat').value.trim(), unidade:document.getElementById('mat-unidade').value.trim(), min:min!==''?+min:null, max:max!==''?+max:null, diasChegada:dias!==''?+dias:null };
  db.materiais.push(novo);
  ['mat-nome','mat-cat','mat-unidade','mat-min','mat-max','mat-dias'].forEach(i => document.getElementById(i).value='');
  renderMateriais();
  try { await saveItem('materiais', novo); toast('Material cadastrado!'); }
  catch(e) { toast('Erro ao salvar material.','error'); }
}
function renderMateriais() {
  const tb = document.getElementById('materiais-tbody');
  const em = document.getElementById('materiais-empty');
  if (!tb) return; tb.innerHTML = '';
  if (!db.materiais.length) { em.style.display='block'; return; } em.style.display='none';
  db.materiais.forEach(m => {
    tb.innerHTML += `<tr>
      <td><strong>${m.nome}</strong></td>
      <td style="color:var(--muted)">${m.cat||'—'}</td>
      <td style="color:var(--muted)">${m.unidade||'—'}</td>
      <td>${m.min!==null?m.min:'—'}</td>
      <td>${m.max!==null?m.max:'—'}</td>
      <td>${m.diasChegada!==null&&m.diasChegada!==undefined?m.diasChegada+'d':'—'}</td>
      <td style="display:flex;gap:5px;flex-wrap:wrap;">
        <button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;" onclick="abrirEditarMaterial('${m.id}')">Editar</button>
        <button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;border-color:rgba(0,229,160,.3);color:var(--accent);" onclick="copiarMaterial('${m.id}')">⎘</button>
        <button class="btn btn-danger" style="padding:3px 8px;font-size:11px;" onclick="delMaterial('${m.id}')">✕</button>
      </td>
    </tr>`;
  });
}
async function delMaterial(id) {
  if (!confirm('Remover?')) return;
  const itensDel = db.itens.filter(i => i.materialId===id).map(i=>i.id);
  const _delMat=db.materiais.find(m=>m.id===id);
  logAudit('material', `Material removido: ${_delMat?_delMat.nome:'?'}`, `ID: ${id}`);
  db.materiais = db.materiais.filter(m => m.id!==id);
  db.itens = db.itens.filter(i => i.materialId!==id);
  renderMateriais();
  try {
    await deleteItem('materiais', id);
    await deleteItemsBatch('itens', itensDel);
    toast('Removido.');
  } catch(e) { toast('Erro ao remover.','error'); }
}
function copiarMaterial(id) {
  const m = db.materiais.find(m => m.id===id); if (!m) return;
  document.getElementById('mat-nome').value = m.nome+' (Cópia)';
  document.getElementById('mat-cat').value = m.cat||'';
  document.getElementById('mat-unidade').value = m.unidade||'';
  document.getElementById('mat-min').value = m.min!==null?m.min:'';
  document.getElementById('mat-max').value = m.max!==null?m.max:'';
  document.getElementById('mat-dias').value = m.diasChegada!==null&&m.diasChegada!==undefined?m.diasChegada:'';
  const form = document.getElementById('mat-nome').closest('.card');
  form.style.transition='box-shadow .3s'; form.style.boxShadow='0 0 0 2px var(--accent)';
  setTimeout(() => form.style.boxShadow='', 1800);
  document.getElementById('mat-nome').focus();
  toast('Dados copiados para o formulário!');
}
function abrirEditarMaterial(id) {
  const m = db.materiais.find(m => m.id===id); if (!m) return;
  document.getElementById('edit-mat-id').value=id;
  document.getElementById('edit-mat-nome').value=m.nome;
  document.getElementById('edit-mat-cat').value=m.cat||'';
  document.getElementById('edit-mat-unidade').value=m.unidade||'';
  document.getElementById('edit-mat-min').value=m.min!==null?m.min:'';
  document.getElementById('edit-mat-max').value=m.max!==null?m.max:'';
  document.getElementById('edit-mat-dias').value=m.diasChegada!==null&&m.diasChegada!==undefined?m.diasChegada:'';
  abrirModal('modal-material');
}
async function salvarEdicaoMaterial() {
  const id=document.getElementById('edit-mat-id').value;
  const nome=document.getElementById('edit-mat-nome').value.trim();
  if (!nome) return toast('Informe o nome.','error');
  const min=document.getElementById('edit-mat-min').value;
  const max=document.getElementById('edit-mat-max').value;
  const dias=document.getElementById('edit-mat-dias').value;
  const m=db.materiais.find(m=>m.id===id); if (!m) return;
  m.nome=nome; m.cat=document.getElementById('edit-mat-cat').value.trim();
  m.unidade=document.getElementById('edit-mat-unidade').value.trim();
  m.min=min!==''?+min:null; m.max=max!==''?+max:null;
  m.diasChegada=dias!==''?+dias:null;
  logAudit('material', `Material editado: ${m.nome}`, `Cat: ${m.cat||'—'} | Min: ${m.min??'—'} | Max: ${m.max??'—'}`);
  fecharModal('modal-material'); renderMateriais();
  try { await saveItem('materiais', m); toast('Material atualizado!'); }
  catch(e) { toast('Erro ao atualizar.','error'); }
}

// ===========================
// ENTRADA
// ===========================
function toggleLote() {
  const sem=document.getElementById('ent-semlote').checked;
  document.getElementById('ent-lote-group').style.opacity=sem?.4:1;
  document.getElementById('ent-lote').disabled=sem;
  if(sem) document.getElementById('ent-lote').value='';
}
async function registrarEntrada() {
  const matId=document.getElementById('ent-material').value;
  const estId=document.getElementById('ent-estoque').value;
  const sem=document.getElementById('ent-semlote').checked;
  const lote=document.getElementById('ent-lote').value.trim();
  const qtd=+document.getElementById('ent-qtd').value;
  const val=document.getElementById('ent-val').value;
  const obs=document.getElementById('ent-obs').value.trim();
  if (!matId) return toast('Selecione o material.','error');
  if (!estId) return toast('Selecione o estoque.','error');
  if (!sem && !lote) return toast('Informe o lote.','error');
  if (!qtd||qtd<=0) return toast('Quantidade inválida.','error');
  const loteVal=sem?'SEM LOTE':lote;
  let item=db.itens.find(i=>i.materialId===matId&&i.estoqueId===estId&&i.lote===loteVal);
  const mesclou=!!item;
  if (item) { item.qtd+=qtd; if(val)item.validade=val; }
  else { item={id:uid(),materialId:matId,estoqueId:estId,lote:loteVal,qtd,validade:val,obs}; db.itens.push(item); }
  const mat=db.materiais.find(m=>m.id===matId);
  const est=db.estoques.find(e=>e.id===estId);
  const entrada={id:uid(),materialId:matId,estoqueId:estId,materialNome:mat.nome,estoqueNome:est.nome,lote:loteVal,qtd,validade:val,obs,data:new Date().toISOString()};
  db.entradas.unshift(entrada);
  ['ent-qtd','ent-val','ent-lote','ent-obs'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('ent-semlote').checked=false; toggleLote(); renderEntradas();
  toast(mesclou?`Lote "${loteVal}" somado! Total: ${item.qtd}`:`Entrada de ${qtd} ${mat.nome} registrada!`);
  logAudit('entrada', mesclou?`Lote "${loteVal}" somado (+${qtd})`:`Entrada de ${qtd}x ${mat.nome}`, `Lote: ${loteVal} | Estoque: ${est.nome} | Qtd: +${qtd}`);
  try {
    await saveItem('itens', item);
    await saveItem('entradas', entrada);
  } catch(e) { toast('Erro ao salvar entrada.','error'); console.error(e); }
}
function renderEntradas() {
  const tb=document.getElementById('entradas-tbody');
  const em=document.getElementById('entradas-empty');
  if(!tb)return; tb.innerHTML='';
  if(!db.entradas.length){em.style.display='block';return;} em.style.display='none';
  db.entradas.slice(0,20).forEach(e=>{
    tb.innerHTML+=`<tr>
      <td><strong>${e.materialNome}</strong></td>
      <td style="color:var(--muted)">${e.estoqueNome}</td>
      <td><span style="font-size:11px;background:rgba(0,229,160,.1);color:var(--accent);padding:2px 7px;border-radius:4px;">${e.lote}</span></td>
      <td><strong style="color:var(--accent)">+${e.qtd}</strong></td>
      <td style="color:var(--muted)">${fmt(e.validade)}</td>
      <td style="color:var(--muted);font-size:11px;">${fmt(e.data)}</td>
      <td><button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;" onclick="abrirEditarEntrada('${e.id}')">Editar</button></td>
    </tr>`;
  });
}

// ===========================
// SAÍDA
// ===========================
function carregarItensSaida() {
  const estId=document.getElementById('sai-estoque').value;
  const sel=document.getElementById('sai-item');
  sel.innerHTML='<option value="">Selecione o item...</option>';
  if(!estId)return;
  db.itens.filter(i=>i.estoqueId===estId&&i.qtd>0).forEach(i=>{
    const mat=db.materiais.find(m=>m.id===i.materialId);
    sel.innerHTML+=`<option value="${i.id}">${mat?mat.nome:'?'} — ${i.lote} (${i.qtd})</option>`;
  });
}
async function registrarSaida() {
  const estId=document.getElementById('sai-estoque').value;
  const itemId=document.getElementById('sai-item').value;
  const qtd=+document.getElementById('sai-qtd').value;
  const motivo=document.getElementById('sai-motivo').value.trim();
  const resp=document.getElementById('sai-resp').value.trim();
  if(!estId)return toast('Selecione o estoque.','error');
  if(!itemId)return toast('Selecione o item.','error');
  if(!qtd||qtd<=0)return toast('Quantidade inválida.','error');
  const item=db.itens.find(i=>i.id===itemId); if(!item)return;
  if(qtd>item.qtd)return toast(`Insuficiente. Disponível: ${item.qtd}`,'error');
  item.qtd-=qtd;
  const mat=db.materiais.find(m=>m.id===item.materialId);
  const est=db.estoques.find(e=>e.id===estId);
  const saida={id:uid(),materialNome:mat?mat.nome:'?',estoqueNome:est?est.nome:'?',lote:item.lote,qtd,motivo,resp,data:new Date().toISOString()};
  db.saidas.unshift(saida);
  ['sai-qtd','sai-motivo','sai-resp'].forEach(i=>document.getElementById(i).value='');
  if(currentUser){const sr=document.getElementById('sai-resp');if(sr)sr.value=currentUser.nome;}
  carregarItensSaida(); renderSaidas();
  logAudit('saida', `Saída de ${qtd}x ${mat?mat.nome:'?'}`, `Lote: ${item.lote} | Estoque: ${est?est.nome:'?'} | Qtd: -${qtd}${motivo?' | Motivo: '+motivo:''}${resp?' | Resp: '+resp:''}`);
  toast(`Saída de ${qtd} registrada!`);
  try {
    await saveItem('itens', item);
    await saveItem('saidas', saida);
  } catch(e) { toast('Erro ao salvar saída.','error'); console.error(e); }
}
function renderSaidas() {
  const tb=document.getElementById('saidas-tbody');
  const em=document.getElementById('saidas-empty');
  if(!tb)return; tb.innerHTML='';
  if(!db.saidas.length){em.style.display='block';return;} em.style.display='none';
  db.saidas.slice(0,20).forEach(s=>{
    tb.innerHTML+=`<tr>
      <td><strong>${s.materialNome}</strong></td>
      <td style="color:var(--muted)">${s.estoqueNome}</td>
      <td><span style="font-size:11px;background:rgba(255,59,92,.1);color:var(--danger);padding:2px 7px;border-radius:4px;">${s.lote}</span></td>
      <td><strong style="color:var(--danger)">-${s.qtd}</strong></td>
      <td style="color:var(--muted)">${s.motivo||'—'}</td>
      <td style="color:var(--muted);font-size:11px;">${fmt(s.data)}</td>
    </tr>`;
  });
}

// ===========================
// ANÁLISE
// ===========================
function carregarAnalise() {
  const estId=document.getElementById('analise-estoque').value;
  const card=document.getElementById('analise-card'), empty=document.getElementById('analise-empty'),
    placeholder=document.getElementById('analise-placeholder'), summary=document.getElementById('analise-summary'),
    filtros=document.getElementById('analise-filtros');
  if(!estId){card.style.display='none';empty.style.display='none';summary.style.display='none';placeholder.style.display='block';filtros.style.display='none';analiseItensCache=[];return;}
  placeholder.style.display='none';
  const est=db.estoques.find(e=>e.id===estId);
  const itens=db.itens.filter(i=>i.estoqueId===estId);
  if(!itens.length){card.style.display='none';empty.style.display='block';summary.style.display='none';filtros.style.display='none';analiseItensCache=[];return;}
  analiseItensCache=itens.map(item=>{
    const mat=db.materiais.find(m=>m.id===item.materialId);
    const nome=mat?mat.nome:'?'; const cat=mat?(mat.cat||''):'';
    const min=mat?mat.min:null; const max=mat?mat.max:null;
    const st=getStatus(item.qtd,min,max);
    const hoje=new Date(); hoje.setHours(0,0,0,0);
    const valDate=item.validade?new Date(item.validade):null;
    const vencido=valDate&&valDate<hoje;
    const dias=valDate?Math.ceil((valDate-hoje)/86400000):null;
    return {item,mat,nome,cat,min,max,st,vencido,valDate,dias};
  });
  const cats=[...new Set(analiseItensCache.map(r=>r.cat).filter(Boolean))].sort();
  const selCat=document.getElementById('filtro-cat'); const prevCat=selCat.value;
  selCat.innerHTML='<option value="">Todas as cats</option>';
  cats.forEach(c=>selCat.innerHTML+=`<option value="${c}">${c}</option>`);
  if(cats.includes(prevCat))selCat.value=prevCat;
  document.getElementById('analise-title').textContent=`Itens — ${est.nome}`;
  filtros.style.display='block'; card.style.display='block'; empty.style.display='none';
  let ok=0,crit=0,over=0,noref=0;
  analiseItensCache.forEach(r=>{if(r.st.cls==='badge-ok')ok++;else if(r.st.cls==='badge-critical')crit++;else if(r.st.cls==='badge-over')over++;else noref++;});
  summary.style.display='block';
  document.getElementById('analise-stats').innerHTML=`
    <div class="stat-card green" style="cursor:pointer;" onclick="document.getElementById('filtro-status').value='';aplicarFiltros()"><div style="color:var(--muted);font-size:11px;font-family:'Syne',sans-serif;font-weight:700;letter-spacing:.5px">NORMAL</div><div style="font-size:26px;font-family:'Syne',sans-serif;font-weight:800;margin-top:4px;color:var(--accent)">${ok}</div></div>
    <div class="stat-card danger" style="cursor:pointer;" onclick="document.getElementById('filtro-status').value='badge-critical';aplicarFiltros()"><div style="color:var(--muted);font-size:11px;font-family:'Syne',sans-serif;font-weight:700;letter-spacing:.5px">CRÍTICO</div><div style="font-size:26px;font-family:'Syne',sans-serif;font-weight:800;margin-top:4px;color:var(--danger)">${crit}</div></div>
    <div class="stat-card blue" style="cursor:pointer;" onclick="document.getElementById('filtro-status').value='badge-over';aplicarFiltros()"><div style="color:var(--muted);font-size:11px;font-family:'Syne',sans-serif;font-weight:700;letter-spacing:.5px">ACIMA</div><div style="font-size:26px;font-family:'Syne',sans-serif;font-weight:800;margin-top:4px;color:#5599ff">${over}</div></div>
    <div class="stat-card" style="cursor:pointer;" onclick="document.getElementById('filtro-status').value='badge-noref';aplicarFiltros()"><div style="color:var(--muted);font-size:11px;font-family:'Syne',sans-serif;font-weight:700;letter-spacing:.5px">SEM REF.</div><div style="font-size:26px;font-family:'Syne',sans-serif;font-weight:800;margin-top:4px;color:var(--muted)">${noref}</div></div>`;
  aplicarFiltros();
}
function limparFiltros(){['filtro-nome','filtro-cat','filtro-status','filtro-validade'].forEach(i=>document.getElementById(i).value='');document.getElementById('filtro-ordem').value='nome-asc';aplicarFiltros();}
function aplicarFiltros() {
  const busca=document.getElementById('filtro-nome').value.trim().toLowerCase();
  const cat=document.getElementById('filtro-cat').value;
  const status=document.getElementById('filtro-status').value;
  const valid=document.getElementById('filtro-validade').value;
  const ordem=document.getElementById('filtro-ordem').value;
  const hoje=new Date(); hoje.setHours(0,0,0,0);
  let res=analiseItensCache.filter(r=>{
    if(busca&&!r.nome.toLowerCase().includes(busca)&&!r.item.lote.toLowerCase().includes(busca))return false;
    if(cat&&r.cat!==cat)return false;
    if(status&&r.st.cls!==status)return false;
    if(valid){if(valid==='vencido'&&!(r.valDate&&r.valDate<hoje))return false;if(valid==='30dias'&&!(r.valDate&&r.dias>=0&&r.dias<=30))return false;if(valid==='60dias'&&!(r.valDate&&r.dias>=0&&r.dias<=60))return false;if(valid==='ok'&&!(r.valDate&&r.dias>0))return false;if(valid==='sem'&&r.valDate)return false;}
    return true;
  });
  res.sort((a,b)=>{switch(ordem){case'nome-asc':return a.nome.localeCompare(b.nome);case'nome-desc':return b.nome.localeCompare(a.nome);case'qtd-asc':return a.item.qtd-b.item.qtd;case'qtd-desc':return b.item.qtd-a.item.qtd;case'val-asc':if(!a.valDate&&!b.valDate)return 0;if(!a.valDate)return 1;if(!b.valDate)return-1;return a.valDate-b.valDate;default:return 0;}});
  const tb=document.getElementById('analise-tbody'); const nf=document.getElementById('analise-nenhum-filtro'); const ctr=document.getElementById('filtro-contador');
  tb.innerHTML='';
  const total=analiseItensCache.length,filtrado=res.length;
  ctr.style.display='block';
  ctr.innerHTML=filtrado<total?`Mostrando <strong style="color:var(--text)">${filtrado}</strong> de <strong style="color:var(--text)">${total}</strong> itens`:`<strong style="color:var(--text)">${total}</strong> itens`;
  if(!res.length){nf.style.display='block';return;} nf.style.display='none';
  res.forEach(({item,mat,nome,min,max,st,vencido,dias})=>{
    let vs=fmt(item.validade),vstyle='color:var(--muted)',vex='';
    if(!item.validade)vs='—';
    else if(vencido){vstyle='color:var(--danger);font-weight:600;';vex=' <span style="font-size:10px;background:rgba(255,59,92,.15);color:var(--danger);padding:1px 5px;border-radius:3px;">VENCIDO</span>';}
    else if(dias!==null&&dias<=30){vstyle='color:var(--warn);font-weight:600;';vex=` <span style="font-size:10px;background:rgba(255,149,0,.15);color:var(--warn);padding:1px 5px;border-radius:3px;">${dias}d</span>`;}
    tb.innerHTML+=`<tr>
      <td><strong>${nome}</strong>${mat&&mat.cat?`<br><span style="font-size:11px;color:var(--muted)">${mat.cat}</span>`:''}</td>
      <td><span style="font-size:11px;background:rgba(255,255,255,.06);padding:2px 7px;border-radius:4px;">${item.lote}</span></td>
      <td><strong>${item.qtd}</strong>${mat&&mat.unidade?` <span style="color:var(--muted);font-size:11px;">${mat.unidade}</span>`:''}</td>
      <td style="${vstyle}">${vs}${vex}</td>
      <td style="color:var(--muted)">${min!==null?min:'—'}</td>
      <td style="color:var(--muted)">${max!==null?max:'—'}</td>
      <td><span class="badge ${st.cls}">${st.label}</span></td>
      <td><button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;" onclick="abrirEditarItem('${item.id}')">Editar</button></td>
    </tr>`;
  });
}

// ===========================
// PLANEJAMENTO DE COMPRAS
// ===========================
function renderCompras() {
  const busca=(document.getElementById('compras-busca')?.value||'').trim().toLowerCase();
  const filtro=document.getElementById('compras-filtro')?.value||'';
  const hoje=new Date(); hoje.setHours(0,0,0,0);

  const rows = db.materiais.map(m => {
    const itens=db.itens.filter(i=>i.materialId===m.id);
    const qtdTotal=itens.reduce((s,i)=>s+i.qtd,0);
    // Consumo médio: saídas dos últimos 30 dias
    const limite=new Date(hoje); limite.setDate(limite.getDate()-30);
    const saidasRecentes=db.saidas.filter(s=>{const mat=db.itens.find(i=>i.lote===s.lote);return s.materialNome===m.nome&&new Date(s.data)>=limite;});
    const consumo30=saidasRecentes.reduce((s,x)=>s+x.qtd,0);
    const consumoDiario=consumo30>0?consumo30/30:null;
    const leadTime=m.diasChegada!==null&&m.diasChegada!==undefined?m.diasChegada:null;
    const min=m.min;
    let diasEstoque=null, dataPedido=null, situacao='sem-ref', situacaoLabel='Sem Referência', situacaoCls='badge-noref';
    if(consumoDiario&&consumoDiario>0&&leadTime!==null&&min!==null){
      diasEstoque=Math.floor((qtdTotal-min)/consumoDiario);
      const diasParaPedir=diasEstoque-leadTime;
      dataPedido=new Date(hoje); dataPedido.setDate(dataPedido.getDate()+Math.max(0,diasParaPedir));
      if(diasParaPedir<=0){situacao='urgente';situacaoLabel='URGENTE';situacaoCls='badge-critical';}
      else if(diasParaPedir<=7){situacao='breve';situacaoLabel='Breve';situacaoCls='badge-warn';}
      else{situacao='ok';situacaoLabel='No Prazo';situacaoCls='badge-ok';}
    } else if(leadTime===null||min===null){
      situacao='sem-ref';
    }
    return {m,qtdTotal,consumoDiario,leadTime,diasEstoque,dataPedido,situacao,situacaoLabel,situacaoCls,min};
  });

  const filtered=rows.filter(r=>{
    if(busca&&!r.m.nome.toLowerCase().includes(busca))return false;
    if(filtro&&r.situacao!==filtro)return false;
    return true;
  });
  filtered.sort((a,b)=>{
    const order={urgente:0,breve:1,ok:2,'sem-ref':3};
    return (order[a.situacao]??3)-(order[b.situacao]??3);
  });

  const tb=document.getElementById('compras-tbody');
  const em=document.getElementById('compras-empty');
  tb.innerHTML='';
  if(!filtered.length){em.style.display='block';return;} em.style.display='none';
  filtered.forEach(({m,qtdTotal,consumoDiario,leadTime,diasEstoque,dataPedido,situacao,situacaoLabel,situacaoCls,min})=>{
    const rowCls=situacao==='urgente'?'purchase-urgent':situacao==='breve'?'purchase-soon':'';
    const dataStr=dataPedido?dataPedido.toLocaleDateString('pt-BR'):'—';
    const hoje2=new Date(); hoje2.setHours(0,0,0,0);
    const isHoje=dataPedido&&dataPedido<=hoje2;
    tb.innerHTML+=`<tr class="${rowCls}">
      <td><strong>${m.nome}</strong>${m.cat?`<br><span style="font-size:11px;color:var(--muted)">${m.cat}</span>`:''}</td>
      <td><strong>${qtdTotal}</strong>${m.unidade?` <span style="color:var(--muted);font-size:11px;">${m.unidade}</span>`:''}</td>
      <td>${min!==null?min:'—'}</td>
      <td>${leadTime!==null?leadTime+'d':'<span style="color:var(--muted)">N/D</span>'}</td>
      <td>${consumoDiario?consumoDiario.toFixed(2)+'/dia':'<span style="color:var(--muted)">Sem histórico</span>'}</td>
      <td>${diasEstoque!==null?`${diasEstoque}d`:'<span style="color:var(--muted)">—</span>'}</td>
      <td style="${isHoje?'color:var(--danger);font-weight:700;':'color:var(--text);'}">${dataStr}</td>
      <td><span class="badge ${situacaoCls}">${situacaoLabel}</span></td>
    </tr>`;
  });
}

// ===========================
// DASHBOARD
// ===========================
function filtrarDashTabela() {
  const busca=(document.getElementById('dash-filtro-nome')?.value||'').trim().toLowerCase();
  const status=document.getElementById('dash-filtro-status')?.value||'';
  const cat=document.getElementById('dash-filtro-cat')?.value||'';
  let res=dashMatCache.filter(r=>{
    if(busca&&!r.m.nome.toLowerCase().includes(busca)&&!(r.m.cat||'').toLowerCase().includes(busca))return false;
    if(status&&r.st.cls!==status)return false;
    if(cat&&(r.m.cat||'')!==cat)return false;
    return true;
  });
  const tb=document.getElementById('dash-tbody');
  const sem=document.getElementById('dash-sem-resultado');
  const ctr=document.getElementById('dash-filtro-contador');
  tb.innerHTML='';
  const total=dashMatCache.length,filtrado=res.length;
  if(busca||status||cat){ctr.style.display='block';ctr.innerHTML=filtrado<total?`Mostrando <strong style="color:var(--text)">${filtrado}</strong> de <strong>${total}</strong>`:`<strong>${total}</strong> materiais`;}else{ctr.style.display='none';}
  if(!res.length){sem.style.display='block';return;} sem.style.display='none';
  res.forEach(({m,qtdTotal,estoqueNomes,st})=>{
    tb.innerHTML+=`<tr>
      <td><strong>${m.nome}</strong>${m.cat?`<br><span style="color:var(--muted);font-size:11px;">${m.cat}</span>`:''}</td>
      <td><strong style="font-size:16px;font-family:'Syne',sans-serif;">${qtdTotal}</strong>${m.unidade?` <span style="color:var(--muted);font-size:11px;">${m.unidade}</span>`:''}</td>
      <td style="color:var(--muted);font-size:12px;">${estoqueNomes.join(', ')||'—'}</td>
      <td style="color:var(--muted)">${m.min!==null?m.min:'—'}</td>
      <td style="color:var(--muted)">${m.max!==null?m.max:'—'}</td>
      <td style="color:var(--muted)">${m.diasChegada!==null&&m.diasChegada!==undefined?m.diasChegada+'d':'—'}</td>
      <td><span class="badge ${st.cls}">${st.label}</span></td>
    </tr>`;
  });
}
function limparFiltrosDash(){['dash-filtro-nome','dash-filtro-status','dash-filtro-cat'].forEach(i=>{const el=document.getElementById(i);if(el)el.value='';});filtrarDashTabela();}
function renderDash() {
  const matTotals={};
  db.itens.forEach(item=>{if(!matTotals[item.materialId])matTotals[item.materialId]=0;matTotals[item.materialId]+=Number(item.qtd)||0;});
  const totalItens=db.itens.reduce((s,i)=>s+(Number(i.qtd)||0),0);

  // Formata número: inteiro com separador de milhar, ou decimal com até 2 casas
  function fmtNum(n){
    if(!Number.isFinite(n)) return '0';
    const arredondado = Math.round(n * 100) / 100; // máx 2 casas decimais
    return arredondado % 1 === 0
      ? arredondado.toLocaleString('pt-BR')          // ex: 1.234
      : arredondado.toLocaleString('pt-BR', {minimumFractionDigits:1, maximumFractionDigits:2}); // ex: 1.234,5
  }

  // Tamanho de fonte adaptativo baseado no comprimento do número
  function fontSize(n){
    const s = fmtNum(n);
    if(s.length <= 5)  return '30px';
    if(s.length <= 8)  return '26px';
    if(s.length <= 11) return '22px';
    return '18px';
  }

  let criticos=0;
  db.materiais.forEach(m=>{const q=matTotals[m.id]||0;const st=getStatus(q,m.min,m.max);if(st.cls==='badge-critical')criticos++;});
  const reqPendentes=db.requisicoes.filter(r=>r.status==='pendente').length;
  document.getElementById('dash-stats').innerHTML=`
    <div class="stat-card green"><div style="color:var(--muted);font-size:11px;font-family:'Syne',sans-serif;font-weight:700;letter-spacing:.5px;text-transform:uppercase">Total em Estoque</div><div style="font-size:${fontSize(totalItens)};font-family:'Syne',sans-serif;font-weight:800;margin-top:6px;color:var(--accent);line-height:1.1;word-break:break-all;">${fmtNum(totalItens)}</div></div>
    <div class="stat-card blue"><div style="color:var(--muted);font-size:11px;font-family:'Syne',sans-serif;font-weight:700;letter-spacing:.5px;text-transform:uppercase">Materiais</div><div style="font-size:30px;font-family:'Syne',sans-serif;font-weight:800;margin-top:6px;color:#5599ff">${db.materiais.length}</div></div>
    <div class="stat-card danger"><div style="color:var(--muted);font-size:11px;font-family:'Syne',sans-serif;font-weight:700;letter-spacing:.5px;text-transform:uppercase">Críticos</div><div style="font-size:30px;font-family:'Syne',sans-serif;font-weight:800;margin-top:6px;color:var(--danger)">${criticos}</div></div>
    <div class="stat-card warn"><div style="color:var(--muted);font-size:11px;font-family:'Syne',sans-serif;font-weight:700;letter-spacing:.5px;text-transform:uppercase">Req. Pendentes</div><div style="font-size:30px;font-family:'Syne',sans-serif;font-weight:800;margin-top:6px;color:var(--warn)">${reqPendentes}</div></div>`;
  dashMatCache=db.materiais.map(m=>{
    const qtdTotal=matTotals[m.id]||0;
    const estoqueNomes=[...new Set(db.itens.filter(i=>i.materialId===m.id&&i.qtd>0).map(i=>{const e=db.estoques.find(e=>e.id===i.estoqueId);return e?e.nome:'?'}))];
    const st=getStatus(qtdTotal,m.min,m.max);
    return{m,qtdTotal,estoqueNomes,st};
  });
  const cats=[...new Set(db.materiais.map(m=>m.cat).filter(Boolean))].sort();
  const selCat=document.getElementById('dash-filtro-cat');
  if(selCat){const prev=selCat.value;selCat.innerHTML='<option value="">Todas cats</option>';cats.forEach(c=>selCat.innerHTML+=`<option value="${c}">${c}</option>`);if(cats.includes(prev))selCat.value=prev;}
  filtrarDashTabela();
  renderCharts(matTotals);
}
function renderCharts(matTotals){
  let ok=0,crit=0,over=0,noref=0;
  db.materiais.forEach(m=>{const q=matTotals[m.id]||0;const st=getStatus(q,m.min,m.max);if(st.cls==='badge-ok')ok++;else if(st.cls==='badge-critical')crit++;else if(st.cls==='badge-over')over++;else noref++;});
  const ctxS=document.getElementById('chartStatus');
  if(ctxS){if(chartStatus)chartStatus.destroy();chartStatus=new Chart(ctxS,{type:'doughnut',data:{labels:['Normal','Crítico','Acima','Sem Ref.'],datasets:[{data:[ok,crit,over,noref],backgroundColor:['#00e5a0','#ff3b5c','#5599ff','#4b5563'],borderWidth:0}]},options:{plugins:{legend:{labels:{color:'#9ca3af',font:{family:'DM Sans'}}}},cutout:'65%'}});}
  const top=db.materiais.map(m=>({nome:m.nome,qtd:matTotals[m.id]||0})).sort((a,b)=>b.qtd-a.qtd).slice(0,8);
  const ctxT=document.getElementById('chartTop');
  if(ctxT){if(chartTop)chartTop.destroy();chartTop=new Chart(ctxT,{type:'bar',data:{labels:top.map(t=>t.nome),datasets:[{data:top.map(t=>t.qtd),backgroundColor:'rgba(0,229,160,0.7)',borderRadius:6,borderSkipped:false}]},options:{indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#6b7280'}},y:{grid:{display:false},ticks:{color:'#9ca3af',font:{family:'DM Sans'}}}}}});}
}

// ===========================
// EDITAR ENTRADA
// ===========================
function abrirEditarEntrada(entId){
  const ent=db.entradas.find(e=>e.id===entId); if(!ent)return;
  const item=db.itens.find(i=>i.materialId===ent.materialId&&i.estoqueId===ent.estoqueId&&i.lote===ent.lote);
  document.getElementById('edit-ent-id').value=entId;
  document.getElementById('edit-ent-item-id').value=item?item.id:'';
  document.getElementById('edit-ent-material-nome').value=ent.materialNome;
  document.getElementById('edit-ent-estoque-nome').value=ent.estoqueNome;
  const sem=ent.lote==='SEM LOTE';
  document.getElementById('edit-ent-semlote').checked=sem;
  document.getElementById('edit-ent-lote').value=sem?'':ent.lote;
  document.getElementById('edit-ent-lote').disabled=sem;
  document.getElementById('edit-ent-lote-group').style.opacity=sem?.4:1;
  document.getElementById('edit-ent-qtd').value=ent.qtd;
  document.getElementById('edit-ent-val').value=ent.validade||'';
  document.getElementById('edit-ent-obs').value=ent.obs||'';
  abrirModal('modal-entrada');
}
function toggleEditLote(){const sem=document.getElementById('edit-ent-semlote').checked;document.getElementById('edit-ent-lote-group').style.opacity=sem?.4:1;document.getElementById('edit-ent-lote').disabled=sem;if(sem)document.getElementById('edit-ent-lote').value='';}
async function salvarEdicaoEntrada(){
  const entId=document.getElementById('edit-ent-id').value;
  const itemId=document.getElementById('edit-ent-item-id').value;
  const sem=document.getElementById('edit-ent-semlote').checked;
  const lote=document.getElementById('edit-ent-lote').value.trim();
  const qtd=+document.getElementById('edit-ent-qtd').value;
  const val=document.getElementById('edit-ent-val').value;
  const obs=document.getElementById('edit-ent-obs').value.trim();
  if(!sem&&!lote)return toast('Informe o lote.','error');
  if(!qtd||qtd<=0)return toast('Quantidade inválida.','error');
  const loteVal=sem?'SEM LOTE':lote;
  const ent=db.entradas.find(e=>e.id===entId); if(!ent)return;
  const diff=qtd-ent.qtd;
  ent.lote=loteVal;ent.qtd=qtd;ent.validade=val;ent.obs=obs;
  let item=null;
  if(itemId){item=db.itens.find(i=>i.id===itemId);if(item){item.lote=loteVal;item.qtd=Math.max(0,item.qtd+diff);if(val)item.validade=val;}}
  fecharModal('modal-entrada'); renderEntradas();
  try {
    await saveItem('entradas', ent);
    if(item) await saveItem('itens', item);
    toast('Entrada atualizada!');
  } catch(e) { toast('Erro ao atualizar.','error'); }
}

// ===========================
// EDITAR ITEM
// ===========================
function abrirEditarItem(itemId){
  const item=db.itens.find(i=>i.id===itemId); if(!item)return;
  const mat=db.materiais.find(m=>m.id===item.materialId);
  const est=db.estoques.find(e=>e.id===item.estoqueId);
  document.getElementById('edit-item-id').value=itemId;
  document.getElementById('edit-item-material').value=mat?mat.nome:'?';
  document.getElementById('edit-item-estoque').value=est?est.nome:'?';
  const sem=item.lote==='SEM LOTE';
  document.getElementById('edit-item-semlote').checked=sem;
  document.getElementById('edit-item-lote').value=sem?'':item.lote;
  document.getElementById('edit-item-lote').disabled=sem;
  document.getElementById('edit-item-lote-group').style.opacity=sem?.4:1;
  document.getElementById('edit-item-qtd').value=item.qtd;
  document.getElementById('edit-item-val').value=item.validade||'';
  document.getElementById('edit-item-obs').value=item.obs||'';
  const st=getStatus(item.qtd,mat?mat.min:null,mat?mat.max:null);
  document.getElementById('edit-item-info').innerHTML=`<span class="badge ${st.cls}">${st.label}</span>&nbsp; Qtd atual: <strong>${item.qtd}</strong>&nbsp;·&nbsp; Lote: <strong>${item.lote}</strong>`;
  abrirModal('modal-item');
}
function toggleEditItemLote(){const sem=document.getElementById('edit-item-semlote').checked;document.getElementById('edit-item-lote-group').style.opacity=sem?.4:1;document.getElementById('edit-item-lote').disabled=sem;if(sem)document.getElementById('edit-item-lote').value='';}
async function salvarEdicaoItem(){
  const itemId=document.getElementById('edit-item-id').value;
  const sem=document.getElementById('edit-item-semlote').checked;
  const lote=document.getElementById('edit-item-lote').value.trim();
  const qtd=+document.getElementById('edit-item-qtd').value;
  const val=document.getElementById('edit-item-val').value;
  const obs=document.getElementById('edit-item-obs').value.trim();
  if(!sem&&!lote)return toast('Informe o lote.','error');
  if(isNaN(qtd)||qtd<0)return toast('Quantidade inválida.','error');
  const item=db.itens.find(i=>i.id===itemId); if(!item)return;
  const loteVal=sem?'SEM LOTE':lote;
  if(loteVal!==item.lote){
    const dup=db.itens.find(i=>i.id!==itemId&&i.materialId===item.materialId&&i.estoqueId===item.estoqueId&&i.lote===loteVal);
    if(dup){
      dup.qtd+=qtd;if(val)dup.validade=val;
      db.itens=db.itens.filter(i=>i.id!==itemId);
      fecharModal('modal-item'); carregarAnalise();
      try {
        await saveItem('itens', dup);
        await deleteItem('itens', itemId);
        toast(`Lote mesclado! Total: ${dup.qtd}`);
      } catch(e) { toast('Erro ao mesclar.','error'); }
      return;
    }
  }
  item.lote=loteVal;item.qtd=qtd;item.validade=val;item.obs=obs;
  fecharModal('modal-item'); carregarAnalise();
  try { await saveItem('itens', item); toast('Item atualizado!'); }
  catch(e) { toast('Erro ao atualizar.','error'); }
}

// ===========================
// TRANSFERÊNCIA
// ===========================
function iniciarTransferencia(){populateSel('trf-est-origem',db.estoques);populateSel('trf-est-destino',db.estoques);document.getElementById('trf-item').innerHTML='<option value="">Selecione o estoque primeiro...</option>';document.getElementById('trf-info-item').style.display='none';['trf-qtd','trf-motivo','trf-resp','trf-novo-lote'].forEach(i=>document.getElementById(i).value='');if(currentUser){const tr=document.getElementById('trf-resp');if(tr)tr.value=currentUser.nome;}document.getElementById('trf-lote-manter').checked=true;document.getElementById('trf-novo-lote-group').style.display='none';}
function carregarItensTransf(){const estId=document.getElementById('trf-est-origem').value;const sel=document.getElementById('trf-item');sel.innerHTML='<option value="">Selecione o item...</option>';if(!estId)return;const itens=db.itens.filter(i=>i.estoqueId===estId&&i.qtd>0);if(!itens.length){sel.innerHTML='<option value="">Nenhum item disponível</option>';return;}itens.forEach(i=>{const mat=db.materiais.find(m=>m.id===i.materialId);sel.innerHTML+=`<option value="${i.id}">${mat?mat.nome:'?'} — ${i.lote} (${i.qtd})</option>`;});}
function preencherInfoTransf(){const itemId=document.getElementById('trf-item').value;const info=document.getElementById('trf-info-item');if(!itemId){info.style.display='none';return;}const item=db.itens.find(i=>i.id===itemId);if(!item){info.style.display='none';return;}const mat=db.materiais.find(m=>m.id===item.materialId);const st=getStatus(item.qtd,mat?mat.min:null,mat?mat.max:null);info.style.display='block';info.innerHTML=`<div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;"><div><span style="color:var(--muted)">Disponível:</span> <strong>${item.qtd}</strong></div><div><span style="color:var(--muted)">Lote:</span> <strong>${item.lote}</strong></div>${item.validade?`<div><span style="color:var(--muted)">Validade:</span> <strong>${fmt(item.validade)}</strong></div>`:''}<span class="badge ${st.cls}">${st.label}</span></div>`;}
function toggleTrfLote(){const modo=document.querySelector('input[name="trf-lote-modo"]:checked').value;document.getElementById('trf-novo-lote-group').style.display=modo==='novo'?'block':'none';}
async function registrarTransferencia(){
  const estOrigId=document.getElementById('trf-est-origem').value;
  const estDestId=document.getElementById('trf-est-destino').value;
  const itemId=document.getElementById('trf-item').value;
  const qtd=+document.getElementById('trf-qtd').value;
  const motivo=document.getElementById('trf-motivo').value.trim();
  const resp=document.getElementById('trf-resp').value.trim();
  const loteMode=document.querySelector('input[name="trf-lote-modo"]:checked').value;
  const novoLote=document.getElementById('trf-novo-lote').value.trim();
  if(!estOrigId)return toast('Selecione a origem.','error');
  if(!estDestId)return toast('Selecione o destino.','error');
  if(estOrigId===estDestId)return toast('Origem e destino iguais.','error');
  if(!itemId)return toast('Selecione o item.','error');
  if(!qtd||qtd<=0)return toast('Quantidade inválida.','error');
  if(loteMode==='novo'&&!novoLote)return toast('Informe o novo lote.','error');
  const itemOrig=db.itens.find(i=>i.id===itemId); if(!itemOrig)return;
  if(qtd>itemOrig.qtd)return toast(`Insuficiente. Disponível: ${itemOrig.qtd}`,'error');
  const mat=db.materiais.find(m=>m.id===itemOrig.materialId);
  const estOrig=db.estoques.find(e=>e.id===estOrigId);
  const estDest=db.estoques.find(e=>e.id===estDestId);
  const loteDest=loteMode==='manter'?itemOrig.lote:novoLote;
  itemOrig.qtd-=qtd;
  let itemDest=db.itens.find(i=>i.materialId===itemOrig.materialId&&i.estoqueId===estDestId&&i.lote===loteDest);
  const isNewItemDest=!itemDest;
  if(itemDest){itemDest.qtd+=qtd;if(itemOrig.validade)itemDest.validade=itemOrig.validade;}
  else{itemDest={id:uid(),materialId:itemOrig.materialId,estoqueId:estDestId,lote:loteDest,qtd,validade:itemOrig.validade,obs:itemOrig.obs};db.itens.push(itemDest);}
  if(!db.transferencias)db.transferencias=[];
  const trf={id:uid(),materialNome:mat?mat.nome:'?',loteOrigem:itemOrig.lote,loteDestino:loteDest,estOrigNome:estOrig?estOrig.nome:'?',estDestNome:estDest?estDest.nome:'?',qtd,motivo,resp,data:new Date().toISOString()};
  db.transferencias.unshift(trf);
  renderTransferencias(); carregarItensTransf();
  document.getElementById('trf-info-item').style.display='none';
  document.getElementById('trf-qtd').value='';
  logAudit('transferencia', `Transferência de ${qtd}x ${mat?mat.nome:'?'}`, `De: ${estOrig?estOrig.nome:'?'} → Para: ${estDest?estDest.nome:'?'} | Lote: ${itemOrig.lote}${resp?' | Resp: '+resp:''}`);
  toast(`${qtd} ${mat?mat.nome:''} transferidos para ${estDest?estDest.nome:'?'}!`);
  try {
    await saveItem('itens', itemOrig);
    await saveItem('itens', itemDest);
    await saveItem('transferencias', trf);
  } catch(e) { toast('Erro ao salvar transferência.','error'); console.error(e); }
}
function renderTransferencias(){
  if(!db.transferencias)db.transferencias=[];
  const tb=document.getElementById('transf-tbody');
  const em=document.getElementById('transf-empty');
  if(!tb)return; tb.innerHTML='';
  if(!db.transferencias.length){em.style.display='block';return;} em.style.display='none';
  db.transferencias.slice(0,30).forEach(t=>{
    const mesmoLote=t.loteOrigem===t.loteDestino;
    tb.innerHTML+=`<tr>
      <td><strong>${t.materialNome}</strong><br><span style="font-size:11px;color:var(--muted)">${mesmoLote?t.loteOrigem:t.loteOrigem+' → '+t.loteDestino}</span></td>
      <td style="color:var(--muted)">${t.estOrigNome}</td>
      <td style="color:var(--accent);font-weight:600;">${t.estDestNome}</td>
      <td><strong style="color:var(--accent)">⇄ ${t.qtd}</strong></td>
      <td style="color:var(--muted);font-size:12px;">${t.resp||'—'}</td>
      <td style="color:var(--muted);font-size:11px;">${fmt(t.data)}</td>
    </tr>`;
  });
}

// ===========================
// REQUISIÇÕES
// ===========================
function getEstoquePrincipal(){
  return db.estoques.find(e=>e.principal) || db.estoques[0] || null;
}
function popularSelectEstoqueReq(){
  const selEst=document.getElementById('req-estoque');
  if(!selEst)return;
  selEst.innerHTML='<option value="">Selecione...</option>';
  const estPrincipal=getEstoquePrincipal();
  if(estPrincipal){
    selEst.innerHTML+=`<option value="${estPrincipal.id}">${estPrincipal.nome} (Principal)</option>`;
    selEst.value=estPrincipal.id;
  }
  carregarMateraisReq();
}
function carregarMateraisReq(){
  const selEst=document.getElementById('req-estoque');
  const estoqueId=selEst?selEst.value:'';
  const sel=document.getElementById('req-material');
  if(!sel)return;
  document.getElementById('req-lote').innerHTML='<option value="">Selecione o material primeiro...</option>';
  document.getElementById('req-info-lote').style.display='none';
  if(!estoqueId){sel.innerHTML='<option value="">Selecione o estoque primeiro...</option>';return;}
  const matIds=[...new Set(db.itens.filter(i=>i.estoqueId===estoqueId&&i.qtd>0).map(i=>i.materialId))];
  if(!matIds.length){sel.innerHTML='<option value="">Nenhum material disponível</option>';return;}
  sel.innerHTML='<option value="">Selecione o material...</option>';
  matIds.forEach(id=>{const mat=db.materiais.find(m=>m.id===id);if(mat)sel.innerHTML+=`<option value="${id}">${mat.nome}</option>`;});
}
function carregarLotesReq(){
  const matId=document.getElementById('req-material').value;
  const estoqueId=document.getElementById('req-estoque')?document.getElementById('req-estoque').value:'';
  const sel=document.getElementById('req-lote');
  const info=document.getElementById('req-info-lote');
  sel.innerHTML='<option value="">Selecione o lote...</option>';
  info.style.display='none';
  if(!matId||!estoqueId)return;
  const estPrincipal=db.estoques.find(e=>e.id===estoqueId)||getEstoquePrincipal();
  if(!estPrincipal)return;
  const itens=db.itens.filter(i=>i.materialId===matId&&i.estoqueId===estPrincipal.id&&i.qtd>0);
  itens.forEach(i=>{const qtdDisp=Number.isInteger(i.qtd)?i.qtd:Math.round(i.qtd*100)/100;sel.innerHTML+=`<option value="${i.id}">${i.lote==='SEM LOTE'?'Sem Lote':i.lote} — ${qtdDisp} disp.${i.validade?' | Val:'+fmt(i.validade):''}</option>`;});
  sel.onchange=()=>{
    const itemId=sel.value;
    if(!itemId){info.style.display='none';return;}
    const item=db.itens.find(i=>i.id===itemId);
    if(!item){info.style.display='none';return;}
    info.style.display='block';
    info.innerHTML=`Disponível: <strong style="color:var(--text)">${Number.isInteger(item.qtd)?item.qtd:Math.round(item.qtd*100)/100}</strong> | Lote: <strong style="color:var(--text)">${item.lote}</strong>${item.validade?` | Validade: <strong style="color:var(--text)">${fmt(item.validade)}</strong>`:''}`;
  };
}
async function registrarRequisicao(){
  const matId=document.getElementById('req-material').value;
  const itemId=document.getElementById('req-lote').value;
  const setor=document.getElementById('req-setor').value;
  const qtd=+document.getElementById('req-qtd').value;
  const justif=document.getElementById('req-justif').value.trim();
  const estoqueSelId=document.getElementById('req-estoque')?document.getElementById('req-estoque').value:'';
  if(!estoqueSelId)return toast('Selecione o estoque.','error');
  if(!matId)return toast('Selecione o material.','error');
  if(!itemId)return toast('Selecione o lote.','error');
  if(!setor)return toast('Selecione o setor.','error');
  if(!qtd||qtd<=0)return toast('Quantidade inválida.','error');
  const item=db.itens.find(i=>i.id===itemId);
  if(!item)return toast('Item não encontrado.','error');
  if(qtd>item.qtd)return toast(`Insuficiente. Disponível: ${item.qtd}`,'error');
  const mat=db.materiais.find(m=>m.id===matId);
  const estReq=db.estoques.find(e=>e.id===estoqueSelId)||getEstoquePrincipal();
  const req={id:uid(),materialId:matId,itemId,materialNome:mat?mat.nome:'?',estoqueNome:estReq?estReq.nome:'?',lote:item.lote,setor,qtd,justif,status:'pendente',motivo:'',solicitanteId:currentUser.id,solicitanteNome:currentUser.nome,data:new Date().toISOString()};
  db.requisicoes.unshift(req);
  ['req-qtd','req-justif'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('req-material').value='';
  document.getElementById('req-lote').innerHTML='<option value="">Selecione o material primeiro...</option>';
  document.getElementById('req-setor').value='';
  document.getElementById('req-info-lote').style.display='none';
  popularSelectEstoqueReq();
  renderMinhasReq();
  // Notificação para o admin
  adicionarNotif('adm',`📋 Nova requisição de ${currentUser.nome}: ${qtd}x ${mat?mat.nome:''} para ${setor}`,'pendente',req.id);
  try {
    logAudit('requisicao', `Requisição enviada: ${req.qtd}x ${req.materialNome}`, `Estoque: ${req.estoqueNome} | Setor: ${req.setor}`);
    await saveItem('requisicoes', req);
    toast('Requisição enviada!');
  } catch(e) {
    toast('Erro ao salvar requisição.','error');
    console.error('Erro ao salvar requisição:', e);
    // Remove da memória se falhou
    db.requisicoes = db.requisicoes.filter(r => r.id !== req.id);
    renderMinhasReq();
  }
}
function renderMinhasReq(){
  if(!currentUser)return;
  const minhas=db.requisicoes.filter(r=>r.solicitanteId===currentUser.id);
  // Desktop table
  const tb=document.getElementById('minhas-req-tbody');
  const em=document.getElementById('minhas-req-empty');
  if(tb){tb.innerHTML='';if(!minhas.length){em.style.display='block';}else{em.style.display='none';minhas.forEach(r=>{tb.innerHTML+=`<tr>
      <td><strong>${r.materialNome}</strong></td>
      <td><span style="font-size:11px;background:rgba(255,255,255,.06);padding:2px 7px;border-radius:4px;">${r.lote}</span></td>
      <td style="color:var(--muted)">${r.setor}</td>
      <td><strong>${r.qtd}</strong>${r.qtdAtendida&&r.qtdAtendida!==r.qtd?`<br><span style="font-size:10px;color:var(--accent)">✓ ${r.qtdAtendida} atend.</span>`:''}</td>
      <td><span class="badge ${reqBadgeCls(r.status)}">${reqLabel(r.status)}</span></td>
      <td style="color:var(--muted);font-size:12px;max-width:180px;">${r.motivo||'—'}</td>
      <td style="color:var(--muted);font-size:11px;">${fmt(r.data)}</td>
    </tr>`;});}}
  // Mobile cards
  const cards=document.getElementById('minhas-req-cards');
  if(cards){cards.innerHTML='';minhas.forEach(r=>{cards.innerHTML+=`<div class="req-card">
    <div class="req-card-header"><strong>${r.materialNome}</strong><span class="badge ${reqBadgeCls(r.status)}">${reqLabel(r.status)}</span></div>
    <div style="font-size:12px;color:var(--muted);line-height:1.9;">
      Lote: <span style="color:var(--text)">${r.lote}</span><br>
      Solicitado: <strong style="color:var(--text)">${r.qtd}</strong>${r.qtdAtendida&&r.qtdAtendida!==r.qtd?` · Atendido: <strong style="color:var(--accent)">${r.qtdAtendida}</strong>`:''}
      <br>Setor: ${r.setor} &nbsp;·&nbsp; ${fmt(r.data)}<br>
      ${r.motivo?`<span style="color:var(--warn)">📌 ${r.motivo}</span>`:''}
    </div>
  </div>`;});}
}
function reqBadgeCls(s){return{pendente:'badge-pending',atendida:'badge-attended',aguardo:'badge-waiting',negada:'badge-denied'}[s]||'badge-noref';}
function reqLabel(s){return{pendente:'Pendente',atendida:'Atendida',aguardo:'Em Aguardo',negada:'Negada'}[s]||s;}

// ===========================
// ATENDIMENTO DE REQUISIÇÕES
// ===========================
function renderAtendimento(){
  const filtroStatus=document.getElementById('atend-filtro-status')?.value||'';
  const filtroSetor=document.getElementById('atend-filtro-setor')?.value||'';
  const busca=(document.getElementById('atend-busca')?.value||'').trim().toLowerCase();
  let reqs=db.requisicoes.filter(r=>{
    if(filtroStatus&&r.status!==filtroStatus)return false;
    if(filtroSetor&&r.setor!==filtroSetor)return false;
    if(busca&&!r.materialNome.toLowerCase().includes(busca)&&!r.solicitanteNome.toLowerCase().includes(busca))return false;
    return true;
  });
  const ctr=document.getElementById('atend-contador');
  if(ctr)ctr.textContent=`${reqs.length} requisição(ões)`;
  // Desktop
  const tb=document.getElementById('atendimento-tbody');
  const em=document.getElementById('atendimento-empty');
  if(tb){tb.innerHTML='';if(!reqs.length){em.style.display='block';}else{em.style.display='none';reqs.forEach(r=>{const isPending=r.status==='pendente';tb.innerHTML+=`<tr>
      <td><strong>${r.materialNome}</strong><br><span style="color:var(--muted);font-size:11px;">${r.solicitanteNome}</span></td>
      <td><span style="font-size:11px;background:rgba(255,255,255,.06);padding:2px 7px;border-radius:4px;">${r.lote}</span></td>
      <td style="color:var(--muted)">${r.setor}</td>
      <td style="color:var(--muted)">${r.solicitanteNome}</td>
      <td><strong>${r.qtd}</strong></td>
      <td style="color:var(--muted);font-size:12px;max-width:140px;">${r.justif||'—'}</td>
      <td style="color:var(--muted);font-size:11px;">${fmt(r.data)}</td>
      <td><span class="badge ${reqBadgeCls(r.status)}">${reqLabel(r.status)}</span>${r.motivo?`<br><span style="font-size:10px;color:var(--muted)">${r.motivo.slice(0,30)}...</span>`:''}</td>
      <td style="display:flex;gap:4px;flex-wrap:wrap;">
        ${(isPending||r.status==='aguardo')?`<button class="btn btn-primary" style="padding:3px 8px;font-size:11px;" onclick="abrirAcaoReq('${r.id}','atender')">Atender</button>
        ${isPending?`<button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;color:var(--warn);border-color:rgba(255,149,0,.3);" onclick="abrirAcaoReq('${r.id}','aguardo')">Aguardo</button>`:''}
        <button class="btn btn-danger" style="padding:3px 8px;font-size:11px;" onclick="abrirAcaoReq('${r.id}','negar')">Negar</button>`:'<span style="color:var(--muted);font-size:11px;">—</span>'}
      </td>
    </tr>`;});}}
  // Mobile
  const cards=document.getElementById('atendimento-cards');
  if(cards){cards.innerHTML='';reqs.forEach(r=>{const isPending=r.status==='pendente';cards.innerHTML+=`<div class="req-card">
    <div class="req-card-header"><div><strong>${r.materialNome}</strong><br><span style="font-size:11px;color:var(--muted)">${r.solicitanteNome} · ${r.setor}</span></div><span class="badge ${reqBadgeCls(r.status)}">${reqLabel(r.status)}</span></div>
    <div style="font-size:12px;color:var(--muted);line-height:1.8;margin-bottom:10px;">
      Lote: <span style="color:var(--text)">${r.lote}</span> · Qtd: <strong style="color:var(--text)">${r.qtd}</strong>${r.qtdAtendida&&r.qtdAtendida!==r.qtd?` <span style="color:var(--accent);font-size:11px;">(atend: ${r.qtdAtendida})</span>`:''}<br>
      ${r.justif?`Justif: ${r.justif}<br>`:''}${fmt(r.data)}
      ${r.motivo?`<br><span style="color:var(--warn)">Obs: ${r.motivo}</span>`:''}
    </div>
    ${(isPending||r.status==='aguardo')?`<div style="display:flex;gap:6px;flex-wrap:wrap;">
      <button class="btn btn-primary" style="padding:6px 12px;font-size:12px;flex:1;" onclick="abrirAcaoReq('${r.id}','atender')">Atender</button>
      ${isPending?`<button class="btn btn-secondary" style="padding:6px 12px;font-size:12px;flex:1;color:var(--warn);" onclick="abrirAcaoReq('${r.id}','aguardo')">Aguardo</button>`:''}
      <button class="btn btn-danger" style="padding:6px 12px;font-size:12px;flex:1;" onclick="abrirAcaoReq('${r.id}','negar')">Negar</button>
    </div>`:''}
  </div>`;});}
}

function abrirAcaoReq(reqId, acao){
  const req=db.requisicoes.find(r=>r.id===reqId); if(!req)return;
  document.getElementById('modal-atender-id').value=reqId;
  document.getElementById('modal-atender-acao').value=acao;
  document.getElementById('modal-atender-qtd-original').value=req.qtd;
  const titles={atender:'Atender Requisição',aguardo:'Colocar em Aguardo',negar:'Negar Requisição'};
  const btns={atender:'Confirmar Atendimento',aguardo:'Confirmar Aguardo',negar:'Confirmar Negação'};
  const btnCls={atender:'btn-primary',aguardo:'btn-warn',negar:'btn-danger'};
  document.getElementById('modal-atender-title').innerHTML=titles[acao]+` <button class="modal-close" onclick="fecharModal('modal-atender')">✕</button>`;
  document.getElementById('modal-atender-info').innerHTML=`
    <div style="line-height:1.8;font-size:13px;">
      <strong>${req.materialNome}</strong> — Lote: ${req.lote}<br>
      Solicitante: ${req.solicitanteNome} · Setor: ${req.setor}<br>
      Quantidade solicitada: <strong style="color:var(--text)">${req.qtd}</strong> · ${fmt(req.data)}
      ${req.justif?`<br>Justificativa: ${req.justif}`:''}
      ${req.status==='aguardo'?`<br><span style="color:var(--warn);">⏳ Em aguardo: ${req.motivo||''}</span>`:''}
    </div>`;
  const motivoGroup=document.getElementById('modal-atender-motivo-group');
  const motivoLabel=document.getElementById('modal-atender-motivo-label');
  const qtdGroup=document.getElementById('modal-atender-qtd-group');
  const qtdInput=document.getElementById('modal-atender-qtd');
  const qtdHint=document.getElementById('modal-atender-qtd-hint');
  document.getElementById('modal-atender-motivo').value='';
  if(acao==='atender'){
    qtdGroup.style.display='block';
    qtdInput.value=req.qtd;
    qtdInput.max=req.qtd;
    qtdHint.textContent=`(máx: ${req.qtd} solicitado)`;
    motivoGroup.style.display='none';
    motivoLabel.textContent='Motivo (quantidade diferente) *';
  } else {
    qtdGroup.style.display='none';
    motivoGroup.style.display='block';
    motivoLabel.textContent=acao==='aguardo'?'Motivo do aguardo *':'Motivo da negação *';
  }
  const btn=document.getElementById('modal-atender-btn');
  btn.textContent=btns[acao];
  btn.className='btn '+btnCls[acao];
  btn.style.flex='2';
  abrirModal('modal-atender');
}
function verificarQtdDiferente(){
  const qtdOriginal=+document.getElementById('modal-atender-qtd-original').value;
  const qtdAtender=+document.getElementById('modal-atender-qtd').value;
  const motivoGroup=document.getElementById('modal-atender-motivo-group');
  const motivoLabel=document.getElementById('modal-atender-motivo-label');
  if(qtdAtender>0 && qtdAtender!==qtdOriginal){
    motivoGroup.style.display='block';
    motivoLabel.textContent=`Motivo (qtd alterada de ${qtdOriginal} para ${qtdAtender}) *`;
  } else {
    motivoGroup.style.display='none';
    document.getElementById('modal-atender-motivo').value='';
  }
}

async function confirmarAcaoReq(){
  const reqId=document.getElementById('modal-atender-id').value;
  const acao=document.getElementById('modal-atender-acao').value;
  const motivo=document.getElementById('modal-atender-motivo').value.trim();
  const req=db.requisicoes.find(r=>r.id===reqId); if(!req)return;
  if((acao==='aguardo'||acao==='negar')&&!motivo)return toast('Informe o motivo.','error');
  const itemsToSave = [];
  if(acao==='atender'){
    const qtdAtender=+document.getElementById('modal-atender-qtd').value;
    const qtdOriginal=+document.getElementById('modal-atender-qtd-original').value;
    if(!qtdAtender||qtdAtender<=0)return toast('Informe a quantidade a atender.','error');
    if(qtdAtender!==qtdOriginal&&!motivo)return toast('Informe o motivo da alteração de quantidade.','error');
    const item=db.itens.find(i=>i.id===req.itemId);
    if(item){
      if(qtdAtender>item.qtd){toast(`Estoque insuficiente! Disponível: ${item.qtd}`,'error');return;}
      item.qtd-=qtdAtender;
      itemsToSave.push({col:'itens',item});
      const saida={id:uid(),materialNome:req.materialNome,estoqueNome:req.estoqueNome,lote:req.lote,qtd:qtdAtender,motivo:`Requisição #${reqId.slice(-6)} — ${req.setor}`,resp:currentUser.nome,data:new Date().toISOString()};
      db.saidas.unshift(saida);
      itemsToSave.push({col:'saidas',item:saida});
    }
    const qtdAnterior=req.qtd;
    req.qtdAtendida=qtdAtender; req.status='atendida'; req.motivo=motivo||'';
    if(qtdAtender!==qtdAnterior){
      adicionarNotif(req.solicitanteId,`✅ Sua requisição de ${req.materialNome} foi ATENDIDA com quantidade alterada: solicitado ${qtdAnterior}, atendido ${qtdAtender}. Motivo: ${motivo}`,'atendida',reqId);
    } else {
      adicionarNotif(req.solicitanteId,`✅ Sua requisição de ${qtdAtender}x ${req.materialNome} foi ATENDIDA!`,'atendida',reqId);
    }
    toast('Requisição atendida e estoque baixado!');
  } else if(acao==='aguardo'){
    req.status='aguardo'; req.motivo=motivo;
    adicionarNotif(req.solicitanteId,`⏳ Sua requisição de ${req.qtd}x ${req.materialNome} está EM AGUARDO. Motivo: ${motivo}`,'aguardo',reqId);
    toast('Requisição colocada em aguardo.');
  } else if(acao==='negar'){
    req.status='negada'; req.motivo=motivo;
    adicionarNotif(req.solicitanteId,`❌ Sua requisição de ${req.qtd}x ${req.materialNome} foi NEGADA. Motivo: ${motivo}`,'negada',reqId);
    toast('Requisição negada.');
  }
  logAudit('atendimento', `Requisição ${acao==='atender'?'ATENDIDA':acao==='aguardo'?'EM AGUARDO':'NEGADA'}: ${req.materialNome}`, `Qtd: ${acao==='atender'?(document.getElementById('modal-atender-qtd')?.value||req.qtd):req.qtd} | Solicitante: ${req.solicitanteNome}${motivo?' | Motivo: '+motivo:''}`);
  fecharModal('modal-atender'); renderAtendimento();
  try {
    await saveItem('requisicoes', req);
    for (const {col, item} of itemsToSave) await saveItem(col, item);
  } catch(e) { toast('Erro ao salvar atendimento.','error'); console.error(e); }
}

// ===========================
// NOTIFICAÇÕES — FIREBASE REALTIME
// ===========================

// Helper: verifica se uma notificação pertence ao usuário atual
function _ehMinhaNotif(n) {
  if (!currentUser) return false;
  // Admin recebe notifs do próprio uid E as marcadas como 'adm'
  if (currentUser.role === 'adm') return n.userId === currentUser.id || n.userId === 'adm';
  return n.userId === currentUser.id;
}

// Inicia listener em tempo real — usa getDocs com polling como estratégia
// mais robusta sem necessidade de índice composto no Firestore
function iniciarListenerNotifs() {
  if (!currentUser) return;

  // Cancela listener/polling anterior
  if (window._notifUnsubscribe) {
    if (typeof window._notifUnsubscribe === 'function') window._notifUnsubscribe();
    else clearInterval(window._notifUnsubscribe);
    window._notifUnsubscribe = null;
  }

  // Tenta onSnapshot com filtro simples (apenas userId == uid)
  // Notifs de 'adm' são puxadas separadamente
  try {
    const { firestore, collection, onSnapshot, where, query } = window._firebase;

    const snapCallbacks = [];

    // Listener 1: notifs do próprio uid
    const q1 = query(
      collection(firestore, 'stockflow', 'notificacoes', 'items'),
      where('userId', '==', currentUser.id)
    );
    const unsub1 = onSnapshot(q1,
      (snap) => {
        const minhasNotifs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        // Merge com notifs 'adm' já carregadas
        const admNotifs = db.notificacoes.filter(n => n.userId === 'adm');
        db.notificacoes = [...minhasNotifs, ...admNotifs]
          .sort((a,b) => new Date(b.data) - new Date(a.data));
        updateNotifBadge();
        const panel = document.getElementById('notif-panel');
        if (panel && panel.style.display === 'block') renderNotifs();
      },
      (err) => console.warn('[Notifs] listener uid erro:', err.message)
    );
    snapCallbacks.push(unsub1);

    // Listener 2: notifs de 'adm' (apenas para admins)
    if (currentUser.role === 'adm') {
      const q2 = query(
        collection(firestore, 'stockflow', 'notificacoes', 'items'),
        where('userId', '==', 'adm')
      );
      const unsub2 = onSnapshot(q2,
        (snap) => {
          const admNotifs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          const uidNotifs = db.notificacoes.filter(n => n.userId !== 'adm');
          db.notificacoes = [...uidNotifs, ...admNotifs]
            .sort((a,b) => new Date(b.data) - new Date(a.data));
          updateNotifBadge();
          const panel = document.getElementById('notif-panel');
          if (panel && panel.style.display === 'block') renderNotifs();
        },
        (err) => console.warn('[Notifs] listener adm erro:', err.message)
      );
      snapCallbacks.push(unsub2);
    }

    // Função de unsubscribe que cancela todos os listeners
    window._notifUnsubscribe = () => snapCallbacks.forEach(u => u());

  } catch(e) {
    console.warn('[Notifs] onSnapshot indisponível, usando polling:', e.message);
    recarregarNotifs();
    window._notifUnsubscribe = setInterval(() => recarregarNotifs(), 20000);
  }
}

// ===========================
// LISTENER EM TEMPO REAL — REQUISIÇÕES
// ===========================
function iniciarListenerRequisicoes() {
  if (!currentUser) return;

  // Cancela listener anterior se existir
  if (window._reqUnsubscribe) {
    if (typeof window._reqUnsubscribe === 'function') window._reqUnsubscribe();
    else clearInterval(window._reqUnsubscribe);
    window._reqUnsubscribe = null;
  }

  try {
    const { firestore, collection, onSnapshot } = window._firebase;

    const colRef = collection(firestore, 'stockflow', 'requisicoes', 'items');

    const unsub = onSnapshot(colRef,
      (snap) => {
        db.requisicoes = snap.docs.map(d => ({ id: d.id, ...d.data() }))
          .sort((a, b) => new Date(b.data) - new Date(a.data));

        // Atualiza a view ativa que depende de requisicoes
        const pageReq = document.getElementById('page-requisicoes');
        const pageAtend = document.getElementById('page-atendimento');
        const pageDash = document.getElementById('page-dash');

        if (pageReq && pageReq.classList.contains('active')) renderMinhasReq();
        if (pageAtend && pageAtend.classList.contains('active')) renderAtendimento();
        if (pageDash && pageDash.classList.contains('active')) renderDash();

        // Atualiza badge de pendentes no nav se for admin
        if (currentUser && currentUser.role === 'adm') {
          const pendentes = db.requisicoes.filter(r => r.status === 'pendente').length;
          const navAtend = document.getElementById('nav-atendimento');
          if (navAtend) {
            let badge = navAtend.querySelector('.nav-req-badge');
            if (pendentes > 0) {
              if (!badge) {
                badge = document.createElement('span');
                badge.className = 'nav-req-badge';
                badge.style.cssText = 'margin-left:auto;background:var(--danger);color:#fff;border-radius:99px;font-size:10px;font-weight:700;padding:1px 7px;font-family:Syne,sans-serif;';
                navAtend.appendChild(badge);
              }
              badge.textContent = pendentes;
            } else if (badge) {
              badge.remove();
            }
          }
        }
      },
      (err) => {
        console.warn('[Req] onSnapshot erro, usando polling:', err.message);
        // Fallback: polling a cada 15 segundos
        const poll = async () => {
          try {
            const { firestore, collection, getDocs } = window._firebase;
            const snap = await getDocs(collection(firestore, 'stockflow', 'requisicoes', 'items'));
            db.requisicoes = snap.docs.map(d => ({ id: d.id, ...d.data() }))
              .sort((a, b) => new Date(b.data) - new Date(a.data));
            const pageReq = document.getElementById('page-requisicoes');
            const pageAtend = document.getElementById('page-atendimento');
            if (pageReq && pageReq.classList.contains('active')) renderMinhasReq();
            if (pageAtend && pageAtend.classList.contains('active')) renderAtendimento();
          } catch(e) { console.warn('[Req] polling erro:', e); }
        };
        poll();
        window._reqUnsubscribe = setInterval(poll, 15000);
      }
    );

    window._reqUnsubscribe = unsub;

  } catch(e) {
    console.warn('[Req] onSnapshot indisponível, usando polling:', e.message);
    const poll = async () => {
      try {
        const snap = await window._firebase.getDocs(
          window._firebase.collection(window._firebase.firestore, 'stockflow', 'requisicoes', 'items')
        );
        db.requisicoes = snap.docs.map(d => ({ id: d.id, ...d.data() }))
          .sort((a, b) => new Date(b.data) - new Date(a.data));
        const pageReq = document.getElementById('page-requisicoes');
        const pageAtend = document.getElementById('page-atendimento');
        if (pageReq && pageReq.classList.contains('active')) renderMinhasReq();
        if (pageAtend && pageAtend.classList.contains('active')) renderAtendimento();
      } catch(e2) { console.warn('[Req] polling erro:', e2); }
    };
    poll();
    window._reqUnsubscribe = setInterval(poll, 15000);
  }
}

// Recarrega manualmente (fallback de polling)
async function recarregarNotifs() {
  if (!currentUser) return;
  try {
    const { firestore, collection, getDocs, query, where } = window._firebase;
    const col = collection(firestore, 'stockflow', 'notificacoes', 'items');

    // Busca notifs do uid atual
    const snap1 = await getDocs(query(col, where('userId', '==', currentUser.id)));
    const uidNotifs = snap1.docs.map(d => ({ id: d.id, ...d.data() }));

    let admNotifs = [];
    if (currentUser.role === 'adm') {
      const snap2 = await getDocs(query(col, where('userId', '==', 'adm')));
      admNotifs = snap2.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    db.notificacoes = [...uidNotifs, ...admNotifs]
      .sort((a,b) => new Date(b.data) - new Date(a.data));
    updateNotifBadge();
    const panel = document.getElementById('notif-panel');
    if (panel && panel.style.display === 'block') renderNotifs();
  } catch(e) { console.warn('[Notifs] erro ao recarregar:', e); }
}

// Salva notificação no Firestore
// Para notificações de admin: userId = 'adm'
// Para notificações de usuário: userId = uid real
async function adicionarNotif(userId, mensagem, tipo, refId) {
  const notif = {
    id: uid(),
    userId,
    mensagem,
    tipo,
    refId: refId || '',
    lida: false,
    data: new Date().toISOString()
  };
  try {
    await window._firebase.setDoc(
      fsDoc('stockflow', 'notificacoes', 'items', notif.id),
      notif
    );
    // Adiciona à memória local se pertencer ao usuário atual
    if (_ehMinhaNotif(notif)) {
      if (!db.notificacoes) db.notificacoes = [];
      db.notificacoes.unshift(notif);
      if (db.notificacoes.length > 200) db.notificacoes = db.notificacoes.slice(0, 200);
      updateNotifBadge();
    }
  } catch(e) {
    console.error('[Notifs] erro ao salvar:', e);
  }
}

function updateNotifBadge() {
  if (!currentUser) return;
  const naolidas = db.notificacoes.filter(n => _ehMinhaNotif(n) && !n.lida).length;
  const badge  = document.getElementById('notif-badge');
  const badgeM = document.getElementById('notif-badge-m');
  if (badge)  { badge.style.display  = naolidas > 0 ? 'flex' : 'none'; badge.textContent  = naolidas > 9 ? '9+' : naolidas; }
  if (badgeM) { badgeM.style.display = naolidas > 0 ? 'flex' : 'none'; badgeM.textContent = naolidas > 9 ? '9+' : naolidas; }
}

function renderNotifs() {
  if (!currentUser) return;
  const list   = document.getElementById('notif-list');
  const minhas = db.notificacoes.filter(n => _ehMinhaNotif(n));
  if (!minhas.length) {
    list.innerHTML = '<div style="padding:32px;text-align:center;color:var(--muted);font-size:13px;">Nenhuma notificação</div>';
    return;
  }
  const corTipo = { atendida:'var(--accent)', aguardo:'var(--warn)', negada:'var(--danger)', pendente:'var(--accent2)' };
  list.innerHTML = minhas.slice(0, 30).map(n => {
    const cor = corTipo[n.tipo] || 'var(--muted)';
    const borda = n.lida ? '' : `border-left:3px solid ${cor};`;
    return `<div class="notif-item ${n.lida ? '' : 'unread'}" onclick="marcarLida('${n.id}')" style="${borda}">
      <div style="font-size:13px;line-height:1.5;margin-bottom:4px;">${n.mensagem}</div>
      <div style="font-size:11px;color:var(--muted);">${fmtDT(n.data)}</div>
    </div>`;
  }).join('');
}

function toggleNotif() {
  const p = document.getElementById('notif-panel');
  if (p.style.display === 'block') { p.style.display = 'none'; return; }
  recarregarNotifs().then(() => { renderNotifs(); p.style.display = 'block'; });
}

async function marcarLida(id) {
  const n = db.notificacoes.find(x => x.id === id);
  if (!n || n.lida) return;
  n.lida = true;
  updateNotifBadge();
  renderNotifs();
  try {
    await window._firebase.setDoc(
      fsDoc('stockflow', 'notificacoes', 'items', id),
      { lida: true }, { merge: true }
    );
  } catch(e) { console.warn('[Notifs] erro ao marcar lida:', e); }
}

async function marcarTodasLidas() {
  if (!currentUser) return;
  const minhas = db.notificacoes.filter(n => _ehMinhaNotif(n) && !n.lida);
  if (!minhas.length) return;
  minhas.forEach(n => n.lida = true);
  updateNotifBadge();
  renderNotifs();
  try {
    const batch = window._firebase.writeBatch(window._firebase.firestore);
    minhas.forEach(n => batch.set(
      fsDoc('stockflow', 'notificacoes', 'items', n.id),
      { lida: true }, { merge: true }
    ));
    await batch.commit();
  } catch(e) { console.warn('[Notifs] erro ao marcar todas lidas:', e); }
}
// close notif panel on outside click
document.addEventListener('click',e=>{
  const panel=document.getElementById('notif-panel');
  const bell=document.getElementById('notif-bell');
  const bellM=document.getElementById('notif-bell-mobile');
  if(panel&&panel.style.display==='block'&&!panel.contains(e.target)&&!bell?.contains(e.target)&&!bellM?.contains(e.target)){panel.style.display='none';}
});

// ===========================
// BACKUP
// ===========================
function loadSnapshots(){try{return JSON.parse(localStorage.getItem(SNAP_KEY)||'[]');}catch(e){return[];}}
function saveSnapshots(snaps){localStorage.setItem(SNAP_KEY,JSON.stringify(snaps));}
function criarSnapshot(manual=false){
  const snaps=loadSnapshots();
  const agora=new Date();
  snaps.unshift({id:uid(),nome:(manual?'Manual':'Auto')+' — '+agora.toLocaleString('pt-BR'),data:agora.toISOString(),manual,dados:JSON.parse(JSON.stringify(db))});
  if(snaps.length>MAX_SNAPS)snaps.splice(MAX_SNAPS);
  saveSnapshots(snaps); renderSnapshots();
  if(manual)toast('Snapshot criado!');
}
function renderSnapshots(){
  const snaps=loadSnapshots();
  const tb=document.getElementById('snapshots-tbody');
  const em=document.getElementById('snapshots-empty');
  if(!tb)return; tb.innerHTML='';
  if(!snaps.length){em.style.display='block';return;} em.style.display='none';
  snaps.forEach(s=>{
    const d=s.dados; const kb=(new Blob([JSON.stringify(d)]).size/1024).toFixed(1);
    tb.innerHTML+=`<tr>
      <td><strong style="font-size:12px;">${s.nome}</strong><br><span style="color:var(--muted);font-size:11px;">${fmtDT(s.data)}</span> <span class="badge ${s.manual?'badge-ok':'badge-noref'}" style="font-size:9px;">${s.manual?'Manual':'Auto'}</span></td>
      <td style="color:var(--muted)">${(d.estoques||[]).length}</td>
      <td style="color:var(--muted)">${(d.materiais||[]).length}</td>
      <td style="color:var(--muted)">${(d.itens||[]).length}</td>
      <td style="color:var(--muted)">${kb} KB</td>
      <td style="display:flex;gap:4px;">
        <button class="btn btn-secondary" style="padding:3px 8px;font-size:11px;" onclick="exportarSnapshot('${s.id}')">Baixar</button>
        <button class="btn btn-primary" style="padding:3px 8px;font-size:11px;" onclick="restaurarSnapshot('${s.id}')">Restaurar</button>
        <button class="btn btn-danger" style="padding:3px 8px;font-size:11px;" onclick="deletarSnapshot('${s.id}')">✕</button>
      </td>
    </tr>`;
  });
}
function atualizarPreviewBackup(){
  const el=document.getElementById('backup-preview'); if(!el)return;
  const total=db.itens.reduce((s,i)=>s+i.qtd,0);
  const kb=(new Blob([JSON.stringify(db)]).size/1024).toFixed(1);
  el.innerHTML=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center;">
    <div><div style="font-size:20px;font-weight:800;font-family:'Syne',sans-serif;color:var(--accent)">${db.estoques.length}</div><div style="color:var(--muted);font-size:11px;">Estoques</div></div>
    <div><div style="font-size:20px;font-weight:800;font-family:'Syne',sans-serif;color:#5599ff">${db.materiais.length}</div><div style="color:var(--muted);font-size:11px;">Materiais</div></div>
    <div><div style="font-size:20px;font-weight:800;font-family:'Syne',sans-serif;color:var(--text)">${total}</div><div style="color:var(--muted);font-size:11px;">Unidades</div></div>
  </div><div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);color:var(--muted);font-size:11px;text-align:center;">${db.entradas.length} entradas · ${db.saidas.length} saídas · ${db.requisicoes.length} requisições · ${kb} KB</div>`;
}
function exportarBackup(){
  const nome=(document.getElementById('backup-nome').value.trim()||'stockflow_backup');
  const payload={_meta:{versao:'2.0',app:'StockFlow',exportado:new Date().toISOString()},dados:db};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`${nome}_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
  criarSnapshot(false); toast('Backup exportado!');
}
function exportarSnapshot(id){const s=loadSnapshots().find(x=>x.id===id);if(!s)return;const blob=new Blob([JSON.stringify({_meta:{versao:'2.0',app:'StockFlow',exportado:s.data},dados:s.dados},null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`stockflow_snap_${s.data.slice(0,10)}.json`;a.click();URL.revokeObjectURL(url);}
async function restaurarSnapshot(id){const s=loadSnapshots().find(x=>x.id===id);if(!s)return;if(!confirm(`Restaurar "${s.nome}"? Os dados atuais serão substituídos.`))return;
  logAudit('backup', `Snapshot restaurado: ${s.nome}`, `Data: ${fmtDT(s.data)}`);db=JSON.parse(JSON.stringify(s.dados));if(!db.transferencias)db.transferencias=[];if(!db.requisicoes)db.requisicoes=[];if(!db.notificacoes)db.notificacoes=[];renderDash();toast('Restaurando...');try{await saveDB();toast('Restaurado!');}catch(e){toast('Erro ao restaurar.','error');}}
function deletarSnapshot(id){if(!confirm('Remover snapshot?'))return;saveSnapshots(loadSnapshots().filter(s=>s.id!==id));renderSnapshots();toast('Removido.');}
function limparSnapshots(){if(!confirm('Remover TODOS os snapshots?'))return;localStorage.removeItem(SNAP_KEY);renderSnapshots();toast('Limpos.');}
function dragOver(e){e.preventDefault();document.getElementById('import-dropzone').style.borderColor='var(--accent)';}
function dragLeave(){document.getElementById('import-dropzone').style.borderColor='var(--border)';}
function dropFile(e){e.preventDefault();dragLeave();const file=e.dataTransfer.files[0];if(!file||!file.name.endsWith('.json')){toast('Arquivo .json inválido.','error');return;}lerArquivo(file);}
function importarBackup(input){const file=input.files[0];if(!file)return;lerArquivo(file);}
function lerArquivo(file){const reader=new FileReader();reader.onload=e=>{try{const raw=JSON.parse(e.target.result);const dados=raw._meta&&raw.dados?raw.dados:raw;if(!dados.estoques||!dados.materiais)throw new Error('inválido');pendingImport=dados;const kb=(new Blob([JSON.stringify(dados)]).size/1024).toFixed(1);const prev=document.getElementById('import-preview');const btn=document.getElementById('btn-confirmar-import');document.getElementById('import-dropzone').style.borderColor='var(--accent)';document.getElementById('import-dropzone').innerHTML=`<div style="color:var(--accent);font-weight:600;font-size:13px;">✓ ${file.name}</div>`;prev.style.display='block';prev.innerHTML=`<div style="font-size:12px;color:var(--muted);">Estoques: ${(dados.estoques||[]).length} · Materiais: ${(dados.materiais||[]).length} · ${kb} KB<br><span style="color:var(--warn);">⚠️ Os dados atuais serão substituídos.</span></div>`;btn.style.display='block';}catch(err){toast('Arquivo inválido.','error');}};reader.readAsText(file);}
async function confirmarImport(){if(!pendingImport)return;if(!confirm('Confirmar restauração?'))return;criarSnapshot(false);db=pendingImport;if(!db.transferencias)db.transferencias=[];if(!db.requisicoes)db.requisicoes=[];if(!db.notificacoes)db.notificacoes=[];pendingImport=null;document.getElementById('import-preview').style.display='none';document.getElementById('btn-confirmar-import').style.display='none';renderDash();toast('Sincronizando...');try{await saveDB();toast('Dados restaurados!');}catch(e){toast('Erro ao sincronizar.','error');}}

// ===========================

// ===========================
// RELATÓRIOS — EXCEL & PDF
// ===========================

function iniciarRelatorios() {
  // Popular select de estoques
  const selEst = document.getElementById('rel-estoque');
  if (!selEst) return;
  selEst.innerHTML = '<option value="">Todos os estoques</option>';
  db.estoques.forEach(e => selEst.innerHTML += `<option value="${e.id}">${e.nome}</option>`);

  // Popular select de categorias
  const selCat = document.getElementById('rel-categoria');
  selCat.innerHTML = '<option value="">Todas as categorias</option>';
  const cats = [...new Set(db.materiais.map(m => m.cat).filter(Boolean))].sort();
  cats.forEach(c => selCat.innerHTML += `<option value="${c}">${c}</option>`);
}

// Constrói os dados filtrados e ordenados para o relatório
function buildRelatorioData() {
  const estoqueId = document.getElementById('rel-estoque').value;
  const categoria = document.getElementById('rel-categoria').value;
  const statusFiltro = document.getElementById('rel-status').value;
  const ordem = document.getElementById('rel-ordem').value;

  let itens = db.itens.filter(item => {
    if (estoqueId && item.estoqueId !== estoqueId) return false;
    if (categoria) {
      const mat = db.materiais.find(m => m.id === item.materialId);
      if (!mat || mat.cat !== categoria) return false;
    }
    return true;
  });

  let rows = itens.map(item => {
    const mat = db.materiais.find(m => m.id === item.materialId);
    const est = db.estoques.find(e => e.id === item.estoqueId);
    const qtd = Number(item.qtd) || 0;
    const min = mat?.min ?? null;
    const max = mat?.max ?? null;
    const st = getStatus(qtd, min, max);
    return {
      material: mat?.nome || '—',
      categoria: mat?.cat || '—',
      unidade: mat?.unidade || '—',
      estoque: est?.nome || '—',
      lote: item.lote || '—',
      qtd,
      min: min !== null ? min : '—',
      max: max !== null ? max : '—',
      validade: item.validade ? fmt(item.validade) : '—',
      status: st.label,
      statusCls: st.cls,
    };
  });

  // Filtro de status
  if (statusFiltro) {
    rows = rows.filter(r => r.statusCls === statusFiltro);
  }

  // Ordenação
  if (ordem === 'nome')      rows.sort((a,b) => a.material.localeCompare(b.material));
  if (ordem === 'qtd-desc')  rows.sort((a,b) => b.qtd - a.qtd);
  if (ordem === 'qtd-asc')   rows.sort((a,b) => a.qtd - b.qtd);
  if (ordem === 'estoque')   rows.sort((a,b) => a.estoque.localeCompare(b.estoque));
  if (ordem === 'status')    rows.sort((a,b) => a.status.localeCompare(b.status));

  return rows;
}

// Retorna quais colunas estão marcadas
function getColunas() {
  const all = [
    { id:'material',  label:'Material',   key:'material' },
    { id:'estoque',   label:'Estoque',    key:'estoque' },
    { id:'lote',      label:'Lote',       key:'lote' },
    { id:'qtd',       label:'Quantidade', key:'qtd' },
    { id:'min',       label:'Mínimo',     key:'min' },
    { id:'max',       label:'Máximo',     key:'max' },
    { id:'categoria', label:'Categoria',  key:'categoria' },
    { id:'unidade',   label:'Unidade',    key:'unidade' },
    { id:'validade',  label:'Validade',   key:'validade' },
    { id:'status',    label:'Status',     key:'status' },
  ];
  return all.filter(c => document.getElementById('rel-col-' + c.id)?.checked);
}

function previewRelatorio() {
  const rows = buildRelatorioData();
  const cols = getColunas();
  const card = document.getElementById('rel-preview-card');
  const tbl  = document.getElementById('rel-preview-table');
  const cnt  = document.getElementById('rel-preview-count');

  cnt.textContent = `${rows.length} iten${rows.length !== 1 ? 's' : ''}`;
  card.style.display = 'block';

  const corStatus = { 'Normal':'var(--accent)', 'Crítico':'var(--danger)', 'Acima do máximo':'var(--accent2)', 'Sem referência':'var(--muted)' };

  tbl.querySelector('thead').innerHTML = `<tr>${cols.map(c => `<th>${c.label}</th>`).join('')}</tr>`;

  if (!rows.length) {
    tbl.querySelector('tbody').innerHTML = `<tr><td colspan="${cols.length}" style="text-align:center;color:var(--muted);padding:24px;">Nenhum item encontrado.</td></tr>`;
    return;
  }

  tbl.querySelector('tbody').innerHTML = rows.map(r => `<tr>${cols.map(c => {
    if (c.key === 'status') return `<td><span style="color:${corStatus[r.status]||'var(--muted)'};font-weight:600;font-size:12px;">${r.status}</span></td>`;
    if (c.key === 'qtd')    return `<td><strong>${r.qtd.toLocaleString('pt-BR')}</strong></td>`;
    return `<td>${r[c.key]}</td>`;
  }).join('')}</tr>`).join('');

  card.scrollIntoView({ behavior:'smooth', block:'start' });
}

async function gerarRelatorioExcel() {
  if (typeof XLSX === 'undefined') { toast('Biblioteca Excel não carregada. Tente recarregar a página.','error'); return; }

  const rows = buildRelatorioData();
  if (!rows.length) { toast('Nenhum item para exportar.','error'); return; }
  const cols = getColunas();

  const wsData = [];

  // Cabeçalho de info
  wsData.push(['StockFlow — Relatório de Estoque']);
  wsData.push([`Gerado em: ${new Date().toLocaleString('pt-BR')}`]);
  wsData.push([`Total de itens: ${rows.length}`]);
  wsData.push([]); // linha em branco

  // Header das colunas
  wsData.push(cols.map(c => c.label));

  // Dados
  rows.forEach(r => wsData.push(cols.map(c => {
    if (c.key === 'qtd') return Number(r.qtd);
    if (c.key === 'min') return r.min === '—' ? '' : Number(r.min);
    if (c.key === 'max') return r.max === '—' ? '' : Number(r.max);
    return r[c.key];
  })));

  // Linha de totais se coluna qtd incluída
  const qtdColIdx = cols.findIndex(c => c.key === 'qtd');
  if (qtdColIdx >= 0) {
    const totalQtd = rows.reduce((s,r) => s + r.qtd, 0);
    const totalRow = cols.map((c, i) => {
      if (i === 0) return 'TOTAL';
      if (c.key === 'qtd') return totalQtd;
      return '';
    });
    wsData.push([]);
    wsData.push(totalRow);
  }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);

  // Larguras das colunas
  ws['!cols'] = cols.map(c => ({
    wch: c.key === 'material' ? 35 : c.key === 'estoque' ? 25 : c.key === 'lote' ? 20 : 14
  }));

  // Estilo do título (linha 1) — merge
  ws['!merges'] = [{ s:{r:0,c:0}, e:{r:0,c:Math.max(cols.length-1,0)} }];

  XLSX.utils.book_append_sheet(wb, ws, 'Estoque');

  // Aba de resumo por material
  const matTotals = {};
  rows.forEach(r => {
    if (!matTotals[r.material]) matTotals[r.material] = { material: r.material, categoria: r.categoria, unidade: r.unidade, qtdTotal: 0, lotes: 0 };
    matTotals[r.material].qtdTotal += r.qtd;
    matTotals[r.material].lotes++;
  });
  const resumoData = [['Material','Categoria','Unidade','Qtd Total','Nº Lotes']];
  Object.values(matTotals).sort((a,b) => a.material.localeCompare(b.material))
    .forEach(m => resumoData.push([m.material, m.categoria, m.unidade, m.qtdTotal, m.lotes]));

  const wsResumo = XLSX.utils.aoa_to_sheet(resumoData);
  wsResumo['!cols'] = [{wch:35},{wch:20},{wch:12},{wch:14},{wch:10}];
  XLSX.utils.book_append_sheet(wb, wsResumo, 'Resumo por Material');

  const nomearq = `stockflow_estoque_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.writeFile(wb, nomearq);
  toast(`Excel gerado: ${nomearq}`);
}

async function gerarRelatorioPDF() {
  if (typeof window.jspdf === 'undefined') { toast('Biblioteca PDF não carregada. Tente recarregar a página.','error'); return; }

  const rows = buildRelatorioData();
  if (!rows.length) { toast('Nenhum item para exportar.','error'); return; }
  const cols = getColunas();

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

  // Cores do tema
  const verde  = [0, 229, 160];
  const escuro = [17, 19, 24];
  const cinza  = [107, 114, 128];

  // Header
  doc.setFillColor(...escuro);
  doc.rect(0, 0, 297, 30, 'F');
  doc.setTextColor(...verde);
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(18);
  doc.text('StockFlow', 14, 12);
  doc.setTextColor(255,255,255);
  doc.setFontSize(11);
  doc.text('Relatório de Estoque', 14, 20);
  doc.setFontSize(8);
  doc.setTextColor(...cinza);
  doc.text(`Gerado em ${new Date().toLocaleString('pt-BR')}  ·  ${rows.length} iten${rows.length!==1?'s':''}`, 14, 27);

  // Estatísticas rápidas
  const totalQtd = rows.reduce((s,r) => s + r.qtd, 0);
  const criticos = rows.filter(r => r.statusCls === 'badge-critical').length;
  const normais  = rows.filter(r => r.statusCls === 'badge-ok').length;

  doc.setTextColor(255,255,255);
  doc.setFontSize(9);
  doc.text(`Total em estoque: ${totalQtd.toLocaleString('pt-BR')}`, 200, 12);
  doc.text(`Normais: ${normais}  ·  Críticos: ${criticos}`, 200, 19);

  // Tabela
  const corStatus = {
    'Normal': [0, 229, 160],
    'Crítico': [255, 59, 92],
    'Acima do máximo': [85, 153, 255],
    'Sem referência': [107, 114, 128],
  };

  const head = [cols.map(c => c.label.toUpperCase())];
  const body = rows.map(r => cols.map(c => {
    if (c.key === 'qtd') return r.qtd.toLocaleString('pt-BR');
    return String(r[c.key] ?? '—');
  }));

  doc.autoTable({
    startY: 35,
    head,
    body,
    styles: {
      font: 'helvetica',
      fontSize: 8,
      cellPadding: 3,
      textColor: [232, 234, 240],
      fillColor: [26, 29, 36],
      lineColor: [37, 40, 48],
      lineWidth: 0.3,
    },
    headStyles: {
      fillColor: [0, 102, 255],
      textColor: [255,255,255],
      fontStyle: 'bold',
      fontSize: 8,
    },
    alternateRowStyles: { fillColor: [17, 19, 24] },
    columnStyles: cols.reduce((acc, c, i) => {
      if (c.key === 'material') acc[i] = { cellWidth: 45 };
      if (c.key === 'qtd')     acc[i] = { halign: 'right' };
      if (c.key === 'status')  acc[i] = { cellWidth: 24 };
      return acc;
    }, {}),
    didDrawCell: (data) => {
      const stColIdx = cols.findIndex(c => c.key === 'status');
      if (data.column.index === stColIdx && data.section === 'body') {
        const statusVal = rows[data.row.index]?.status;
        const cor = corStatus[statusVal];
        if (cor) {
          doc.setTextColor(...cor);
          doc.setFontSize(7);
          doc.setFont('helvetica','bold');
          doc.text(statusVal, data.cell.x + 2, data.cell.y + data.cell.height / 2 + 1);
          // Impede que o autoTable escreva o texto padrão
          data.cell.text = [];
        }
      }
    },
    margin: { left: 14, right: 14 },
  });

  // Footer em cada página
  const pgCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pgCount; i++) {
    doc.setPage(i);
    doc.setFontSize(7);
    doc.setTextColor(...cinza);
    doc.text(`Página ${i} de ${pgCount}  ·  StockFlow`, 14, doc.internal.pageSize.height - 6);
  }

  const nomearq = `stockflow_estoque_${new Date().toISOString().slice(0,10)}.pdf`;
  doc.save(nomearq);
  toast(`PDF gerado: ${nomearq}`);
}

// INIT — Firebase cuida da sessão via onAuthStateChanged
document.getElementById('app').classList.remove('logged');
document.getElementById('auth-screen').style.display = 'flex';

// ══════════════════════════════════════════════════════
//  SEARCHABLE SELECT  — StockFlow
//  Renderiza um input+dropdown em cima de um <select> hidden.
//  O <select> original continua sendo a fonte de verdade
//  para todo o código existente (.value, onchange, etc.)
// ══════════════════════════════════════════════════════
(function () {

  // Cada campo: { selectId, wrapperId, placeholder }
  const SF_FIELDS = [
    { sel: 'ent-material',  wrap: 'sf-ent-material-wrap',  ph: 'Digite para buscar material...' },
    { sel: 'sai-item',      wrap: 'sf-sai-item-wrap',      ph: 'Digite para buscar item...'     },
    { sel: 'req-material',  wrap: 'sf-req-material-wrap',  ph: 'Digite para buscar material...' },
    { sel: 'req-lote',      wrap: 'sf-req-lote-wrap',      ph: 'Digite para buscar lote...'     },
    { sel: 'trf-item',      wrap: 'sf-trf-item-wrap',      ph: 'Digite para buscar item...'     },
  ];

  // Cria o widget de busca para um campo
  function buildWidget(cfg) {
    const wrapEl = document.getElementById(cfg.wrap);
    if (!wrapEl) return;

    wrapEl.innerHTML = `
      <div class="sf-wrap" id="sfw-${cfg.sel}">
        <input type="text" class="sf-input" id="sfi-${cfg.sel}"
          placeholder="${cfg.ph}" autocomplete="off"
          spellcheck="false">
        <span class="sf-arrow">▼</span>
        <div class="sf-dropdown" id="sfd-${cfg.sel}"></div>
      </div>`;

    const input = document.getElementById('sfi-' + cfg.sel);
    const drop  = document.getElementById('sfd-' + cfg.sel);
    const sel   = document.getElementById(cfg.sel);

    // Atualiza dropdown com base no texto digitado
    function renderDrop() {
      const q = input.value.trim().toLowerCase();
      const opts = Array.from(sel.options);
      const filtered = q
        ? opts.filter(o => o.text.toLowerCase().includes(q) && o.value !== '')
        : opts.filter(o => o.value !== '');

      if (!filtered.length) {
        drop.innerHTML = '<div class="sf-opt sf-empty">Nenhum resultado encontrado</div>';
      } else {
        drop.innerHTML = filtered.map(o =>
          `<div class="sf-opt" data-val="${o.value}">${o.text}</div>`
        ).join('');
        drop.querySelectorAll('.sf-opt').forEach(el => {
          el.addEventListener('mousedown', e => {
            e.preventDefault();
            selectOption(o => o.value === el.dataset.val);
          });
        });
      }
    }

    // Seleciona uma opção no select hidden e atualiza o input
    function selectOption(predicate) {
      const opt = Array.from(sel.options).find(predicate);
      if (!opt) return;
      sel.value = opt.value;
      input.value = opt.value ? opt.text : '';
      drop.classList.remove('open');
      // Dispara onchange no select para que o código existente reaja
      sel.dispatchEvent(new Event('change'));
    }

    // Sincroniza o input com o valor atual do select
    function syncFromSelect() {
      const cur = sel.options[sel.selectedIndex];
      input.value = (cur && cur.value) ? cur.text : '';
    }

    // Eventos do input
    input.addEventListener('input', () => {
      renderDrop();
      drop.classList.add('open');
    });
    input.addEventListener('focus', () => {
      renderDrop();
      drop.classList.add('open');
    });
    input.addEventListener('blur', () => {
      setTimeout(() => {
        drop.classList.remove('open');
        syncFromSelect(); // restaura label se nada foi selecionado
      }, 180);
    });

    // Quando o select muda por código externo, sincroniza o input
    sel.addEventListener('change', syncFromSelect);

    // Observa quando options mudam (MutationObserver)
    const mo = new MutationObserver(() => {
      syncFromSelect();
    });
    mo.observe(sel, { childList: true, subtree: true });

    return { input, drop, sel, syncFromSelect, renderDrop };
  }

  // Inicia todos os widgets assim que o DOM estiver pronto
  function initAll() {
    SF_FIELDS.forEach(cfg => buildWidget(cfg));
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAll);
  } else {
    initAll();
  }

  // Fecha dropdowns ao clicar fora
  document.addEventListener('click', e => {
    if (!e.target.closest('.sf-wrap')) {
      document.querySelectorAll('.sf-dropdown.open')
        .forEach(d => d.classList.remove('open'));
    }
  });

})();


// ══════════════════════════════════════════════════════
//  MOBILE DATA CARDS — render cards alongside tables
// ══════════════════════════════════════════════════════

// Utilitário: patch não-destrutivo de funções existentes
function _after(name, fn) {
  const orig = window[name];
  window[name] = function (...a) {
    const r = typeof orig === 'function' ? orig.apply(this, a) : undefined;
    fn(...a);
    return r;
  };
}
function _afterAsync(name, fn) {
  const orig = window[name];
  window[name] = async function (...a) {
    const r = typeof orig === 'function' ? await orig.apply(this, a) : undefined;
    await fn(...a);
    return r;
  };
}

function _cards(id) {
  return document.getElementById(id);
}

// ── ESTOQUES ──
function _estoqueCards() {
  const el = _cards('estoques-cards'); if (!el) return;
  el.innerHTML = db.estoques.map(e => `
    <div class="data-card">
      <div class="data-card-header">
        <div class="data-card-title">${e.nome}${e.principal ? ' <span class="badge badge-ok" style="font-size:10px;">Principal</span>' : ''}</div>
      </div>
      <div class="data-card-body">
        ${e.desc ? e.desc + '<br>' : ''}
        ${e.local ? '📍 ' + e.local : '<span style="opacity:.5">Sem localização</span>'}
      </div>
      <div class="data-card-actions">
        <button class="btn btn-secondary" onclick="togglePrincipal('${e.id}')">⭐ Principal</button>
        <button class="btn btn-danger" onclick="delEstoque('${e.id}')">✕ Remover</button>
      </div>
    </div>`).join('');
}
_after('renderEstoques', _estoqueCards);

// ── MATERIAIS ──
function _materialCards() {
  const el = _cards('materiais-cards'); if (!el) return;
  el.innerHTML = db.materiais.map(m => `
    <div class="data-card">
      <div class="data-card-header">
        <div class="data-card-title">${m.nome}</div>
        ${m.cat ? `<span class="badge badge-noref" style="font-size:10px;">${m.cat}</span>` : ''}
      </div>
      <div class="data-card-body">
        Unidade: <strong>${m.unidade || '—'}</strong> &nbsp;·&nbsp;
        Mín: <strong>${m.min !== null ? m.min : '—'}</strong> &nbsp;·&nbsp;
        Máx: <strong>${m.max !== null ? m.max : '—'}</strong>
        ${m.diasChegada != null ? `<br>Lead time: <strong>${m.diasChegada}d</strong>` : ''}
      </div>
      <div class="data-card-actions">
        <button class="btn btn-secondary" style="flex:2" onclick="abrirEditarMaterial('${m.id}')">✏️ Editar</button>
        <button class="btn btn-secondary" onclick="copiarMaterial('${m.id}')">⎘</button>
        <button class="btn btn-danger" onclick="delMaterial('${m.id}')">✕</button>
      </div>
    </div>`).join('');
}
_after('renderMateriais', _materialCards);

// ── ENTRADAS ──
function _entradaCards() {
  const el = _cards('entradas-cards'); if (!el) return;
  el.innerHTML = db.entradas.slice(0, 20).map(e => `
    <div class="data-card">
      <div class="data-card-header">
        <div class="data-card-title">${e.materialNome}</div>
        <strong style="color:var(--accent);font-size:16px;">+${e.qtd}</strong>
      </div>
      <div class="data-card-body">
        📦 ${e.estoqueNome}<br>
        Lote: <span style="color:var(--accent);font-weight:600;">${e.lote}</span>
        ${e.validade ? ` &nbsp;·&nbsp; Val: <strong>${fmt(e.validade)}</strong>` : ''}
        <br><span style="font-size:11px;color:var(--muted)">${fmt(e.data)}</span>
      </div>
      <div class="data-card-actions">
        <button class="btn btn-secondary" style="flex:1" onclick="abrirEditarEntrada('${e.id}')">✏️ Editar</button>
      </div>
    </div>`).join('');
}
_after('renderEntradas', _entradaCards);

// ── SAÍDAS ──
function _saidaCards() {
  const el = _cards('saidas-cards'); if (!el) return;
  el.innerHTML = db.saidas.slice(0, 20).map(s => `
    <div class="data-card">
      <div class="data-card-header">
        <div class="data-card-title">${s.materialNome}</div>
        <strong style="color:var(--danger);font-size:16px;">-${s.qtd}</strong>
      </div>
      <div class="data-card-body">
        📦 ${s.estoqueNome}<br>
        Lote: <span style="color:var(--danger);font-weight:600;">${s.lote}</span>
        ${s.motivo ? ` &nbsp;·&nbsp; ${s.motivo}` : ''}
        <br><span style="font-size:11px;color:var(--muted)">${fmt(s.data)}</span>
      </div>
    </div>`).join('');
}
_after('renderSaidas', _saidaCards);

// ── ANÁLISE (filtrada) ──
function _analiseCards() {
  const el = _cards('analise-cards'); if (!el) return;
  if (!window.analiseItensCache) { el.innerHTML = ''; return; }
  const busca = (document.getElementById('filtro-nome')?.value || '').toLowerCase();
  const cat   = document.getElementById('filtro-cat')?.value || '';
  const status= document.getElementById('filtro-status')?.value || '';
  const hoje  = new Date(); hoje.setHours(0,0,0,0);
  const res   = analiseItensCache.filter(r => {
    if (busca && !r.nome.toLowerCase().includes(busca) && !r.item.lote.toLowerCase().includes(busca)) return false;
    if (cat && r.cat !== cat) return false;
    if (status && r.st.cls !== status) return false;
    return true;
  });
  el.innerHTML = res.map(({ item, mat, nome, min, max, st, vencido, dias }) => {
    let vStr = item.validade ? fmt(item.validade) : '—', vStyle = '';
    if (vencido) { vStyle = 'color:var(--danger);font-weight:600'; vStr += ' ⚠️ VENCIDO'; }
    else if (dias != null && dias <= 30) { vStyle = 'color:var(--warn);font-weight:600'; vStr += ` (${dias}d)`; }
    return `<div class="data-card">
      <div class="data-card-header">
        <div>
          <div class="data-card-title">${nome}</div>
          ${mat?.cat ? `<span style="font-size:11px;color:var(--muted)">${mat.cat}</span>` : ''}
        </div>
        <span class="badge ${st.cls}">${st.label}</span>
      </div>
      <div class="data-card-body">
        Lote: <strong>${item.lote}</strong><br>
        Qtd: <strong style="font-size:15px">${item.qtd}</strong>${mat?.unidade ? ' ' + mat.unidade : ''}<br>
        ${min != null || max != null ? `Mín: <strong>${min ?? '—'}</strong> · Máx: <strong>${max ?? '—'}</strong><br>` : ''}
        <span style="${vStyle}">Validade: ${vStr}</span>
      </div>
      <div class="data-card-actions">
        <button class="btn btn-secondary" style="flex:1" onclick="abrirEditarItem('${item.id}')">✏️ Editar</button>
      </div>
    </div>`;
  }).join('');
}
_after('aplicarFiltros', _analiseCards);

// ── COMPRAS ──
function _comprasCards() {
  const el = _cards('compras-cards'); if (!el) return;
  // Lê as linhas já renderizadas na tabela e cria cards equivalentes
  const rows = document.querySelectorAll('#compras-tbody tr');
  el.innerHTML = '';
  rows.forEach(row => {
    const tds = row.querySelectorAll('td');
    if (!tds.length) return;
    const nome    = tds[0].innerHTML;
    const qtd     = tds[1].innerHTML;
    const min     = tds[2].textContent;
    const lead    = tds[3].textContent;
    const consumo = tds[4].innerHTML;
    const dias    = tds[5].innerHTML;
    const pedir   = tds[6].innerHTML;
    const badge   = tds[7].innerHTML;
    el.innerHTML += `<div class="data-card">
      <div class="data-card-header">
        <div class="data-card-title">${nome}</div>
        ${badge}
      </div>
      <div class="data-card-body">
        Qtd: <strong>${qtd}</strong> &nbsp;·&nbsp; Mín: <strong>${min}</strong><br>
        Lead time: <strong>${lead}</strong> &nbsp;·&nbsp; Consumo: ${consumo}<br>
        Dias restantes: <strong>${dias}</strong><br>
        Pedir até: <strong>${pedir}</strong>
      </div>
    </div>`;
  });
}
_after('renderCompras', _comprasCards);

// ── TRANSFERÊNCIAS ──
function _transfCards() {
  const el = _cards('transf-cards'); if (!el) return;
  if (!db.transferencias?.length) { el.innerHTML = ''; return; }
  el.innerHTML = db.transferencias.slice(0, 30).map(t => {
    const mesmoLote = t.loteOrigem === t.loteDestino;
    return `<div class="data-card">
      <div class="data-card-header">
        <div>
          <div class="data-card-title">${t.materialNome}</div>
          <span style="font-size:11px;color:var(--muted)">${mesmoLote ? t.loteOrigem : t.loteOrigem + ' → ' + t.loteDestino}</span>
        </div>
        <strong style="color:var(--accent);font-size:15px">⇄ ${t.qtd}</strong>
      </div>
      <div class="data-card-body">
        De: <strong>${t.estOrigNome}</strong> → <strong style="color:var(--accent)">${t.estDestNome}</strong><br>
        ${t.resp ? `Resp: ${t.resp} &nbsp;·&nbsp; ` : ''}<span style="font-size:11px">${fmt(t.data)}</span>
      </div>
    </div>`;
  }).join('');
}
_after('renderTransferencias', _transfCards);

// ── SNAPSHOTS ──
function _snapshotCards() {
  const el = _cards('snapshots-cards'); if (!el) return;
  const snaps = loadSnapshots();
  el.innerHTML = snaps.map(s => {
    const d  = s.dados;
    const kb = (new Blob([JSON.stringify(d)]).size / 1024).toFixed(1);
    return `<div class="data-card">
      <div class="data-card-header">
        <div>
          <div class="data-card-title" style="font-size:13px">${s.nome}</div>
          <span style="font-size:11px;color:var(--muted)">${fmtDT(s.data)}</span>
          <span class="badge ${s.manual ? 'badge-ok' : 'badge-noref'}" style="font-size:9px;margin-left:4px">${s.manual ? 'Manual' : 'Auto'}</span>
        </div>
      </div>
      <div class="data-card-body">
        Estoques: <strong>${(d.estoques||[]).length}</strong> &nbsp;·&nbsp;
        Materiais: <strong>${(d.materiais||[]).length}</strong> &nbsp;·&nbsp;
        Itens: <strong>${(d.itens||[]).length}</strong> &nbsp;·&nbsp;
        <strong>${kb} KB</strong>
      </div>
      <div class="data-card-actions">
        <button class="btn btn-secondary" onclick="exportarSnapshot('${s.id}')">⬇ Baixar</button>
        <button class="btn btn-primary"   onclick="restaurarSnapshot('${s.id}')">↺ Restaurar</button>
        <button class="btn btn-danger"    onclick="deletarSnapshot('${s.id}')">✕</button>
      </div>
    </div>`;
  }).join('');
}
_after('renderSnapshots', _snapshotCards);

// ── USUÁRIOS (async) ──
function _usuarioCards() {
  const el = _cards('usuarios-cards'); if (!el) return;
  const tb = document.getElementById('usuarios-tbody');
  if (!tb) return;
  el.innerHTML = '';
  tb.querySelectorAll('tr').forEach(row => {
    const tds = row.querySelectorAll('td');
    if (!tds.length) return;
    const nome    = tds[0]?.querySelector('strong')?.textContent || '—';
    const email   = tds[1]?.textContent || '—';
    const badgeEl = tds[2]?.querySelector('.badge');
    const data    = tds[3]?.textContent || '—';
    const acaoHtml= tds[4]?.innerHTML || '';
    el.innerHTML += `<div class="data-card">
      <div class="data-card-header">
        <div>
          <div class="data-card-title">${nome}</div>
          <span style="font-size:11px;color:var(--muted)">${email}</span>
        </div>
        ${badgeEl ? badgeEl.outerHTML : ''}
      </div>
      <div class="data-card-body">Cadastrado: ${data}</div>
      ${acaoHtml ? `<div class="data-card-actions">${acaoHtml}</div>` : ''}
    </div>`;
  });
}
_afterAsync('renderUsuarios', async () => _usuarioCards());

// ══════════════════════════════════════════════════════
//  AUDITORIA — Motor de logs automáticos
// ══════════════════════════════════════════════════════

// Configuração de cores/labels por tipo
const AUDIT_META = {
  login:        { cor:'var(--accent)',  bg:'rgba(0,229,160,.12)',   emoji:'🔑', label:'Login'         },
  logout:       { cor:'var(--muted)',   bg:'rgba(107,114,128,.12)', emoji:'🚪', label:'Logout'        },
  entrada:      { cor:'#5599ff',        bg:'rgba(0,102,255,.12)',   emoji:'📥', label:'Entrada'       },
  saida:        { cor:'var(--danger)',  bg:'rgba(255,59,92,.12)',   emoji:'📤', label:'Saída'         },
  transferencia:{ cor:'var(--warn)',    bg:'rgba(255,149,0,.12)',   emoji:'🔄', label:'Transferência' },
  requisicao:   { cor:'var(--accent)',  bg:'rgba(0,229,160,.12)',   emoji:'📋', label:'Requisição'    },
  atendimento:  { cor:'#5599ff',        bg:'rgba(0,102,255,.12)',   emoji:'✅', label:'Atendimento'   },
  material:     { cor:'var(--warn)',    bg:'rgba(255,149,0,.12)',   emoji:'📦', label:'Material'      },
  estoque:      { cor:'var(--text)',    bg:'rgba(232,234,240,.08)', emoji:'🏭', label:'Estoque'       },
  usuario:      { cor:'var(--accent)',  bg:'rgba(0,229,160,.12)',   emoji:'👤', label:'Usuário'       },
  backup:       { cor:'var(--muted)',   bg:'rgba(107,114,128,.12)', emoji:'💾', label:'Backup'        },
  sistema:      { cor:'var(--muted)',   bg:'rgba(107,114,128,.12)', emoji:'⚙️', label:'Sistema'      },
};

// Armazena logs em memória (localStorage para persistência local)
const AUDIT_KEY = 'sf_audit_logs';
const AUDIT_MAX = 2000; // máximo de logs em memória

function _getAuditLogs() {
  try { return JSON.parse(localStorage.getItem(AUDIT_KEY) || '[]'); }
  catch(e) { return []; }
}
function _saveAuditLogs(logs) {
  try { localStorage.setItem(AUDIT_KEY, JSON.stringify(logs.slice(0, AUDIT_MAX))); }
  catch(e) { /* ignora se localStorage cheio */ }
}

/**
 * Registra um evento de auditoria
 * @param {string} tipo - login|logout|entrada|saida|transferencia|requisicao|atendimento|material|estoque|usuario|backup|sistema
 * @param {string} acao - Descrição curta da ação
 * @param {string} detalhe - Detalhes adicionais
 */
function logAudit(tipo, acao, detalhe='') {
  const log = {
    id:      Date.now() + '_' + Math.random().toString(36).slice(2,7),
    ts:      new Date().toISOString(),
    tipo,
    acao,
    detalhe,
    usuario: currentUser ? currentUser.nome  : 'Sistema',
    email:   currentUser ? currentUser.email : '—',
    role:    currentUser ? currentUser.role  : '—',
  };
  const logs = _getAuditLogs();
  logs.unshift(log);
  _saveAuditLogs(logs);

  // Se a página de auditoria estiver aberta, re-renderiza
  const pg = document.getElementById('page-auditoria');
  if (pg && pg.classList.contains('active')) renderAuditoria();
}

// Estado de paginação
let _audPage = 0;
const _audPerPage = 50;

function _audFilteredLogs() {
  const busca  = (document.getElementById('aud-busca')?.value || '').toLowerCase().trim();
  const tipo   = document.getElementById('aud-tipo')?.value   || '';
  const de     = document.getElementById('aud-de')?.value     || '';
  const ate    = document.getElementById('aud-ate')?.value    || '';

  return _getAuditLogs().filter(l => {
    if (tipo && l.tipo !== tipo) return false;
    if (de) {
      const lDate = l.ts.slice(0,10);
      if (lDate < de) return false;
    }
    if (ate) {
      const lDate = l.ts.slice(0,10);
      if (lDate > ate) return false;
    }
    if (busca) {
      const haystack = `${l.usuario} ${l.email} ${l.acao} ${l.detalhe} ${l.tipo}`.toLowerCase();
      if (!haystack.includes(busca)) return false;
    }
    return true;
  });
}

function renderAuditoria() {
  const all    = _audFilteredLogs();
  const total  = all.length;
  const start  = _audPage * _audPerPage;
  const page   = all.slice(start, start + _audPerPage);

  // Contador
  const ctr = document.getElementById('aud-contador');
  const totalAll = _getAuditLogs().length;
  if (total < totalAll) {
    ctr.style.display = 'block';
    ctr.innerHTML = `Mostrando <strong style="color:var(--text)">${total}</strong> de <strong>${totalAll}</strong> registros`;
  } else {
    ctr.style.display = 'block';
    ctr.innerHTML = `<strong>${totalAll}</strong> registros no total`;
  }

  // Empty state
  const empty = document.getElementById('aud-empty');
  empty.style.display = page.length ? 'none' : 'block';

  // Tabela
  const tb = document.getElementById('aud-tbody');
  if (tb) {
    tb.innerHTML = page.map(l => {
      const m = AUDIT_META[l.tipo] || AUDIT_META.sistema;
      return `<tr>
        <td style="font-size:12px;color:var(--muted);white-space:nowrap">${fmtDT(l.ts)}</td>
        <td>
          <strong style="font-size:13px">${escHtml(l.usuario)}</strong>
          <br><span style="font-size:11px;color:var(--muted)">${escHtml(l.email)}</span>
        </td>
        <td><span style="padding:3px 10px;border-radius:99px;font-size:11px;font-weight:700;background:${m.bg};color:${m.cor};white-space:nowrap">${m.emoji} ${m.label}</span></td>
        <td style="font-size:13px"><strong>${escHtml(l.acao)}</strong></td>
        <td style="font-size:12px;color:var(--muted)">${escHtml(l.detalhe)}</td>
      </tr>`;
    }).join('');
  }

  // Mobile cards
  const cards = document.getElementById('aud-cards');
  if (cards) {
    cards.innerHTML = page.map(l => {
      const m = AUDIT_META[l.tipo] || AUDIT_META.sistema;
      return `<div class="data-card">
        <div class="data-card-header">
          <div>
            <div class="data-card-title">${escHtml(l.acao)}</div>
            <span style="font-size:11px;color:var(--muted)">${escHtml(l.usuario)} · ${fmtDT(l.ts)}</span>
          </div>
          <span style="padding:3px 8px;border-radius:99px;font-size:10px;font-weight:700;background:${m.bg};color:${m.cor};white-space:nowrap">${m.emoji} ${m.label}</span>
        </div>
        ${l.detalhe ? `<div class="data-card-body">${escHtml(l.detalhe)}</div>` : ''}
      </div>`;
    }).join('');
  }

  // Paginação
  const totalPages = Math.ceil(total / _audPerPage);
  const pag = document.getElementById('aud-paginacao');
  if (pag) {
    if (totalPages <= 1) { pag.style.display = 'none'; }
    else {
      pag.style.display = 'flex';
      pag.innerHTML = `
        <button class="btn btn-secondary" style="padding:6px 14px;font-size:12px" onclick="_audChangePage(${_audPage-1})" ${_audPage===0?'disabled':''}>← Anterior</button>
        <span style="color:var(--muted);font-size:13px">Página <strong style="color:var(--text)">${_audPage+1}</strong> de ${totalPages}</span>
        <button class="btn btn-secondary" style="padding:6px 14px;font-size:12px" onclick="_audChangePage(${_audPage+1})" ${_audPage>=totalPages-1?'disabled':''}>Próxima →</button>`;
    }
  }
}

function _audChangePage(p) {
  const all = _audFilteredLogs();
  const totalPages = Math.ceil(all.length / _audPerPage);
  _audPage = Math.max(0, Math.min(p, totalPages - 1));
  renderAuditoria();
  document.getElementById('page-auditoria')?.scrollIntoView({behavior:'smooth'});
}

function limparFiltrosAud() {
  ['aud-busca','aud-tipo','aud-de','aud-ate'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  _audPage = 0;
  renderAuditoria();
}

function escHtml(s) {
  if (!s) return '—';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ── EXPORT PDF ────────────────────────────────────────────────
function exportarAuditoriaPDF() {
  const logs = _audFilteredLogs();
  if (!logs.length) { toast('Nenhum log para exportar.', 'error'); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

  const verde = [0, 229, 160];
  const branco = [232, 234, 240];
  const cinza  = [107, 114, 128];
  const fundo  = [10, 12, 15];

  // Cabeçalho
  doc.setFillColor(...fundo);
  doc.rect(0, 0, 297, 30, 'F');
  doc.setFont('helvetica','bold');
  doc.setFontSize(18);
  doc.setTextColor(...verde);
  doc.text('Stock', 14, 18);
  doc.setTextColor(...branco);
  doc.text('Flow', 14 + doc.getTextWidth('Stock'), 18);
  doc.setFont('helvetica','normal');
  doc.setFontSize(10);
  doc.setTextColor(...cinza);
  doc.text('Relatório de Auditoria', 50, 18);
  doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 200, 18);
  doc.text(`Total de registros: ${logs.length}`, 200, 24);

  // Filtros ativos
  let filtrosAtivos = [];
  const busca = document.getElementById('aud-busca')?.value;
  const tipo  = document.getElementById('aud-tipo')?.value;
  const de    = document.getElementById('aud-de')?.value;
  const ate   = document.getElementById('aud-ate')?.value;
  if (busca) filtrosAtivos.push(`Busca: "${busca}"`);
  if (tipo)  filtrosAtivos.push(`Tipo: ${tipo}`);
  if (de)    filtrosAtivos.push(`De: ${de}`);
  if (ate)   filtrosAtivos.push(`Até: ${ate}`);
  if (filtrosAtivos.length) {
    doc.setFontSize(8);
    doc.setTextColor(...cinza);
    doc.text('Filtros: ' + filtrosAtivos.join(' | '), 14, 26);
  }

  // Tabela
  doc.autoTable({
    startY: 34,
    head: [['Data/Hora', 'Usuário', 'E-mail', 'Tipo', 'Ação', 'Detalhe']],
    body: logs.map(l => [
      fmtDT(l.ts),
      l.usuario || '—',
      l.email   || '—',
      (AUDIT_META[l.tipo]?.label || l.tipo),
      l.acao    || '—',
      l.detalhe || '—',
    ]),
    styles: {
      fontSize: 7,
      cellPadding: 3,
      textColor: [200, 202, 208],
      lineColor: [37, 40, 48],
      lineWidth: 0.1,
      fillColor: [17, 19, 24],
    },
    headStyles: {
      fillColor: [26, 29, 36],
      textColor: [107, 114, 128],
      fontStyle: 'bold',
      fontSize: 7,
    },
    alternateRowStyles: { fillColor: [22, 25, 32] },
    columnStyles: {
      0: { cellWidth: 32 },
      1: { cellWidth: 28 },
      2: { cellWidth: 42 },
      3: { cellWidth: 24 },
      4: { cellWidth: 60 },
      5: { cellWidth: 'auto' },
    },
    margin: { left: 14, right: 14 },
    didDrawPage: (d) => {
      doc.setFontSize(7);
      doc.setTextColor(...cinza);
      const pg = doc.internal.getNumberOfPages();
      doc.text(`Página ${d.pageNumber} · StockFlow Auditoria`, 14, doc.internal.pageSize.height - 5);
    }
  });

  const nome = `auditoria_${new Date().toISOString().slice(0,10)}.pdf`;
  doc.save(nome);
  toast(`PDF exportado: ${nome}`);
}

// Log inicial de sistema quando app é carregado
window.addEventListener('load', () => {
  setTimeout(() => {
    if (currentUser) logAudit('sistema', 'Sessão ativa', `Usuário: ${currentUser.nome}`);
  }, 3000);
});

</script>
</body>
</html>